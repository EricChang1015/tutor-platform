<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å®¶æ•™ç³»çµ± Demo</title>
  <style>
    /* Light theme */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --muted:#6b7280; --text:#111827;
      --brand:#2563eb; --brand-2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ok:#10b981; --border:#e5e7eb; --chip:#f3f4f6; --chip-2:#eef2ff;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji",
      "Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border); z-index:10;
    }
    .nav{display:flex; align-items:center; gap:12px; padding:10px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; color:#0b1420}
    .logo-badge{
      width:34px; height:34px; border-radius:8px; display:grid; place-items:center;
      color:#fff; background:linear-gradient(135deg,#22c55e,#16a34a); font-size:18px; font-weight:900;
      box-shadow:0 6px 16px rgba(34,197,94,.35), inset 0 0 10px rgba(255,255,255,.3);
    }
    .spacer{flex:1}
    .tabbar{display:flex; gap:6px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
      color:#374151; cursor:pointer; transition:.2s; font-size:14px;
    }
    .tab.active{background:#e8f5ff; border-color:#cde6ff; color:#0b4ea2}
    .search{display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border);
      padding:6px 10px; border-radius:12px; min-width:220px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:#111827}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#ffffff; color:#111827; cursor:pointer; transition:.15s;
      box-shadow:0 2px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; border-color:transparent; font-weight:700}
    .btn.success{background:linear-gradient(135deg,#34d399,#10b981); color:#fff; border:0; font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3b2700; border:0; font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#fda4a4,#ef4444); color:#fff; border:0; font-weight:700}
    .btn.ghost{background:#f3f4f6}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:13px}
    .btn.icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af; border:1px solid #e0e7ff}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--border); font-size:12px}
    /* æ™‚å€é¸æ“‡å™¨æ¨£å¼ */
    .timezone-selector{
      display:flex; align-items:center; gap:8px; background:#f0f9ff; border:1px solid #bae6fd;
      padding:8px 12px; border-radius:12px; margin:8px 0;
    }
    .timezone-selector select{
      background:white; border:1px solid #cbd5e1; border-radius:8px; padding:4px 8px;
      font-size:13px; color:#374151;
    }
    .timezone-info{
      font-size:12px; color:#0369a1; margin-left:8px;
    }
    .row{display:flex; gap:12px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .subtle{
      background:#f9fafb; border:1px dashed var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .title{font-size:18px; font-weight:800; margin:8px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#e5e7eb,transparent); margin:12px 0}
    /* Avatars */
    .avatar{
      width:54px; height:54px; border-radius:14px; background:linear-gradient(135deg,#e5f9f0,#d1fae5); border:1px solid var(--border);
      display:grid; place-items:center; font-weight:900; color:#065f46; overflow:hidden;
    }
    .avatar.sm{width:36px; height:36px; border-radius:10px; font-size:14px}
    .avatar.round{border-radius:50%}
    .avatar img{width:100%; height:100%; object-fit:cover}

    /* åœ–ç‰‡è£åˆ‡å™¨ */
    .crop-container{
      position:relative; max-width:400px; margin:16px auto;
    }
    .crop-preview{
      width:100px; height:100px; border-radius:50%; overflow:hidden; border:2px solid var(--border);
      margin:16px auto; background:#f3f4f6;
    }
    .crop-preview img{width:100%; height:100%; object-fit:cover}

    /* è¡¨å–®æ¨£å¼ */
    .form-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}
    .form-grid label{display:block; font-weight:600; margin-bottom:4px; color:#374151}
    .form-grid input, .form-grid textarea, .form-grid select{
      width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:8px;
      background:white; font-size:14px;
    }
    .form-grid input:focus, .form-grid textarea:focus, .form-grid select:focus{
      outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,0.1);
    }

    /* æª”æ¡ˆä¸Šå‚³å€åŸŸ */
    .upload-area{
      border:2px dashed var(--border); border-radius:12px; padding:24px; text-align:center;
      background:#f9fafb; cursor:pointer; transition:.2s;
    }
    .upload-area:hover{border-color:var(--brand); background:#f0f9ff}
    .upload-area.dragover{border-color:var(--brand); background:#e0f2fe}

    /* ç›¸ç°¿ç¶²æ ¼ */
    .gallery-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px}
    .gallery-item{
      aspect-ratio:1; border-radius:12px; overflow:hidden; border:1px solid var(--border);
      position:relative; cursor:pointer; transition:.2s;
    }
    .gallery-item:hover{transform:scale(1.02); box-shadow:var(--shadow)}
    .gallery-item img, .gallery-item video{width:100%; height:100%; object-fit:cover}
    .gallery-item .play-btn{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
      background:rgba(0,0,0,0.7); color:white; border-radius:50%; width:40px; height:40px;
      display:grid; place-items:center; font-size:16px;
    }
    /* Layout */
    main{padding:10px}
    section[hidden]{display:none !important}
    /* Teacher cards */
    .teacher-card{display:flex; gap:12px}
    .teacher-card .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    /* Materials */
    .materials{display:grid; grid-template-columns:280px 1fr; gap:14px}
    .tree{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:10px; max-height:60vh; overflow:auto}
    .tree ul{list-style:none; padding-left:12px; margin:0}
    .tree li{margin:6px 0}
    .tree .node{display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; cursor:pointer}
    .tree .node.active{background:#eef2ff; border:1px solid #e0e7ff}
    .node .icon{width:22px; text-align:center}
    .content-pane{min-height:320px}
    .pdf{background:#f9fafb; border-radius:10px; padding:20px; border:1px solid var(--border)}
    /* Schedule */
    .date-strip{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .date-pill{min-width:110px; text-align:center; padding:8px; border-radius:12px; background:#f3f4f6; border:1px solid var(--border); cursor:pointer}
    .date-pill.active{background:#e0f2fe; border-color:#bae6fd}
    .slots{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .slot{padding:10px; border-radius:10px; border:1px solid var(--border); background:#ffffff; text-align:center; cursor:pointer; transition:all 0.2s; font-size:14px}
    .slot:hover:not(.busy){background:#f0f9ff; border-color:#0ea5e9}
    .slot.busy{opacity:.45; text-decoration:line-through; cursor:not-allowed; background:#fef2f2}
    .slot.selected{outline:2px solid var(--brand); background:#e0f2fe}
    /* Calendar */
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{border:1px solid var(--border); background:#ffffff; min-height:80px; border-radius:10px; padding:6px; position:relative}
    .cal-cell .dot{position:absolute; right:8px; bottom:6px; width:8px; height:8px; border-radius:50%}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#6b7280; text-align:center}
    .dot-blue{background:#3b82f6} .dot-orange{background:#f59e0b} .dot-gray{background:#6b7280}
    /* Modal & Toast */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:20; padding:20px; overflow-y:auto}
    .modal{background:var(--surface); border:1px solid var(--border); border-radius:16px; width:min(560px,92vw); max-height:90vh; padding:18px; box-shadow:var(--shadow); overflow-y:auto; margin:auto}
    .toast{position:fixed; right:14px; bottom:14px; background:var(--surface); border:1px solid var(--border); padding:12px 14px; border-radius:12px; z-index:30; box-shadow:var(--shadow); max-width:400px; word-wrap:break-word}
    .toast.error{background:#fef2f2; border-color:#fecaca; color:#dc2626}
    .toast.success{background:#f0fdf4; border-color:#bbf7d0; color:#16a34a}
    .toast.warning{background:#fffbeb; border-color:#fed7aa; color:#d97706}
    /* Forms */
    label{font-size:13px; color:#6b7280}
    input,select,textarea{
      width:100%; background:#ffffff; color:#111827;
      border:1px solid var(--border); border-radius:10px; padding:10px; outline:none
    }
    textarea{min-height:80px; resize:vertical}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid > div{display:flex; flex-direction:column; gap:6px}
    /* Lists & tables */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:10px; background:#ffffff}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th{font-size:12px; text-transform:uppercase; color:#6b7280; background:#f9fafb; border-bottom:1px solid var(--border)}
    th, td{padding:12px; text-align:left}
    tr{border-bottom:1px solid var(--border)}
    tr:hover td{background:#fafafa}
    .hidden{display:none !important}
    /* Responsive */
    @media (max-width: 900px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .materials{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .cards-grid{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr))}
    }
    @media (max-width: 560px){
      .grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .slots{grid-template-columns:1fr; max-height:300px; overflow-y:auto}
      .search{min-width:unset; width:100%}
      .tabbar{width:100%; overflow:auto}
      th:nth-child(3), td:nth-child(3){white-space:nowrap}
      .modal{width:95vw; max-height:85vh; padding:16px}
      .date-strip{flex-wrap:wrap}
      .date-pill{min-width:80px; font-size:12px}
      .cards-grid{grid-template-columns:1fr}
      .teacher-card{flex-direction:column; text-align:center}
      .teacher-card .actions{justify-content:center}
      /* æ”¹å–„æ‰‹æ©Ÿç«¯è¡¨æ ¼é¡¯ç¤º */
      table{font-size:14px}
      th, td{padding:8px 4px}
      .btn.small{padding:4px 8px; font-size:12px}
    }
    .hint{font-size:12px; color:#6b7280}
    .welcome{
      background:linear-gradient(90deg,#16a34a,#15803d); color:#fff; border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .status-chip{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-scheduled{background:#dbeafe; color:#1d4ed8}
    .status-canceled{background:#fee2e2; color:#dc2626}
    .status-completed{background:#dcfce7; color:#16a34a}
    .status-noshow{background:#fef3c7; color:#d97706}
    .status-pending{background:#f3f4f6; color:#6b7280}

    /* Purchase Cards */
    .cards-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px; margin-top:16px}
    .purchase-card{background:white; border-radius:8px; border:1px solid #e5e7eb; overflow:hidden; transition:all 0.2s}
    .purchase-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1); transform:translateY(-2px)}
    .purchase-card.draft{border-left:4px solid #f59e0b}
    .purchase-card.active{border-left:4px solid #10b981}
    .purchase-card.expired{border-left:4px solid #ef4444}
    .purchase-card.consumed{border-left:4px solid #6b7280}
    .card-header{padding:16px 16px 0; display:flex; justify-content:space-between; align-items:flex-start}
    .card-header h3{margin:0; font-size:16px; font-weight:600; color:#111827}
    .card-body{padding:16px}
    .card-info{display:grid; gap:8px}
    .info-item{display:flex; justify-content:space-between; align-items:center}
    .info-item label{font-size:14px; color:#6b7280; font-weight:500}
    .info-item span{font-size:14px; color:#111827; font-weight:600}
    .card-notes{margin-top:12px; padding:8px; background:#f9fafb; border-radius:4px; font-size:12px; color:#6b7280}

    /* Admin æ¨£å¼ */
    .tabs{display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:20px}
    .tab-btn{padding:12px 24px; border:none; background:none; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s}
    .tab-btn:hover{background:#f9fafb}
    .tab-btn.active{border-bottom-color:#3b82f6; color:#3b82f6; font-weight:600}

    .data-table{width:100%; border-collapse:collapse; margin-top:16px}
    .data-table th, .data-table td{padding:12px; text-align:left; border-bottom:1px solid #e5e7eb}
    .data-table th{background:#f9fafb; font-weight:600; color:#374151}
    .data-table tr:hover{background:#f9fafb}

    .badge{display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600}
    .badge.admin{background:#fef3c7; color:#d97706}
    .badge.teacher{background:#dbeafe; color:#1d4ed8}
    .badge.student{background:#dcfce7; color:#16a34a}
    .badge.success{background:#dcfce7; color:#16a34a}
    .badge.danger{background:#fee2e2; color:#dc2626}

    .btn-group{display:flex; gap:4px; flex-wrap:wrap}
    .btn-group .btn{margin:0}

    .avatar-small{width:32px; height:32px; border-radius:50%; object-fit:cover}

    .pagination{display:flex; justify-content:space-between; align-items:center; margin-top:16px; padding:16px 0}
    .pagination-info{color:#6b7280; font-size:14px}
    .pagination-buttons{display:flex; gap:4px}

    .stat-item{text-align:center}
    .stat-number{font-size:24px; font-weight:700; color:#111827}
    .stat-label{font-size:14px; color:#6b7280; margin-top:4px}

    .loading, .error, .empty{text-align:center; padding:40px; color:#6b7280}
    .error{color:#dc2626}
    .card-actions{padding:0 16px 16px; display:flex; gap:8px; justify-content:flex-end}
    .section{margin-bottom:32px}
    .section h2{margin:0 0 16px; font-size:18px; font-weight:700; color:#111827}
    .purchase-card.consumed{border-left:4px solid #6b7280}
    .card-header{padding:16px 16px 0; display:flex; justify-content:space-between; align-items:flex-start}
    .card-header h3{margin:0; font-size:16px; font-weight:600; color:#111827}
    .card-body{padding:16px}
    .card-info{display:grid; gap:8px}
    .info-item{display:flex; justify-content:space-between; align-items:center}
    .info-item label{font-size:14px; color:#6b7280; font-weight:500}
    .info-item span{font-size:14px; color:#111827; font-weight:600}
    .card-notes{margin-top:12px; padding:8px; background:#f9fafb; border-radius:4px; font-size:12px; color:#6b7280}
    .card-actions{padding:0 16px 16px; display:flex; gap:8px; justify-content:flex-end}
    .section{margin-bottom:32px}
    .section h2{margin:0 0 16px; font-size:18px; font-weight:700; color:#111827}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">TG</div>å®¶æ•™ç³»çµ± Demo</div>
      <div class="spacer"></div>
      <div id="searchBar" class="search hidden">
        <span>ğŸ”</span>
        <input id="globalSearch" placeholder="æœå°‹è€å¸«ã€æ“…é•·é ˜åŸŸã€åœ°å€â€¦" />
      </div>
      <div id="tabbar" class="tabbar"></div>
      <div class="spacer"></div>
      <div id="timezone-container" class="timezone-selector hidden">
        <span>ğŸŒ</span>
        <select id="timezone-select" onchange="updateTimezone()">
          <option value="Asia/Taipei">å°åŒ—</option>
          <option value="America/New_York">ç´ç´„</option>
          <option value="America/Los_Angeles">æ´›æ‰ç£¯</option>
          <option value="Europe/London">å€«æ•¦</option>
          <option value="Europe/Paris">å·´é»</option>
          <option value="Asia/Tokyo">æ±äº¬</option>
          <option value="UTC">UTC</option>
        </select>
        <span id="current-time" class="timezone-info"></span>
      </div>
      <button id="notifBtn" class="btn icon hidden" title="é€šçŸ¥">ğŸ””<span id="notifDot" class="badge hidden">0</span></button>
      <div id="userMenu" class="row">
        <button id="resetBtn" class="btn small ghost hidden">é‡ç½® Demo</button>
        <button id="loginBtn" class="btn primary">ç™»å…¥</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="view-login">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">ç™»å…¥</div>
          <div class="muted">ä½¿ç”¨ä¸‹æ–¹å¸³å¯†é«”é©—ä¸åŒè§’è‰²ï¼ˆadmin / student / teacherï¼‰ã€‚</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div><label>å¸³è™Ÿ</label><input id="login-username" placeholder="admin@example.com" /></div>
            <div><label>å¯†ç¢¼</label><input id="login-password" type="password" placeholder="password" /></div>
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button id="login-submit" class="btn success">ç™»å…¥</button>
            <span class="hint">åˆæ¬¡é–‹å•Ÿæœƒè‡ªå‹•å»ºç«‹ç¤ºç¯„è³‡æ–™ã€‚</span>
          </div>
          <div class="hr"></div>
          <div class="chips">
            <button class="btn small" data-demo-fill="admin">å¡«å…¥ admin</button>
            <button class="btn small" data-demo-fill="student">å¡«å…¥ student</button>
            <button class="btn small" data-demo-fill="teacher">å¡«å…¥ teacher</button>
          </div>
        </div>
        <div class="card">
          <div class="title">æœ¬ Demo ç‰¹è‰²</div>
          <ul>
            <li>æ¨è–¦æ•™å¸«ï¼šå¡ç‰‡æ¸…å–®ã€æ”¶è—ã€æŸ¥çœ‹ Profileã€é ç´„ã€‚</li>
            <li>æ•™æï¼šè³‡æ–™å¤¾æ¨¹ã€æ•™æé /æ¨¡æ“¬ PDFã€å¾æ•™æå¸¶å…¥é ç´„ã€‚</li>
            <li>é ç´„èª²è¡¨ï¼šåŠå°æ™‚åˆ‡ç‰‡ã€ç•™è¨€ã€è¡Œäº‹æ›† .icsã€‚</li>
            <li>æˆ‘çš„é ç´„ï¼šå…ˆåˆ—è¡¨ã€å¾Œæ—¥æ›†ï¼›å–æ¶ˆ/æ”¹æœŸã€è©•åƒ¹ã€‚</li>
            <li>è€å¸«ç«¯ï¼šå¯ç”¨æ™‚æ®µè¨­å®šã€é ç´„åˆ—è¡¨ã€ç›¸ç°¿ä¸Šå‚³ã€‚</li>
            <li>ç®¡ç†ç«¯ï¼šæ•™æç®¡ç†ã€æ•™å¸«ä¸Šæ¶ã€è©•åƒ¹å¯©æ ¸ã€‚</li>
            <li>é€šçŸ¥ä¸­å¿ƒï¼šé ç´„/å¯©æ ¸ç­‰äº‹ä»¶æ¨æ’­ã€‚</li>
          </ul>
          <div class="subtle">
            <b>æç¤ºï¼š</b>æ‰€æœ‰è³‡æ–™é€éçœŸå¯¦APIæä¾›ï¼Œé»ã€Œé‡ç½® Demoã€å¯å›åˆ°å‡ºå» ç‹€æ…‹ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Teachers -->
    <section id="view-teachers" hidden>
      <div class="row wrap">
        <div class="title">æ¨è–¦æ•™å¸«</div>
        <span class="pill" id="courseContext">é ç´„èª²ç¨‹ï¼šè‡ªç”±å°è©±</span>
        <div class="spacer"></div>
        <div class="row wrap">
          <select id="filter-tag" class="pill">
            <option value="">å…¨éƒ¨é ˜åŸŸ</option>
            <option>English</option>
            <option>Conversation</option>
            <option>Pronunciation</option>
            <option>IELTS</option>
          </select>
          <select id="filter-region" class="pill">
            <option value="">å…¨éƒ¨åœ°å€</option>
            <option>Taiwan</option>
          </select>
          <select id="filter-sort" class="pill">
            <option value="rating">æ’åºï¼šè©•åˆ†</option>
            <option value="exp">æ’åºï¼šå¹´è³‡</option>
            <option value="soonest">æ’åºï¼šæœ€è¿‘å¯ç´„</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" id="teachersGrid"></div>
    </section>

    <!-- Teacher Profile -->
    <section id="view-teacher-profile" hidden></section>

    <!-- Materials -->
    <section id="view-materials" hidden>
      <div class="row wrap">
        <div class="title">æ•™æ</div>
        <div class="spacer"></div>
        <div id="materials-actions" class="row wrap hidden">
          <button class="btn small" data-mt-action="add-folder">ï¼‹ æ–°å¢è³‡æ–™å¤¾</button>
          <button class="btn small" data-mt-action="add-page">ï¼‹ æ–°å¢æ•™æé </button>
          <button class="btn small" data-mt-action="add-pdf">ï¼‹ æ–°å¢ PDF</button>
        </div>
      </div>
      <div class="materials">
        <div class="tree" id="materialsTree"></div>
        <div class="card content-pane" id="materialsContent"></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" hidden></section>

    <!-- Bookings -->
    <section id="view-bookings" hidden></section>

    <!-- Purchases -->
    <section id="view-purchases" hidden></section>

    <!-- Student Profile -->
    <section id="view-student" hidden></section>

    <!-- Teacher Profile Management -->
    <section id="view-teacher-profile-manage" hidden></section>

    <!-- Teacher Dashboard -->
    <section id="view-teacher-dashboard" hidden></section>

    <!-- Admin -->
    <section id="view-admin" hidden>
      <div class="container">
        <div class="title">ç®¡ç†å“¡å¾Œå°</div>
        <div class="subtitle">ç”¨æˆ¶ç®¡ç†ç³»çµ±</div>

        <!-- ç”¨æˆ¶ç®¡ç†é¸é …å¡ -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="user-list">ç”¨æˆ¶åˆ—è¡¨</button>
          <button class="tab-btn" data-tab="create-user">æ–°å¢ç”¨æˆ¶</button>
          <button class="tab-btn" data-tab="system-stats">ç³»çµ±çµ±è¨ˆ</button>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div id="admin-tab-user-list" class="tab-content">
          <div class="card">
            <div class="title">ç”¨æˆ¶åˆ—è¡¨</div>

            <!-- æœå°‹å’Œç¯©é¸ -->
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
              <div>
                <label>æœå°‹</label>
                <input id="user-search" placeholder="å§“åæˆ–Email" />
              </div>
              <div>
                <label>è§’è‰²</label>
                <select id="user-role-filter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="admin">ç®¡ç†å“¡</option>
                  <option value="teacher">æ•™å¸«</option>
                  <option value="student">å­¸ç”Ÿ</option>
                </select>
              </div>
              <div>
                <label>ç‹€æ…‹</label>
                <select id="user-status-filter">
                  <option value="">å…¨éƒ¨</option>
                  <option value="true">å•Ÿç”¨</option>
                  <option value="false">åœç”¨</option>
                </select>
              </div>
              <div style="align-self: end;">
                <button class="btn primary" onclick="searchUsers()">æœå°‹</button>
              </div>
            </div>

            <!-- ç”¨æˆ¶è¡¨æ ¼ -->
            <div id="users-table-container">
              <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>

            <!-- åˆ†é  -->
            <div id="users-pagination" class="pagination"></div>
          </div>
        </div>

        <!-- æ–°å¢ç”¨æˆ¶ -->
        <div id="admin-tab-create-user" class="tab-content" hidden>
          <div class="card">
            <div class="title">æ–°å¢ç”¨æˆ¶</div>

            <div class="form-grid">
              <div>
                <label>è§’è‰² *</label>
                <select id="new-user-role" onchange="toggleTeacherFields()">
                  <option value="student">å­¸ç”Ÿ</option>
                  <option value="teacher">æ•™å¸«</option>
                  <option value="admin">ç®¡ç†å“¡</option>
                </select>
              </div>
              <div>
                <label>Email *</label>
                <input id="new-user-email" type="email" placeholder="user@example.com" />
              </div>
              <div>
                <label>å§“å *</label>
                <input id="new-user-name" placeholder="ç”¨æˆ¶å§“å" />
              </div>
              <div>
                <label>åˆå§‹å¯†ç¢¼</label>
                <input id="new-user-password" type="password" placeholder="ç•™ç©ºä½¿ç”¨é è¨­å¯†ç¢¼" />
              </div>
              <div>
                <label>é›»è©±</label>
                <input id="new-user-phone" placeholder="é›»è©±è™Ÿç¢¼" />
              </div>
              <div>
                <label>æ™‚å€</label>
                <select id="new-user-timezone">
                  <option value="Asia/Taipei">Asia/Taipei</option>
                  <option value="UTC">UTC</option>
                  <option value="America/New_York">America/New_York</option>
                </select>
              </div>
            </div>

            <div>
              <label>å€‹äººç°¡ä»‹</label>
              <textarea id="new-user-bio" placeholder="å€‹äººç°¡ä»‹"></textarea>
            </div>

            <!-- æ•™å¸«å°ˆç”¨æ¬„ä½ -->
            <div id="teacher-fields" style="display: none;">
              <div class="hr"></div>
              <div class="subtitle">æ•™å¸«æª”æ¡ˆ</div>

              <div class="form-grid">
                <div>
                  <label>æ•™å­¸ç¶“é©—å¹´æ•¸</label>
                  <input id="new-teacher-experience" type="number" min="0" placeholder="5" />
                </div>
                <div>
                  <label>é–‹å§‹æ•™å­¸å¹´ä»½</label>
                  <input id="new-teacher-since" type="number" min="1990" placeholder="2020" />
                </div>
                <div>
                  <label>æ¯30åˆ†é˜åƒ¹æ ¼(USD)</label>
                  <input id="new-teacher-price" type="number" min="0" step="0.01" placeholder="25.00" />
                </div>
              </div>

              <div>
                <label>æ•™å¸«ä»‹ç´¹</label>
                <textarea id="new-teacher-intro" placeholder="æ•™å¸«è‡ªæˆ‘ä»‹ç´¹"></textarea>
              </div>

              <div>
                <label>è­‰æ›¸è³‡è¨Š (é€—è™Ÿåˆ†éš”)</label>
                <textarea id="new-teacher-certifications" placeholder="TESOL, IELTS, TOEFL"></textarea>
              </div>

              <div class="form-grid">
                <div>
                  <label>æ•™å­¸é ˜åŸŸ (é€—è™Ÿåˆ†éš”)</label>
                  <input id="new-teacher-domains" placeholder="English, Conversation, Business" />
                </div>
                <div>
                  <label>æ•™å­¸åœ°å€ (é€—è™Ÿåˆ†éš”)</label>
                  <input id="new-teacher-regions" placeholder="Taiwan, Online" />
                </div>
                <div>
                  <label>èªè¨€èƒ½åŠ› (é€—è™Ÿåˆ†éš”)</label>
                  <input id="new-teacher-languages" placeholder="English, Chinese" />
                </div>
              </div>
            </div>

            <div class="row" style="margin-top: 20px;">
              <button class="btn primary" onclick="createUser()">å‰µå»ºç”¨æˆ¶</button>
              <button class="btn" onclick="clearCreateUserForm()">æ¸…ç©ºè¡¨å–®</button>
            </div>
          </div>
        </div>

        <!-- ç³»çµ±çµ±è¨ˆ -->
        <div id="admin-tab-system-stats" class="tab-content" hidden>
          <div class="grid cols-3">
            <div class="card">
              <div class="title">ç”¨æˆ¶çµ±è¨ˆ</div>
              <div id="user-stats">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="card">
              <div class="title">é ç´„çµ±è¨ˆ</div>
              <div id="booking-stats">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="card">
              <div class="title">ç³»çµ±ç‹€æ…‹</div>
              <div id="system-stats">è¼‰å…¥ä¸­...</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal + Toast -->
  <div id="modalHost" class="modal-backdrop hidden"><div class="modal" id="modalBox"></div></div>
  <div id="toastHost" class="toast hidden"></div>

  <script>
    // API åŸºç¤è¨­å®š
    const API_BASE = window.location.origin;
    let accessToken = '';
    let currentUser = null;
    let currentTimezone = 'Asia/Taipei';
    let DB = {
      courseContext: null,
      favorites: {},
      notifications: []
    };

    // å·¥å…·å‡½æ•¸
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{
        if(k==='class') node.className=v;
        else if(k==='html') node.innerHTML=v;
        else if(k.startsWith('on') && typeof v==='function') node.addEventListener(k.substring(2), v);
        else if(v!==undefined) node.setAttribute(k,v);
      });
      children.forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    };

    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit', weekday:'short'});
    const fmtDateFull = d => new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const fmtDateWithTimezone = (d, timezone) => {
      const options = {
        timeZone: timezone || currentTimezone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false
      };
      return new Date(d).toLocaleString('zh-TW', options);
    };
    const toast = (msg, type = 'info')=>{
      const t=$("#toastHost");
      t.textContent=msg;
      t.className = `toast ${type}`;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), type === 'error' ? 4000 : 2200);
    };

    // æ™‚å€ç›¸é—œå‡½æ•¸
    function getCurrentTimezone() {
      return currentTimezone;
    }

    function updateTimezone() {
      const select = $("#timezone-select");
      currentTimezone = select.value;
      updateCurrentTimeDisplay();
      console.log('æ™‚å€å·²æ›´æ–°ç‚º:', currentTimezone);

      // å¦‚æœåœ¨é ç´„é é¢ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
      if (current() === 'bookings') {
        renderBookings();
      }
    }

    function updateCurrentTimeDisplay() {
      const timeSpan = $("#current-time");
      if (timeSpan) {
        const now = new Date();
        const options = {
          timeZone: currentTimezone,
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        };
        const localTime = now.toLocaleString('zh-TW', options);
        timeSpan.textContent = localTime;
      }
    }

    function initializeTimezone() {
      // å˜—è©¦æª¢æ¸¬ç”¨æˆ¶çš„æ™‚å€
      const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const select = $("#timezone-select");

      // å¦‚æœç”¨æˆ¶æ™‚å€åœ¨é¸é …ä¸­ï¼Œå‰‡è¨­ç‚ºé è¨­å€¼
      const options = Array.from(select.options);
      const userOption = options.find(option => option.value === userTimezone);
      if (userOption) {
        select.value = userTimezone;
        currentTimezone = userTimezone;
      }

      updateCurrentTimeDisplay();

      // æ¯åˆ†é˜æ›´æ–°æ™‚é–“é¡¯ç¤º
      setInterval(updateCurrentTimeDisplay, 60000);
    }
    const openModal = (node)=>{ $("#modalBox").innerHTML=''; $("#modalBox").appendChild(node); $("#modalHost").classList.remove('hidden'); };
    const closeModal = ()=> $("#modalHost").classList.add('hidden');
    $("#modalHost").addEventListener('click', e=>{ if(e.target.id==='modalHost') closeModal(); });

    // å‰µå»ºæ¨¡æ…‹æ¡†çš„è¼”åŠ©å‡½æ•¸
    function createModal(title, content, buttons = []) {
      const modal = document.createElement('div');

      // æ¨™é¡Œåˆ—
      const header = document.createElement('div');
      header.className = 'row wrap';
      header.innerHTML = `
        <h3 style="margin:0">${title}</h3>
        <div class="spacer"></div>
        <button class="btn small" onclick="closeModal()">âœ•</button>
      `;

      // åˆ†éš”ç·š
      const hr = document.createElement('div');
      hr.className = 'hr';

      // å…§å®¹
      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = content;

      // æŒ‰éˆ•åˆ—
      const buttonRow = document.createElement('div');
      buttonRow.className = 'row wrap';
      buttonRow.style.marginTop = '16px';

      buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.className = button.class || 'btn';
        btn.textContent = button.text;
        btn.onclick = button.onclick;
        buttonRow.appendChild(btn);
      });

      // çµ„è£æ¨¡æ…‹æ¡†
      modal.appendChild(header);
      modal.appendChild(hr);
      modal.appendChild(contentDiv);
      if (buttons.length > 0) {
        modal.appendChild(buttonRow);
      }

      return modal;
    }

    // é ­åƒçµ„ä»¶
    function createAvatar(user, size = 54, options = {}) {
      const { round = false, className = '' } = options;
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      const avatarClass = `avatar ${round ? 'round' : ''} ${className}`.trim();

      if (user.avatarUrl) {
        return el('div', {
          class: avatarClass,
          style: `width:${size}px; height:${size}px`,
          title: user.name
        }, el('img', {
          src: user.avatarUrl,
          alt: user.name,
          style: 'width:100%; height:100%; object-fit:cover'
        }));
      } else {
        return el('div', {
          class: avatarClass,
          style: `width:${size}px; height:${size}px`,
          title: user.name
        }, initials);
      }
    }

    function showErrorModal(title, message, actions = []) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0; color:#dc2626'}, title),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'margin:16px 0; line-height:1.5'}, message),
        actions.length > 0 ? el('div', {class: 'row wrap', style: 'margin-top:16px; gap:8px'},
          ...actions.map(action =>
            el('button', {
              class: action.primary ? 'btn primary' : 'btn',
              onclick: () => {
                closeModal();
                if (action.action) action.action();
              }
            }, action.text)
          )
        ) : el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: closeModal}, 'ç¢ºå®š')
        )
      );

      openModal(modal);
    }

    // API è«‹æ±‚å‡½æ•¸
    async function apiRequest(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      const headers = {
        ...options.headers
      };

      // åªæœ‰åœ¨bodyä¸æ˜¯FormDataæ™‚æ‰è¨­ç½®Content-Type
      if (!(options.body instanceof FormData) && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
      }

      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }

      // èª¿è©¦ä¿¡æ¯
      console.log('API Request:', {
        url,
        method: options.method || 'GET',
        bodyType: options.body ? options.body.constructor.name : 'undefined',
        isFormData: options.body instanceof FormData
      });

      try {
        const response = await fetch(url, {
          ...options,
          headers
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return await response.json();
        }
        return null;
      } catch (error) {
        console.error('API Request failed:', error);
        toast('API è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
        throw error;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      setupEventListeners();
      initializeTimezone(); // åˆå§‹åŒ–æ™‚å€åŠŸèƒ½
      headerUI();
      goto('login');
    }

    function setupEventListeners() {
      // ç™»å…¥ç›¸é—œ
      $("#login-submit").addEventListener('click', doLogin);
      $("#loginBtn").addEventListener('click', () => goto('login'));
      
      // Demo å¡«å…¥æŒ‰éˆ•
      document.querySelectorAll('[data-demo-fill]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const role = e.target.dataset.demoFill;
          fillDemoCredentials(role);
        });
      });

      // Tab å°èˆª
      $("#tabbar").addEventListener('click', (e) => {
        if (e.target.dataset.go) {
          goto(e.target.dataset.go);
        }
      });

      // é‡ç½®æŒ‰éˆ•
      $("#resetBtn").addEventListener('click', resetDemo);
    }

    function fillDemoCredentials(role) {
      const credentials = {
        admin: { username: 'admin@example.com', password: 'password' },
        student: { username: 'student1@example.com', password: 'password' },
        teacher: { username: 'teacher1@example.com', password: 'password' }
      };

      if (credentials[role]) {
        $("#login-username").value = credentials[role].username;
        $("#login-password").value = credentials[role].password;
      }
    }

    // è·¯ç”±ç³»çµ±
    const ROUTES = ['login','teachers','teacher-profile','materials','schedule','bookings','student','teacher-dashboard','admin'];
    const goto = (hash)=>{ location.hash = '#/'+hash; };
    const current = ()=> (location.hash.replace('#/','')||'login');

    window.addEventListener('hashchange', render);

    function render() {
      const route = current();
      showOnly('view-' + route.split('/')[0]);
      
      if (route.startsWith('teachers') && route !== 'teachers') {
        renderTeachers();
      } else if (route === 'teachers') {
        renderTeachers();
      } else if (route === 'materials') {
        renderMaterials();
      } else if (route === 'bookings') {
        renderBookings();
      } else if (route === 'purchases') {
        renderPurchases();
      } else if (route === 'student') {
        renderStudentProfile();
      } else if (route === 'teacher-profile') {
        renderTeacherProfileManage();
      } else if (route === 'admin') {
        renderAdmin();
      }
    }

    function showOnly(id) {
      ['view-login','view-teachers','view-teacher-profile','view-materials','view-schedule','view-bookings','view-purchases','view-student','view-teacher-profile-manage','view-teacher-dashboard','view-admin']
      .forEach(v => $( '#'+v ).hidden = (v!==id));
    }

    // èªè­‰ç›¸é—œå‡½æ•¸
    async function doLogin() {
      const username = $("#login-username").value;
      const password = $("#login-password").value;

      if (!username || !password) {
        toast('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
        return;
      }

      try {
        const response = await apiRequest('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });

        if (response.accessToken) {
          accessToken = response.accessToken;

          // ç²å–ç”¨æˆ¶ä¿¡æ¯
          const userInfo = await apiRequest('/auth/me');
          currentUser = userInfo;

          headerUI();
          goto('teachers');
          toast(`æ­¡è¿ï¼Œ${currentUser.name || currentUser.email}`);
        }
      } catch (error) {
        toast('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    async function doLogout() {
      try {
        if (accessToken) {
          await apiRequest('/auth/logout', { method: 'POST' });
        }
      } catch (error) {
        console.error('Logout error:', error);
      }

      accessToken = '';
      currentUser = null;
      headerUI();
      goto('login');
      toast('å·²ç™»å‡º');
    }

    // é ­éƒ¨UIæ›´æ–°
    function headerUI() {
      const logged = !!currentUser;
      $("#loginBtn").classList.toggle('hidden', logged);
      $("#searchBar").classList.toggle('hidden', !logged);
      $("#notifBtn").classList.toggle('hidden', !logged);
      $("#resetBtn").classList.toggle('hidden', !logged);
      $("#timezone-container").classList.toggle('hidden', !logged);

      if (logged) {
        const menu = $("#userMenu");
        let logoutBtn = menu.querySelector('#logoutBtn');
        if (!logoutBtn) {
          logoutBtn = el('button', {id:'logoutBtn', class:'btn'}, `ç™»å‡ºï¼ˆ${currentUser.name || currentUser.username}ï¼‰`);
          logoutBtn.addEventListener('click', doLogout);
          menu.appendChild(logoutBtn);
        }
      } else {
        const logoutBtn = $("#userMenu").querySelector('#logoutBtn');
        if (logoutBtn) logoutBtn.remove();
      }

      navTabs();
    }

    function navTabs() {
      const role = currentUser?.role;
      const bar = $("#tabbar");
      bar.innerHTML = '';

      const addTab = (key, label, opts = {}) => {
        const b = el('button', {class:'tab', 'data-go':key}, label);
        if (current().startsWith(key)) b.classList.add('active');
        if (opts.hide) b.classList.add('hidden');
        bar.appendChild(b);
      };

      addTab('teachers', 'æ¨è–¦æ•™å¸«', {hide: !role});
      addTab('materials', 'æ•™æ', {hide: !role});
      addTab('bookings', 'æˆ‘çš„é ç´„', {hide: !role});
      addTab('purchases', 'æˆ‘çš„å¡ç‰‡', {hide: !role});
      if (role === 'student') addTab('student', 'æˆ‘çš„è³‡æ–™');
      if (role === 'teacher') {
        addTab('teacher-profile', 'æˆ‘çš„è³‡æ–™');
        addTab('teacher-dashboard', 'è€å¸«å¾Œå°');
      }
      if (role === 'admin') addTab('admin', 'ç®¡ç†å¾Œå°');
    }

    // æ•™å¸«åˆ—è¡¨æ¸²æŸ“
    async function renderTeachers() {
      showOnly('view-teachers');
      $("#courseContext").textContent = 'é ç´„èª²ç¨‹ï¼š' + (DB.courseContext?.name || 'è‡ªç”±å°è©±');

      try {
        const response = await apiRequest('/teachers');
        const teachers = response.items || [];

        const grid = $("#teachersGrid");
        grid.innerHTML = '';

        teachers.forEach(teacher => {
          const card = createTeacherCard(teacher);
          grid.appendChild(card);
        });

      } catch (error) {
        console.error('Failed to load teachers:', error);
        toast('è¼‰å…¥æ•™å¸«åˆ—è¡¨å¤±æ•—', 'error');
      }
    }

    function createTeacherCard(teacher) {
      return el('div', {class: 'card teacher-card'},
        createAvatar(teacher, 54, { round: true }),
        el('div', {},
          el('div', {class: 'row wrap'},
            el('div', {class: 'title'}, teacher.name),
            el('span', {class: 'badge'}, `åœ°å€ï¼š${teacher.region}`),
            el('span', {class: 'badge'}, `ç¶“é©—ï¼š${teacher.experienceYears} å¹´`),
            el('span', {class: 'badge'}, `è©•åˆ†ï¼š${teacher.rating}`)
          ),
          el('div', {class: 'tags'}, ...teacher.domains.map(domain => el('span', {class: 'pill'}, domain))),
          el('div', {class: 'muted'}, teacher.introSnippet || 'å°ˆæ¥­æ•™å¸«'),
          el('div', {class: 'actions'},
            el('button', {class: 'btn small', onclick: () => openTeacherProfile(teacher.id)}, 'æŸ¥çœ‹ Profile'),
            el('button', {class: 'btn small primary', onclick: () => openSchedule(teacher.id)}, 'é ç´„'),
            currentUser?.role === 'student'
              ? el('button', {class: 'btn small', onclick: () => toggleFav(teacher.id)}, 'â˜† æ”¶è—')
              : null
          )
        )
      );
    }

    // æ•™å¸«è©³æƒ…
    async function openTeacherProfile(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        renderTeacherProfile(teacher);
        goto(`teacher-profile/${teacherId}`);
      } catch (error) {
        toast('è¼‰å…¥æ•™å¸«è©³æƒ…å¤±æ•—');
      }
    }

    function renderTeacherProfile(teacher) {
      showOnly('view-teacher-profile');
      const wrap = $("#view-teacher-profile");
      wrap.innerHTML = '';

      wrap.appendChild(el('div', {class: 'card'},
        el('div', {class: 'row wrap'},
          createAvatar(teacher),
          el('div', {},
            el('div', {class: 'title'}, teacher.name),
            el('div', {class: 'chips'},
              el('span', {class: 'badge'}, `åœ°å€ï¼š${teacher.region}`),
              el('span', {class: 'badge'}, `å¹´è³‡ï¼š${teacher.experienceYears} å¹´`),
              el('span', {class: 'badge'}, `è©•åˆ†ï¼š${teacher.rating}`)
            )
          ),
          el('div', {class: 'spacer'}),
          el('div', {class: 'row wrap'},
            el('button', {class: 'btn primary small', onclick: () => openSchedule(teacher.id)}, 'ä¸€éµé ç´„'),
            el('button', {class: 'btn small', onclick: () => goto('teachers')}, 'è¿”å›åˆ—è¡¨')
          )
        ),
        el('div', {class: 'tags', style: 'margin-top:6px'}, ...teacher.domains.map(x => el('span', {class: 'pill'}, x))),
        el('div', {class: 'hr'}),
        el('div', {}, el('b', {}, 'è‡ªæˆ‘ä»‹ç´¹'), el('div', {class: 'muted'}, teacher.intro || 'å°ˆæ¥­æ•™å¸«ï¼Œæ­¡è¿é ç´„èª²ç¨‹'))
      ));
    }

    // é ç´„ç›¸é—œ
    async function openSchedule(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        showScheduleModal(teacher);
      } catch (error) {
        toast('è¼‰å…¥æ•™å¸«è³‡è¨Šå¤±æ•—');
      }
    }

    function showScheduleModal(teacher) {
      const today = new Date();
      const dates = [];

      // ç”Ÿæˆæœªä¾†7å¤©çš„æ—¥æœŸ
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        dates.push(date);
      }

      const modal = el('div', {style: 'max-height:90vh; overflow-y:auto'},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, `é ç´„ ${teacher.name} çš„èª²ç¨‹`),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'muted'}, 'é¸æ“‡æ—¥æœŸå’Œæ™‚é–“'),
        el('div', {class: 'date-strip', id: 'dateStrip'}),
        el('div', {id: 'timeSlots', style: 'margin-top:16px; max-height:250px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px'}),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'èª²ç¨‹æ¨™é¡Œ'),
            el('input', {id: 'courseTitle', value: DB.courseContext?.name || 'è‡ªç”±å°è©±'})
          ),
          el('div', {},
            el('label', {}, 'æŒçºŒæ™‚é–“'),
            el('select', {id: 'duration'},
              el('option', {value: '30'}, '30åˆ†é˜'),
              el('option', {value: '60'}, '60åˆ†é˜'),
              el('option', {value: '90'}, '90åˆ†é˜')
            )
          )
        ),
        el('div', {},
          el('label', {}, 'çµ¦è€å¸«çš„ç•™è¨€'),
          el('textarea', {id: 'bookingMessage', placeholder: 'å¯ä»¥å‘Šè¨´è€å¸«æ‚¨çš„å­¸ç¿’ç›®æ¨™æˆ–ç‰¹æ®Šéœ€æ±‚...', rows: 3})
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px; position:sticky; bottom:0; background:white; padding-top:16px; border-top:1px solid #e5e7eb; margin-left:-18px; margin-right:-18px; padding-left:18px; padding-right:18px'},
          el('button', {class: 'btn primary', onclick: () => submitBooking(teacher.id)}, 'ç¢ºèªé ç´„'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );

      openModal(modal);

      // æ¸²æŸ“æ—¥æœŸé¸æ“‡
      renderDateStrip(dates);

      // é è¨­é¸æ“‡ä»Šå¤©
      selectDate(dates[0], teacher.id);
    }

    function renderDateStrip(dates) {
      const strip = $("#dateStrip");
      strip.innerHTML = '';

      dates.forEach((date, index) => {
        const pill = el('div', {
          class: `date-pill ${index === 0 ? 'active' : ''}`,
          onclick: () => {
            document.querySelectorAll('.date-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            selectDate(date, getCurrentTeacherId());
          }
        },
          el('div', {style: 'font-weight:600'}, date.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'})),
          el('div', {style: 'font-size:12px'}, date.toLocaleDateString('zh-TW', {weekday:'short'}))
        );
        strip.appendChild(pill);
      });
    }

    function getCurrentTeacherId() {
      // å¾æ¨¡æ…‹æ¡†ä¸­ç²å–ç•¶å‰æ•™å¸«IDï¼Œé€™è£¡ç°¡åŒ–è™•ç†
      return window.currentTeacherId;
    }

    async function selectDate(date, teacherId) {
      window.currentTeacherId = teacherId;
      window.selectedDate = date;

      const dateStr = date.toISOString().split('T')[0];

      try {
        // ç²å–æ•™å¸«æ™‚é–“è¡¨ï¼ˆæ”¯æ´æ™‚å€ï¼‰
        const response = await fetch(`${API_BASE}/teacher-availability/teacher-timetable?teacherId=${teacherId}&date=${dateStr}&timezone=${currentTimezone}`);
        const result = await response.json();

        if (result.code === 0) {
          renderTimeSlots(result.data || []);
        } else {
          renderTimeSlots([]);
        }
      } catch (error) {
        console.error('Failed to load timetable:', error);
        renderTimeSlots([]);
      }
    }

    function renderTimeSlots(timetable) {
      const container = $("#timeSlots");
      container.innerHTML = '';

      if (timetable.length === 0) {
        container.appendChild(el('div', {class: 'muted'}, 'è©²æ—¥æœŸæš«ç„¡å¯ç”¨æ™‚æ®µ'));
        return;
      }

      container.appendChild(el('div', {class: 'muted', style: 'margin-bottom:8px'}, 'å¯ç”¨æ™‚æ®µï¼š'));

      const slots = el('div', {class: 'slots'});

      timetable.forEach(slot => {
        if (slot.canReserve === 1) {
          const slotEl = el('div', {
            class: 'slot',
            onclick: () => {
              document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
              slotEl.classList.add('selected');
              window.selectedTimeSlot = slot;
            }
          }, slot.time);
          slots.appendChild(slotEl);
        }
      });

      container.appendChild(slots);
    }

    async function submitBooking(teacherId) {
      if (!window.selectedDate || !window.selectedTimeSlot) {
        toast('è«‹é¸æ“‡æ—¥æœŸå’Œæ™‚é–“');
        return;
      }

      const courseTitle = $("#courseTitle").value;
      const duration = parseInt($("#duration").value);
      const message = $("#bookingMessage").value;

      // æ§‹å»ºé ç´„æ™‚é–“ï¼ˆæ”¯æ´æ™‚å€ï¼‰
      const [hours, minutes] = window.selectedTimeSlot.time.split(':');
      const dateStr = window.selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD
      const timeStr = `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00`;

      // å‰µå»ºæ™‚å€æ„ŸçŸ¥çš„æ™‚é–“å­—ä¸²
      const timezoneOffsetStr = currentTimezone === 'Asia/Shanghai' ? '+08:00' :
                               currentTimezone === 'Asia/Taipei' ? '+08:00' :
                               currentTimezone === 'America/New_York' ? '-05:00' :
                               currentTimezone === 'America/Los_Angeles' ? '-08:00' :
                               currentTimezone === 'Europe/London' ? '+00:00' :
                               '+08:00'; // é»˜èª

      const startsAtISO = `${dateStr}T${timeStr}${timezoneOffsetStr}`;

      const bookingData = {
        teacherId,
        startsAt: startsAtISO,
        durationMinutes: duration,
        timezone: currentTimezone,
        courseTitle,
        message,
        materialId: DB.courseContext?.id
      };

      try {
        await apiRequest('/bookings', {
          method: 'POST',
          body: JSON.stringify(bookingData)
        });

        closeModal();
        toast('é ç´„æˆåŠŸï¼', 'success');

        // å¦‚æœåœ¨é ç´„é é¢ï¼Œåˆ·æ–°åˆ—è¡¨
        if (current() === 'bookings') {
          renderBookings();
        }
      } catch (error) {
        console.error('Booking failed:', error);

        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
        let errorMessage = 'é ç´„å¤±æ•—';
        if (error.message) {
          if (error.message.includes('Insufficient cards')) {
            errorMessage = 'é ç´„å¤±æ•—ï¼šèª²å¡ä¸è¶³ï¼Œè«‹å…ˆè³¼è²·æˆ–æ¿€æ´»èª²å¡';
          } else if (error.message.includes('Time slot conflicts')) {
            errorMessage = 'é ç´„å¤±æ•—ï¼šæ™‚é–“è¡çªï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“';
          } else if (error.message.includes('Teacher not found')) {
            errorMessage = 'é ç´„å¤±æ•—ï¼šæ•™å¸«ä¸å­˜åœ¨';
          } else if (error.message.includes('Invalid time')) {
            errorMessage = 'é ç´„å¤±æ•—ï¼šæ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡';
          } else {
            errorMessage = `é ç´„å¤±æ•—ï¼š${error.message}`;
          }
        }

        // é¡¯ç¤ºéŒ¯èª¤æç¤º
        showErrorModal('é ç´„å¤±æ•—', errorMessage, [
          {text: 'é‡æ–°é¸æ“‡æ™‚é–“', action: () => {}},
          {text: 'æŸ¥çœ‹æˆ‘çš„å¡ç‰‡', action: () => {closeModal(); goto('purchases');}},
          {text: 'é—œé–‰', action: () => {}}
        ]);
      }
    }

    function toggleFav(teacherId) {
      toast('æ”¶è—åŠŸèƒ½é–‹ç™¼ä¸­...');
      // TODO: å¯¦ç¾æ”¶è—åŠŸèƒ½
    }

    // å–æ¶ˆé ç´„
    async function cancelBooking(bookingId) {
      if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿ\n\næ ¹æ“šå–æ¶ˆæ”¿ç­–ï¼Œå¯èƒ½æœƒæ‰£é™¤å–æ¶ˆå¡æˆ–èª²å¡ã€‚')) {
        return;
      }

      try {
        const response = await apiRequest(`/bookings/${bookingId}/cancel`, {
          method: 'POST',
          body: JSON.stringify({
            reason: 'å­¸ç”Ÿä¸»å‹•å–æ¶ˆ',
            cause: 'student_request'
          })
        });

        toast('é ç´„å·²å–æ¶ˆ');

        // é¡¯ç¤ºé€€æ¬¾ä¿¡æ¯
        if (response.refund) {
          const refundInfo = response.refund;
          let message = 'å–æ¶ˆçµæœï¼š\n';
          if (refundInfo.lessonCardsReturned > 0) {
            message += `â€¢ é€€é‚„èª²å¡ï¼š${refundInfo.lessonCardsReturned} å¼µ\n`;
          }
          if (refundInfo.cancelCardsConsumed > 0) {
            message += `â€¢ æ‰£é™¤å–æ¶ˆå¡ï¼š${refundInfo.cancelCardsConsumed} å¼µ\n`;
          }
          if (refundInfo.compensationGranted > 0) {
            message += `â€¢ è£œå„Ÿèª²å¡ï¼š${refundInfo.compensationGranted} å¼µ\n`;
          }
          if (refundInfo.notes) {
            message += `â€¢ å‚™è¨»ï¼š${refundInfo.notes}`;
          }

          alert(message);
        }

        // åˆ·æ–°é ç´„åˆ—è¡¨
        if (current() === 'bookings') {
          renderBookings();
        }
      } catch (error) {
        toast('å–æ¶ˆå¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // ç²å–ç‹€æ…‹é¡¯ç¤ºçµ„ä»¶
    function getStatusChip(status) {
      const statusMap = {
        'scheduled': { text: 'å³å°‡é–‹å§‹', class: 'status-scheduled' },
        'canceled': { text: 'å·²å–æ¶ˆ', class: 'status-canceled' },
        'completed': { text: 'å·²å®Œæˆ', class: 'status-completed' },
        'noshow': { text: 'æœªå‡ºå¸­', class: 'status-noshow' },
        'pending': { text: 'å¾…ç¢ºèª', class: 'status-pending' },
        'pending_teacher': { text: 'å¾…æ•™å¸«ç¢ºèª', class: 'status-pending' }
      };

      const statusInfo = statusMap[status] || { text: status, class: 'status-pending' };
      return el('span', {class: `status-chip ${statusInfo.class}`}, statusInfo.text);
    }

    // ç²å–ç‹€æ…‹æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'scheduled': 'å·²ç¢ºèª',
        'canceled': 'å·²å–æ¶ˆ',
        'completed': 'å·²å®Œæˆ',
        'noshow': 'æœªå‡ºå¸­',
        'pending': 'å¾…ç¢ºèª',
        'pending_teacher': 'å¾…æ•™å¸«ç¢ºèª'
      };

      return statusMap[status] || status;
    }

    // é¡¯ç¤ºé ç´„è©³æƒ…
    function showBookingDetails(booking) {
      const localTime = booking.startsAtLocal || fmtDateWithTimezone(booking.startsAt, currentTimezone);
      const teacherTime = booking.teacherLocalTime || fmtDateWithTimezone(booking.startsAt, booking.teacher?.timezone || 'Asia/Taipei');

      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'é ç´„è©³æƒ…'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'èª²ç¨‹æ¨™é¡Œ'),
            el('div', {}, booking.courseTitle || 'è‡ªç”±å°è©±')
          ),
          el('div', {},
            el('label', {}, 'æ•™å¸«'),
            el('div', {}, booking.teacher?.name || 'æœªçŸ¥è€å¸«')
          ),
          el('div', {},
            el('label', {}, 'æ‚¨çš„æ™‚é–“'),
            el('div', {}, localTime)
          ),
          el('div', {},
            el('label', {}, 'æ•™å¸«æ™‚é–“'),
            el('div', {}, teacherTime)
          ),
          el('div', {},
            el('label', {}, 'ç‹€æ…‹'),
            el('div', {}, getStatusText(booking.status))
          )
        ),
        booking.message ? el('div', {},
          el('label', {}, 'ç•™è¨€'),
          el('div', {class: 'muted'}, booking.message)
        ) : null,
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          booking.canCancel !== false ?
            el('button', {class: 'btn danger', onclick: () => { closeModal(); cancelBooking(booking.id); }}, 'å–æ¶ˆé ç´„') :
            null,
          el('button', {class: 'btn', onclick: closeModal}, 'é—œé–‰')
        )
      );

      openModal(modal);
    }

    // æ•™æç›¸é—œ
    async function renderMaterials() {
      showOnly('view-materials');
      $("#materials-actions").classList.toggle('hidden', currentUser?.role !== 'admin');

      try {
        const response = await apiRequest('/materials?include=all');
        renderMaterialsTree(response.folders || []);
        renderMaterialsContent();
      } catch (error) {
        console.error('Failed to load materials:', error);
        toast('è¼‰å…¥æ•™æå¤±æ•—');
      }
    }

    function renderMaterialsTree(folders) {
      const tree = $("#materialsTree");
      tree.innerHTML = '';

      if (!folders || folders.length === 0) {
        tree.appendChild(el('div', {class: 'muted'}, 'æš«ç„¡æ•™æ'));
        return;
      }

      const ul = el('ul');
      folders.forEach(folder => {
        ul.appendChild(createFolderNode(folder));
      });
      tree.appendChild(ul);
    }

    function createFolderNode(folder) {
      const li = el('li');
      const icon = 'ğŸ“';
      const nodeEl = el('div', {
        class: 'node',
        onclick: () => selectMaterial(folder)
      },
        el('span', {class: 'icon'}, icon),
        el('span', {}, folder.name)
      );

      li.appendChild(nodeEl);

      // æ·»åŠ å­è³‡æ–™å¤¾
      if (folder.children?.length) {
        const subUl = el('ul');
        folder.children.forEach(child => {
          subUl.appendChild(createFolderNode(child));
        });
        li.appendChild(subUl);
      }

      // æ·»åŠ æ•™æé …ç›®
      if (folder.materials?.length) {
        const materialsUl = el('ul');
        folder.materials.forEach(material => {
          const materialLi = el('li');
          const materialIcon = material.type === 'pdf' ? 'ğŸ“„' : 'ğŸ“';
          const materialNode = el('div', {
            class: 'node',
            onclick: () => selectMaterial(material)
          },
            el('span', {class: 'icon'}, materialIcon),
            el('span', {}, material.title)
          );
          materialLi.appendChild(materialNode);
          materialsUl.appendChild(materialLi);
        });
        li.appendChild(materialsUl);
      }

      return li;
    }

    function selectMaterial(material) {
      // ç§»é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.tree .node.active').forEach(node => {
        node.classList.remove('active');
      });

      // æ·»åŠ ç•¶å‰é¸ä¸­ç‹€æ…‹
      event.currentTarget.classList.add('active');

      renderMaterialsContent(material);
    }

    function renderMaterialsContent(material) {
      const pane = $("#materialsContent");
      pane.innerHTML = '';

      if (!material) {
        pane.appendChild(el('div', {class: 'title'}, 'é¸æ“‡æ•™æ'));
        pane.appendChild(el('div', {class: 'muted'}, 'è«‹å¾å·¦å´é¸æ“‡æ•™ææŸ¥çœ‹å…§å®¹'));
        return;
      }

      const title = material.name || material.title || 'æœªå‘½å';
      pane.appendChild(el('div', {class: 'title'}, title));

      if (material.name && !material.type) {
        // é€™æ˜¯ä¸€å€‹è³‡æ–™å¤¾
        pane.appendChild(el('div', {class: 'muted'}, 'é€™æ˜¯ä¸€å€‹è³‡æ–™å¤¾ï¼ŒåŒ…å«å¤šå€‹æ•™æé …ç›®'));
        const childCount = (material.children?.length || 0) + (material.materials?.length || 0);
        pane.appendChild(el('div', {class: 'muted'}, `åŒ…å« ${childCount} å€‹é …ç›®`));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn', onclick: () => selectCourseContext(material)}, 'é¸æ“‡æ­¤èª²ç¨‹')
        ));
      } else {
        // é€™æ˜¯ä¸€å€‹æ•™æ
        const content = material.content || 'æš«ç„¡å…§å®¹æè¿°';
        pane.appendChild(el('div', {class: 'muted'}, `é¡å‹ï¼š${material.type === 'pdf' ? 'PDFæ–‡ä»¶' : 'æ•™æé é¢'}`));
        pane.appendChild(el('div', {class: 'hr'}));
        pane.appendChild(el('div', {class: 'card'},
          el('h4', {}, 'æ•™æå…§å®¹'),
          el('p', {}, content)
        ));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn primary', onclick: () => selectCourseContext(material)}, 'é ç´„è€å¸«'),
          el('span', {class: 'hint'}, 'å°‡å¸¶å…¥æ¨è–¦æ•™å¸«é ï¼Œä¸¦æ–¼é ç´„æ™‚è‡ªå‹•å¡«å…¥æ•™æ')
        ));
      }
    }

    function selectCourseContext(material) {
      const name = material.name || material.title || 'æœªå‘½åæ•™æ';
      DB.courseContext = {id: material.id, name: name};
      goto('teachers');
      toast('å·²å¸¶å…¥æ•™æè‡³é ç´„æµç¨‹');
    }

    // é ç´„åˆ—è¡¨
    async function renderBookings() {
      showOnly('view-bookings');
      const wrap = $("#view-bookings");
      wrap.innerHTML = '';

      // æ­¡è¿æ©«å¹…
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, `æ­¡è¿å›ä¾†ï¼Œ${currentUser?.name || 'ç”¨æˆ¶'}ï¼`),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, 'æº–å‚™å¥½é–‹å§‹ä»Šå¤©çš„å­¸ç¿’ä¹‹æ—…äº†å—ï¼Ÿ')
      ));

      try {
        const response = await apiRequest(`/bookings?timezone=${currentTimezone}`);
        const bookings = response.items || [];

        // ç•¶å‰é ç´„
        const listCard = el('div', {class: 'card', style: 'margin-top:16px'},
          el('div', {class: 'row wrap'},
            el('h2', {class: 'title', style: 'margin:0'}, 'ç•¶å‰é ç´„'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small ghost', onclick: () => goto('teachers')}, 'å»é ç´„æ›´å¤š')
          )
        );

        if (bookings.length === 0) {
          listCard.appendChild(el('div', {class: 'muted', style: 'padding:12px'}, 'ç›®å‰æ²’æœ‰é ç´„èª²ç¨‹'));
        } else {
          const table = createBookingsTable(bookings);
          listCard.appendChild(table);
        }

        wrap.appendChild(listCard);

      } catch (error) {
        console.error('Failed to load bookings:', error);
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'muted'}, 'è¼‰å…¥é ç´„åˆ—è¡¨å¤±æ•—')
        ));
      }
    }

    function createBookingsTable(bookings) {
      const table = el('table');
      const thead = el('thead', {}, el('tr', {},
        el('th', {}, 'èª²ç¨‹'),
        el('th', {}, 'è€å¸«'),
        el('th', {}, 'æ™‚é–“'),
        el('th', {}, 'ç‹€æ…‹'),
        el('th', {}, 'æ“ä½œ')
      ));

      const tbody = el('tbody');
      bookings.forEach(booking => {
        // é¡¯ç¤ºæœ¬åœ°æ™‚é–“å’Œæ•™å¸«æ™‚å€æ™‚é–“
        const localTime = booking.startsAtLocal || fmtDateWithTimezone(booking.startsAt, currentTimezone);
        const teacherTime = booking.teacherLocalTime ?
          `æ•™å¸«æ™‚é–“: ${booking.teacherLocalTime}` :
          fmtDateWithTimezone(booking.startsAt, booking.teacher?.timezone || 'Asia/Taipei');

        const tr = el('tr', {},
          el('td', {}, booking.courseTitle || 'è‡ªç”±å°è©±'),
          el('td', {}, booking.teacher?.name || 'æœªçŸ¥è€å¸«'),
          el('td', {},
            el('div', {}, localTime),
            el('div', {class: 'muted', style: 'font-size:11px'}, teacherTime)
          ),
          el('td', {}, getStatusChip(booking.status)),
          el('td', {},
            el('div', {class: 'row wrap'},
              el('button', {class: 'btn small', onclick: () => showBookingDetails(booking)}, 'è©³æƒ…'),
              booking.canCancel !== false ?
                el('button', {class: 'btn small danger', onclick: () => cancelBooking(booking.id)}, 'å–æ¶ˆ') :
                null
            )
          )
        );
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      return table;
    }

    // é‡ç½®Demo
    async function resetDemo() {
      if (!currentUser || currentUser.role !== 'admin') {
        toast('æ­¤åŠŸèƒ½éœ€è¦ç®¡ç†å“¡æ¬Šé™');
        return;
      }

      if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰Demoè³‡æ–™å—ï¼Ÿ')) {
        return;
      }

      try {
        await apiRequest('/admin/reset-data', { method: 'POST' });
        toast('Demoè³‡æ–™å·²é‡ç½®');
      } catch (error) {
        toast('é‡ç½®å¤±æ•—ï¼š' + error.message);
      }
    }

    // === Admin ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ ===

    let currentUsersPage = 1;
    let currentUsersQuery = {};

    async function renderAdmin() {
      showOnly('view-admin');

      // åˆå§‹åŒ–é¸é …å¡
      initAdminTabs();

      // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
      await loadUsers();

      // è¼‰å…¥çµ±è¨ˆè³‡æ–™
      await loadSystemStats();
    }

    function initAdminTabs() {
      const tabBtns = document.querySelectorAll('#view-admin .tab-btn');
      const tabContents = document.querySelectorAll('#view-admin .tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;

          // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          tabBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // é¡¯ç¤ºå°æ‡‰å…§å®¹
          tabContents.forEach(content => {
            content.hidden = !content.id.includes(tabName);
          });
        });
      });
    }

    async function loadUsers(page = 1) {
      currentUsersPage = page;
      const container = $('#users-table-container');
      container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

      try {
        const query = {
          page,
          pageSize: 20,
          ...currentUsersQuery
        };

        const queryString = new URLSearchParams(query).toString();
        const response = await apiRequest(`/admin/users?${queryString}`);

        renderUsersTable(response);
        renderUsersPagination(response);
      } catch (error) {
        container.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
      }
    }

    function renderUsersTable(data) {
      const container = $('#users-table-container');

      if (!data.items || data.items.length === 0) {
        container.innerHTML = '<div class="empty">æ²’æœ‰æ‰¾åˆ°ç”¨æˆ¶</div>';
        return;
      }

      const table = document.createElement('table');
      table.className = 'data-table';

      // è¡¨é ­
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>é ­åƒ</th>
          <th>å§“å</th>
          <th>Email</th>
          <th>è§’è‰²</th>
          <th>ç‹€æ…‹</th>
          <th>è¨»å†Šæ™‚é–“</th>
          <th>æ“ä½œ</th>
        </tr>
      `;
      table.appendChild(thead);

      // è¡¨èº«
      const tbody = document.createElement('tbody');
      data.items.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <img src="${user.avatarUrl || '/default-avatar.svg'}"
                 alt="Avatar" class="avatar-small"
                 style="width: 32px; height: 32px; border-radius: 50%;" />
          </td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>
            <span class="badge ${user.role}">${getRoleText(user.role)}</span>
          </td>
          <td>
            <span class="badge ${user.active ? 'success' : 'danger'}">
              ${user.active ? 'å•Ÿç”¨' : 'åœç”¨'}
            </span>
          </td>
          <td>${formatDate(user.createdAt)}</td>
          <td>
            <div class="btn-group">
              <button class="btn small" onclick="editUser('${user.id}')">ç·¨è¼¯</button>
              <button class="btn small" onclick="resetUserPassword('${user.id}')">é‡ç½®å¯†ç¢¼</button>
              ${user.role === 'teacher' ?
                `<button class="btn small" onclick="manageTeacherProfile('${user.id}')">æª”æ¡ˆ</button>` :
                ''
              }
              <button class="btn small ${user.active ? 'danger' : 'success'}"
                      onclick="toggleUserStatus('${user.id}', ${!user.active})">
                ${user.active ? 'åœç”¨' : 'å•Ÿç”¨'}
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      container.innerHTML = '';
      container.appendChild(table);
    }

    function renderUsersPagination(data) {
      const container = $('#users-pagination');

      if (data.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '<div class="pagination-info">';
      html += `é¡¯ç¤º ${(data.page - 1) * data.pageSize + 1}-${Math.min(data.page * data.pageSize, data.total)} `;
      html += `å…± ${data.total} ç­†</div>`;
      html += '<div class="pagination-buttons">';

      // ä¸Šä¸€é 
      if (data.page > 1) {
        html += `<button class="btn small" onclick="loadUsers(${data.page - 1})">ä¸Šä¸€é </button>`;
      }

      // é ç¢¼
      const startPage = Math.max(1, data.page - 2);
      const endPage = Math.min(data.totalPages, data.page + 2);

      for (let i = startPage; i <= endPage; i++) {
        const active = i === data.page ? 'primary' : '';
        html += `<button class="btn small ${active}" onclick="loadUsers(${i})">${i}</button>`;
      }

      // ä¸‹ä¸€é 
      if (data.page < data.totalPages) {
        html += `<button class="btn small" onclick="loadUsers(${data.page + 1})">ä¸‹ä¸€é </button>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function searchUsers() {
      const search = $('#user-search').value.trim();
      const role = $('#user-role-filter').value;
      const active = $('#user-status-filter').value;

      currentUsersQuery = {};
      if (search) currentUsersQuery.search = search;
      if (role) currentUsersQuery.role = role;
      if (active !== '') currentUsersQuery.active = active;

      loadUsers(1);
    }

    function getRoleText(role) {
      const roleMap = {
        admin: 'ç®¡ç†å“¡',
        teacher: 'æ•™å¸«',
        student: 'å­¸ç”Ÿ'
      };
      return roleMap[role] || role;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('zh-TW');
    }

    function toggleTeacherFields() {
      const role = $('#new-user-role').value;
      const teacherFields = $('#teacher-fields');
      teacherFields.style.display = role === 'teacher' ? 'block' : 'none';
    }

    async function createUser() {
      const role = $('#new-user-role').value;
      const email = $('#new-user-email').value.trim();
      const name = $('#new-user-name').value.trim();

      if (!email || !name) {
        toast('è«‹å¡«å¯«å¿…è¦æ¬„ä½');
        return;
      }

      const userData = {
        role,
        email,
        name,
        password: $('#new-user-password').value.trim() || undefined,
        phone: $('#new-user-phone').value.trim() || undefined,
        bio: $('#new-user-bio').value.trim() || undefined,
        timezone: $('#new-user-timezone').value,
        active: true
      };

      // å¦‚æœæ˜¯æ•™å¸«ï¼Œæ·»åŠ æ•™å¸«æª”æ¡ˆè³‡æ–™
      if (role === 'teacher') {
        const domains = $('#new-teacher-domains').value.trim();
        const regions = $('#new-teacher-regions').value.trim();
        const languages = $('#new-teacher-languages').value.trim();
        const certifications = $('#new-teacher-certifications').value.trim();

        Object.assign(userData, {
          intro: $('#new-teacher-intro').value.trim() || undefined,
          certifications: certifications ? certifications.split(',').map(s => s.trim()) : undefined,
          experienceYears: parseInt($('#new-teacher-experience').value) || undefined,
          experienceSince: parseInt($('#new-teacher-since').value) || undefined,
          unitPriceUsd: parseFloat($('#new-teacher-price').value) || undefined,
          domains: domains ? domains.split(',').map(s => s.trim()) : undefined,
          regions: regions ? regions.split(',').map(s => s.trim()) : undefined,
          languages: languages ? languages.split(',').map(s => s.trim()) : undefined
        });
      }

      try {
        const endpoint = role === 'teacher' ? '/admin/teachers' : '/admin/users';
        await apiRequest(endpoint, {
          method: 'POST',
          body: JSON.stringify(userData)
        });

        toast('ç”¨æˆ¶å‰µå»ºæˆåŠŸ');
        clearCreateUserForm();
        loadUsers(currentUsersPage); // é‡æ–°è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
      } catch (error) {
        toast('å‰µå»ºå¤±æ•—ï¼š' + error.message);
      }
    }

    function clearCreateUserForm() {
      $('#new-user-role').value = 'student';
      $('#new-user-email').value = '';
      $('#new-user-name').value = '';
      $('#new-user-password').value = '';
      $('#new-user-phone').value = '';
      $('#new-user-bio').value = '';
      $('#new-user-timezone').value = 'Asia/Taipei';

      // æ¸…ç©ºæ•™å¸«æ¬„ä½
      $('#new-teacher-intro').value = '';
      $('#new-teacher-certifications').value = '';
      $('#new-teacher-experience').value = '';
      $('#new-teacher-since').value = '';
      $('#new-teacher-price').value = '';
      $('#new-teacher-domains').value = '';
      $('#new-teacher-regions').value = '';
      $('#new-teacher-languages').value = '';

      toggleTeacherFields();
    }

    async function editUser(userId) {
      try {
        const user = await apiRequest(`/admin/users/${userId}`);
        showEditUserModal(user);
      } catch (error) {
        toast('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    function showEditUserModal(user) {
      const modal = createModal('ç·¨è¼¯ç”¨æˆ¶', `
        <div class="form-grid">
          <div>
            <label>å§“å</label>
            <input id="edit-user-name" value="${user.name}" />
          </div>
          <div>
            <label>é›»è©±</label>
            <input id="edit-user-phone" value="${user.phone || ''}" />
          </div>
          <div>
            <label>æ™‚å€</label>
            <select id="edit-user-timezone">
              <option value="Asia/Taipei" ${user.timezone === 'Asia/Taipei' ? 'selected' : ''}>Asia/Taipei</option>
              <option value="UTC" ${user.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
              <option value="America/New_York" ${user.timezone === 'America/New_York' ? 'selected' : ''}>America/New_York</option>
            </select>
          </div>
          <div>
            <label>ç‹€æ…‹</label>
            <select id="edit-user-active">
              <option value="true" ${user.active ? 'selected' : ''}>å•Ÿç”¨</option>
              <option value="false" ${!user.active ? 'selected' : ''}>åœç”¨</option>
            </select>
          </div>
        </div>
        <div>
          <label>å€‹äººç°¡ä»‹</label>
          <textarea id="edit-user-bio">${user.bio || ''}</textarea>
        </div>
      `, [
        {
          text: 'å„²å­˜',
          class: 'primary',
          onclick: () => saveUserEdit(user.id)
        },
        {
          text: 'å–æ¶ˆ',
          onclick: () => closeModal()
        }
      ]);

      openModal(modal);
    }

    async function saveUserEdit(userId) {
      const userData = {
        name: $('#edit-user-name').value.trim(),
        phone: $('#edit-user-phone').value.trim() || undefined,
        bio: $('#edit-user-bio').value.trim() || undefined,
        timezone: $('#edit-user-timezone').value,
        active: $('#edit-user-active').value === 'true'
      };

      try {
        await apiRequest(`/admin/users/${userId}`, {
          method: 'PUT',
          body: JSON.stringify(userData)
        });

        toast('ç”¨æˆ¶è³‡æ–™æ›´æ–°æˆåŠŸ');
        closeModal();
        loadUsers(currentUsersPage);
      } catch (error) {
        toast('æ›´æ–°å¤±æ•—ï¼š' + error.message);
      }
    }

    async function resetUserPassword(userId) {
      const newPassword = prompt('è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆç•™ç©ºä½¿ç”¨é è¨­å¯†ç¢¼ "password123"ï¼‰:');
      if (newPassword === null) return; // ç”¨æˆ¶å–æ¶ˆ

      const password = newPassword.trim() || 'password123';

      try {
        await apiRequest(`/admin/users/${userId}/reset-password`, {
          method: 'POST',
          body: JSON.stringify({
            newPassword: password,
            forceChangeOnNextLogin: false
          })
        });

        toast('å¯†ç¢¼é‡ç½®æˆåŠŸ');
      } catch (error) {
        toast('å¯†ç¢¼é‡ç½®å¤±æ•—ï¼š' + error.message);
      }
    }

    async function toggleUserStatus(userId, newStatus) {
      const action = newStatus ? 'å•Ÿç”¨' : 'åœç”¨';
      if (!confirm(`ç¢ºå®šè¦${action}æ­¤ç”¨æˆ¶å—ï¼Ÿ`)) return;

      try {
        await apiRequest(`/admin/users/${userId}`, {
          method: 'PUT',
          body: JSON.stringify({ active: newStatus })
        });

        toast(`ç”¨æˆ¶${action}æˆåŠŸ`);
        loadUsers(currentUsersPage);
      } catch (error) {
        toast(`${action}å¤±æ•—ï¼š` + error.message);
      }
    }

    async function manageTeacherProfile(teacherId) {
      try {
        const user = await apiRequest(`/admin/users/${teacherId}`);
        showTeacherProfileModal(user);
      } catch (error) {
        toast('è¼‰å…¥æ•™å¸«è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    function showTeacherProfileModal(user) {
      const profile = user.teacherProfile || {};

      const modal = createModal('ç®¡ç†æ•™å¸«æª”æ¡ˆ', `
        <div class="form-grid">
          <div>
            <label>æ•™å­¸ç¶“é©—å¹´æ•¸</label>
            <input id="edit-teacher-experience" type="number" min="0" value="${profile.experienceYears || ''}" />
          </div>
          <div>
            <label>é–‹å§‹æ•™å­¸å¹´ä»½</label>
            <input id="edit-teacher-since" type="number" min="1990" value="${profile.experienceSince || ''}" />
          </div>
          <div>
            <label>æ¯30åˆ†é˜åƒ¹æ ¼(USD)</label>
            <input id="edit-teacher-price" type="number" min="0" step="0.01" value="${profile.unitPriceUsd || ''}" />
          </div>
        </div>
        <div>
          <label>æ•™å¸«ä»‹ç´¹</label>
          <textarea id="edit-teacher-intro">${profile.intro || ''}</textarea>
        </div>
        <div>
          <label>è­‰æ›¸è³‡è¨Š (é€—è™Ÿåˆ†éš”)</label>
          <textarea id="edit-teacher-certifications">${(profile.certifications || []).join(', ')}</textarea>
        </div>
        <div class="form-grid">
          <div>
            <label>æ•™å­¸é ˜åŸŸ (é€—è™Ÿåˆ†éš”)</label>
            <input id="edit-teacher-domains" value="${(profile.domains || []).join(', ')}" />
          </div>
          <div>
            <label>æ•™å­¸åœ°å€ (é€—è™Ÿåˆ†éš”)</label>
            <input id="edit-teacher-regions" value="${(profile.regions || []).join(', ')}" />
          </div>
          <div>
            <label>èªè¨€èƒ½åŠ› (é€—è™Ÿåˆ†éš”)</label>
            <input id="edit-teacher-languages" value="${(profile.languages || []).join(', ')}" />
          </div>
        </div>
        <div>
          <label>æœƒè­°åå¥½</label>
          <textarea id="edit-teacher-meeting">${profile.meetingPreference ? JSON.stringify(profile.meetingPreference) : ''}</textarea>
        </div>
      `, [
        {
          text: 'å„²å­˜æª”æ¡ˆ',
          class: 'primary',
          onclick: () => saveTeacherProfile(user.id)
        },
        {
          text: 'ç®¡ç†ç›¸ç°¿',
          onclick: () => manageTeacherGallery(user.id)
        },
        {
          text: 'å–æ¶ˆ',
          onclick: () => closeModal()
        }
      ]);

      openModal(modal);
    }

    async function saveTeacherProfile(teacherId) {
      const domains = $('#edit-teacher-domains').value.trim();
      const regions = $('#edit-teacher-regions').value.trim();
      const languages = $('#edit-teacher-languages').value.trim();
      const certifications = $('#edit-teacher-certifications').value.trim();

      const profileData = {
        intro: $('#edit-teacher-intro').value.trim() || undefined,
        certifications: certifications ? certifications.split(',').map(s => s.trim()) : undefined,
        experienceYears: parseInt($('#edit-teacher-experience').value) || undefined,
        experienceSince: parseInt($('#edit-teacher-since').value) || undefined,
        unitPriceUsd: parseFloat($('#edit-teacher-price').value) || undefined,
        meetingPreference: (() => {
          const value = $('#edit-teacher-meeting').value.trim();
          if (!value) return undefined;
          try {
            return JSON.parse(value);
          } catch {
            return { mode: 'zoom_personal', defaultUrl: value };
          }
        })(),
        domains: domains ? domains.split(',').map(s => s.trim()) : undefined,
        regions: regions ? regions.split(',').map(s => s.trim()) : undefined,
        languages: languages ? languages.split(',').map(s => s.trim()) : undefined
      };

      try {
        await apiRequest(`/admin/teachers/${teacherId}/profile`, {
          method: 'PUT',
          body: JSON.stringify(profileData)
        });

        toast('æ•™å¸«æª”æ¡ˆæ›´æ–°æˆåŠŸ');
        closeModal();
      } catch (error) {
        toast('æ›´æ–°å¤±æ•—ï¼š' + error.message);
      }
    }

    async function manageTeacherGallery(teacherId) {
      // é€™è£¡å¯ä»¥å¯¦ç¾æ•™å¸«ç›¸ç°¿ç®¡ç†åŠŸèƒ½
      toast('æ•™å¸«ç›¸ç°¿ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...');
    }

    async function loadSystemStats() {
      try {
        // è¼‰å…¥ç”¨æˆ¶çµ±è¨ˆ
        const usersResponse = await apiRequest('/admin/users?pageSize=1');
        const userStats = `
          <div class="stat-item">
            <div class="stat-number">${usersResponse.total}</div>
            <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
          </div>
        `;
        $('#user-stats').innerHTML = userStats;

        // è¼‰å…¥é ç´„çµ±è¨ˆ
        const bookingsResponse = await apiRequest('/admin/bookings');
        const bookingStats = `
          <div class="stat-item">
            <div class="stat-number">${bookingsResponse.total || 0}</div>
            <div class="stat-label">ç¸½é ç´„æ•¸</div>
          </div>
        `;
        $('#booking-stats').innerHTML = bookingStats;

        // ç³»çµ±ç‹€æ…‹
        const systemStats = `
          <div class="stat-item">
            <div class="stat-number">æ­£å¸¸</div>
            <div class="stat-label">ç³»çµ±ç‹€æ…‹</div>
          </div>
        `;
        $('#system-stats').innerHTML = systemStats;

      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
      }
    }

    // å¡ç‰‡ç®¡ç†
    async function renderPurchases() {
      showOnly('view-purchases');
      const wrap = $("#view-purchases");
      wrap.innerHTML = '';

      // æ­¡è¿æ©«å¹…
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, 'æˆ‘çš„å¡ç‰‡'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, 'ç®¡ç†æ‚¨çš„èª²ç¨‹å¡ç‰‡å’Œæ¿€æ´»ç‹€æ…‹')
      ));

      try {
        const response = await apiRequest('/purchases');
        const purchases = response.items || [];

        if (purchases.length === 0) {
          wrap.appendChild(el('div', {class: 'empty-state'},
            el('div', {class: 'empty-icon'}, 'ğŸ’³'),
            el('h3', {}, 'æš«ç„¡å¡ç‰‡'),
            el('p', {}, 'æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•èª²ç¨‹å¡ç‰‡')
          ));
          return;
        }

        // æŒ‰ç‹€æ…‹åˆ†çµ„é¡¯ç¤º
        const activeCards = purchases.filter(p => p.status === 'active' && !p.isExpired);
        const draftCards = purchases.filter(p => p.status === 'draft');
        const expiredCards = purchases.filter(p => p.status === 'expired' || p.isExpired);
        const consumedCards = purchases.filter(p => p.status === 'consumed');

        // å¯ç”¨å¡ç‰‡
        if (activeCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, 'å¯ç”¨å¡ç‰‡'),
            el('div', {class: 'cards-grid'},
              ...activeCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // å¾…æ¿€æ´»å¡ç‰‡
        if (draftCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, 'å¾…æ¿€æ´»å¡ç‰‡'),
            el('div', {class: 'cards-grid'},
              ...draftCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // å·²éæœŸå¡ç‰‡
        if (expiredCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, 'å·²éæœŸå¡ç‰‡'),
            el('div', {class: 'cards-grid'},
              ...expiredCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // å·²ç”¨å®Œå¡ç‰‡
        if (consumedCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, 'å·²ç”¨å®Œå¡ç‰‡'),
            el('div', {class: 'cards-grid'},
              ...consumedCards.map(card => createPurchaseCard(card))
            )
          ));
        }

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, 'è¼‰å…¥å¤±æ•—'),
          el('p', {}, error.message)
        ));
      }
    }

    function createPurchaseCard(purchase) {
      const isActive = purchase.status === 'active' && !purchase.isExpired;
      const canActivate = purchase.canActivate;

      return el('div', {class: `purchase-card ${purchase.status}`},
        el('div', {class: 'card-header'},
          el('h3', {}, purchase.packageName),
          getPurchaseStatusChip(purchase)
        ),
        el('div', {class: 'card-body'},
          el('div', {class: 'card-info'},
            el('div', {class: 'info-item'},
              el('label', {}, 'é¡å‹'),
              el('span', {}, getPurchaseTypeText(purchase.type))
            ),
            el('div', {class: 'info-item'},
              el('label', {}, 'æ•¸é‡'),
              el('span', {}, `${purchase.remaining}/${purchase.quantity}`)
            ),
            purchase.activatedAt ? el('div', {class: 'info-item'},
              el('label', {}, 'æ¿€æ´»æ™‚é–“'),
              el('span', {}, fmtDate(purchase.activatedAt))
            ) : null,
            purchase.expiresAt ? el('div', {class: 'info-item'},
              el('label', {}, 'éæœŸæ™‚é–“'),
              el('span', {}, fmtDate(purchase.expiresAt))
            ) : null
          ),
          purchase.notes ? el('div', {class: 'card-notes'}, purchase.notes) : null
        ),
        el('div', {class: 'card-actions'},
          canActivate ?
            el('button', {class: 'btn primary', onclick: () => activatePurchase(purchase.id)}, 'æ¿€æ´»') :
            null,
          el('button', {class: 'btn small', onclick: () => showPurchaseDetails(purchase)}, 'è©³æƒ…')
        )
      );
    }

    function getPurchaseStatusChip(purchase) {
      const statusMap = {
        'draft': { text: 'å¾…æ¿€æ´»', class: 'status-pending' },
        'active': { text: purchase.isExpired ? 'å·²éæœŸ' : 'å¯ç”¨', class: purchase.isExpired ? 'status-canceled' : 'status-scheduled' },
        'expired': { text: 'å·²éæœŸ', class: 'status-canceled' },
        'consumed': { text: 'å·²ç”¨å®Œ', class: 'status-completed' }
      };

      const statusInfo = statusMap[purchase.status] || { text: purchase.status, class: 'status-pending' };
      return el('span', {class: `status-chip ${statusInfo.class}`}, statusInfo.text);
    }

    function getPurchaseTypeText(type) {
      const typeMap = {
        'lesson_card': 'ç´„èª²æ¬¡å¡',
        'trial_card': 'é«”é©—æ¬¡å¡',
        'compensation_card': 'è£œå„Ÿæ¬¡å¡',
        'cancel_card': 'å–æ¶ˆç´„èª²æ¬¡å¡'
      };
      return typeMap[type] || type;
    }

    async function activatePurchase(purchaseId) {
      if (!confirm('ç¢ºå®šè¦æ¿€æ´»é€™å¼µå¡ç‰‡å—ï¼Ÿ\n\næ¿€æ´»å¾Œå°‡é–‹å§‹è¨ˆç®—éæœŸæ™‚é–“ã€‚')) {
        return;
      }

      try {
        await apiRequest(`/purchases/${purchaseId}/activate`, {
          method: 'POST',
          body: JSON.stringify({})
        });

        toast('å¡ç‰‡æ¿€æ´»æˆåŠŸ', 'success');
        renderPurchases(); // é‡æ–°è¼‰å…¥
      } catch (error) {
        toast('æ¿€æ´»å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    function showPurchaseDetails(purchase) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'å¡ç‰‡è©³æƒ…'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'å¥—é¤åç¨±'),
            el('div', {}, purchase.packageName)
          ),
          el('div', {},
            el('label', {}, 'é¡å‹'),
            el('div', {}, getPurchaseTypeText(purchase.type))
          ),
          el('div', {},
            el('label', {}, 'æ•¸é‡'),
            el('div', {}, `å‰©é¤˜ ${purchase.remaining} / ç¸½å…± ${purchase.quantity}`)
          ),
          el('div', {},
            el('label', {}, 'ç‹€æ…‹'),
            el('div', {}, getPurchaseStatusChip(purchase))
          ),
          purchase.activatedAt ? el('div', {},
            el('label', {}, 'æ¿€æ´»æ™‚é–“'),
            el('div', {}, fmtDate(purchase.activatedAt))
          ) : null,
          purchase.expiresAt ? el('div', {},
            el('label', {}, 'éæœŸæ™‚é–“'),
            el('div', {}, fmtDate(purchase.expiresAt))
          ) : null
        ),
        purchase.notes ? el('div', {},
          el('label', {}, 'å‚™è¨»'),
          el('div', {class: 'muted'}, purchase.notes)
        ) : null,
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          purchase.canActivate ?
            el('button', {class: 'btn primary', onclick: () => { closeModal(); activatePurchase(purchase.id); }}, 'æ¿€æ´»') :
            null,
          el('button', {class: 'btn', onclick: closeModal}, 'é—œé–‰')
        )
      );

      openModal(modal);
    }

    // å­¸ç”Ÿè³‡æ–™é é¢
    async function renderStudentProfile() {
      showOnly('view-student');
      const wrap = $("#view-student");
      wrap.innerHTML = '';

      // æ­¡è¿æ©«å¹…
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, 'æˆ‘çš„è³‡æ–™'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, 'ç®¡ç†æ‚¨çš„å€‹äººè³‡æ–™å’Œè¨­å®š')
      ));

      try {
        // ç²å–ç”¨æˆ¶è³‡æ–™
        const user = await apiRequest(`/users/${currentUser.id}`);

        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, 'å€‹äººè³‡æ–™'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editProfile(user)}, 'ç·¨è¼¯'),
            el('button', {class: 'btn small', onclick: () => changePassword(user.id)}, 'ä¿®æ”¹å¯†ç¢¼')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'row wrap', style: 'align-items:center; gap:16px'},
            el('div', {style: 'position:relative'},
              createAvatar(user, 80, { round: true }),
              el('button', {
                class: 'btn small',
                style: 'position:absolute; bottom:-8px; right:-8px; border-radius:50%; width:32px; height:32px; padding:0; font-size:12px',
                onclick: () => uploadAvatar(user.id),
                title: 'æ›´æ›é ­åƒ'
              }, 'ğŸ“·')
            ),
            el('div', {},
              el('div', {class: 'title'}, user.name),
              el('div', {class: 'muted'}, user.email),
              user.bio ? el('div', {style: 'margin-top:8px'}, user.bio) : null
            )
          ),
          el('div', {class: 'form-grid', style: 'margin-top:16px'},
            el('div', {},
              el('label', {}, 'é›»è©±'),
              el('div', {}, user.phone || 'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'æ™‚å€'),
              el('div', {}, user.timezone || 'Asia/Taipei')
            )
          )
        ));

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, 'è¼‰å…¥å¤±æ•—'),
          el('p', {}, error.message)
        ));
      }
    }

    async function uploadAvatar(userId) {
      const input = el('input', {
        type: 'file',
        accept: 'image/*',
        style: 'display:none',
        onchange: async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // æª¢æŸ¥æ–‡ä»¶å¤§å° (5MB)
          if (file.size > 5 * 1024 * 1024) {
            toast('é ­åƒæ–‡ä»¶ä¸èƒ½è¶…é 5MB', 'error');
            return;
          }

          // é¡¯ç¤ºåœ–ç‰‡è£åˆ‡å™¨
          showImageCropper(file, userId);
        }
      });

      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }

    function showImageCropper(file, userId) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const modal = createCropperModal(img, file, userId);
          openModal(modal);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function editProfile(user) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'ç·¨è¼¯å€‹äººè³‡æ–™'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'å§“å'),
            el('input', {id: 'editName', value: user.name})
          ),
          el('div', {},
            el('label', {}, 'å€‹äººç°¡ä»‹'),
            el('textarea', {id: 'editBio', value: user.bio || '', rows: 3})
          ),
          el('div', {},
            el('label', {}, 'é›»è©±'),
            el('input', {id: 'editPhone', value: user.phone || ''})
          ),
          el('div', {},
            el('label', {}, 'æ™‚å€'),
            el('select', {id: 'editTimezone'},
              el('option', {value: 'Asia/Taipei', selected: user.timezone === 'Asia/Taipei'}, 'å°åŒ— (UTC+8)'),
              el('option', {value: 'Asia/Tokyo', selected: user.timezone === 'Asia/Tokyo'}, 'æ±äº¬ (UTC+9)'),
              el('option', {value: 'America/New_York', selected: user.timezone === 'America/New_York'}, 'ç´ç´„ (UTC-5)'),
              el('option', {value: 'Europe/London', selected: user.timezone === 'Europe/London'}, 'å€«æ•¦ (UTC+0)')
            )
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => saveProfile(user.id)}, 'å„²å­˜'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );

      openModal(modal);
    }

    async function saveProfile(userId) {
      try {
        const updateData = {
          name: $("#editName").value,
          bio: $("#editBio").value,
          phone: $("#editPhone").value,
          timezone: $("#editTimezone").value
        };

        await apiRequest(`/users/${userId}`, {
          method: 'PATCH',
          body: JSON.stringify(updateData)
        });

        closeModal();
        toast('è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
        renderStudentProfile(); // é‡æ–°è¼‰å…¥é é¢
      } catch (error) {
        toast('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    function createCropperModal(img, file, userId) {
      const canvas = el('canvas', { width: 400, height: 400 });
      const ctx = canvas.getContext('2d');
      const preview = el('canvas', { width: 100, height: 100, class: 'crop-preview' });
      const previewCtx = preview.getContext('2d');

      // è¨ˆç®—åœ–ç‰‡ç¸®æ”¾æ¯”ä¾‹ä»¥é©æ‡‰ canvas
      const scale = Math.min(400 / img.width, 400 / img.height);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      const offsetX = (400 - scaledWidth) / 2;
      const offsetY = (400 - scaledHeight) / 2;

      // è£åˆ‡å€åŸŸ (æ­£æ–¹å½¢ï¼Œå±…ä¸­)
      const cropSize = Math.min(scaledWidth, scaledHeight) * 0.8;
      let cropX = (400 - cropSize) / 2;
      let cropY = (400 - cropSize) / 2;

      function drawImage() {
        // æ¸…é™¤ canvas
        ctx.clearRect(0, 0, 400, 400);

        // ç¹ªè£½åœ–ç‰‡
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

        // ç¹ªè£½é®ç½©
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(0, 0, 400, 400);

        // æ¸…é™¤è£åˆ‡å€åŸŸ
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cropX + cropSize/2, cropY + cropSize/2, cropSize/2, 0, 2 * Math.PI);
        ctx.fill();

        // ç¹ªè£½è£åˆ‡é‚Šæ¡†
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cropX + cropSize/2, cropY + cropSize/2, cropSize/2, 0, 2 * Math.PI);
        ctx.stroke();

        // æ›´æ–°é è¦½
        updatePreview();
      }

      function updatePreview() {
        previewCtx.clearRect(0, 0, 100, 100);

        // è¨ˆç®—è£åˆ‡å€åŸŸåœ¨åŸåœ–ä¸­çš„ä½ç½®
        const originalCropX = (cropX - offsetX) / scale;
        const originalCropY = (cropY - offsetY) / scale;
        const originalCropSize = cropSize / scale;

        // ç¹ªè£½è£åˆ‡å¾Œçš„åœ–ç‰‡åˆ°é è¦½
        previewCtx.drawImage(
          img,
          originalCropX, originalCropY, originalCropSize, originalCropSize,
          0, 0, 100, 100
        );
      }

      // æ‹–æ‹½åŠŸèƒ½
      let isDragging = false;
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // æª¢æŸ¥æ˜¯å¦é»æ“Šåœ¨è£åˆ‡å€åŸŸå…§
        const centerX = cropX + cropSize/2;
        const centerY = cropY + cropSize/2;
        const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);

        if (distance <= cropSize/2) {
          isDragging = true;
        }
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // æ›´æ–°è£åˆ‡ä½ç½®ï¼Œç¢ºä¿ä¸è¶…å‡ºé‚Šç•Œ
        cropX = Math.max(0, Math.min(400 - cropSize, x - cropSize/2));
        cropY = Math.max(0, Math.min(400 - cropSize, y - cropSize/2));

        drawImage();
      });

      canvas.addEventListener('mouseup', () => {
        isDragging = false;
      });

      drawImage();

      return el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'è£åˆ‡é ­åƒ'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'text-align:center'},
          el('p', {class: 'muted'}, 'æ‹–æ‹½åœ“åœˆèª¿æ•´è£åˆ‡ä½ç½®'),
          el('div', {class: 'crop-container'}, canvas),
          el('div', {style: 'margin:16px 0'},
            el('strong', {}, 'é è¦½ï¼š'),
            el('div', {style: 'margin-top:8px'}, preview)
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {
            class: 'btn primary',
            onclick: () => cropAndUpload(canvas, cropX, cropY, cropSize, offsetX, offsetY, scale, img, file, userId)
          }, 'ç¢ºèªä¸Šå‚³'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );
    }

    async function cropAndUpload(canvas, cropX, cropY, cropSize, offsetX, offsetY, scale, img, file, userId) {
      try {
        // å‰µå»ºæœ€çµ‚çš„è£åˆ‡ canvas
        const finalCanvas = el('canvas', { width: 500, height: 500 });
        const finalCtx = finalCanvas.getContext('2d');

        // è¨ˆç®—åŸåœ–ä¸­çš„è£åˆ‡å€åŸŸ
        const originalCropX = (cropX - offsetX) / scale;
        const originalCropY = (cropY - offsetY) / scale;
        const originalCropSize = cropSize / scale;

        // ç¹ªè£½è£åˆ‡å¾Œçš„åœ–ç‰‡
        finalCtx.drawImage(
          img,
          originalCropX, originalCropY, originalCropSize, originalCropSize,
          0, 0, 500, 500
        );

        // è½‰æ›ç‚º blob
        finalCanvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append('file', blob, `avatar-${userId}.jpg`);

          await apiRequest(`/users/${userId}/avatar`, {
            method: 'POST',
            body: formData,
            headers: {} // è®“ç€è¦½å™¨è‡ªå‹•è¨­å®š Content-Type
          });

          closeModal();
          toast('é ­åƒä¸Šå‚³æˆåŠŸ', 'success');

          // é‡æ–°è¼‰å…¥é é¢
          if (currentUser.role === 'student') {
            renderStudentProfile();
          } else if (currentUser.role === 'teacher') {
            renderTeacherProfileManage();
          }
        }, 'image/jpeg', 0.9);

      } catch (error) {
        toast('ä¸Šå‚³å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // å¯†ç¢¼ä¿®æ”¹åŠŸèƒ½
    function changePassword(userId) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'ä¿®æ”¹å¯†ç¢¼'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'ç•¶å‰å¯†ç¢¼'),
            el('input', {id: 'currentPassword', type: 'password', placeholder: 'è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼'})
          ),
          el('div', {},
            el('label', {}, 'æ–°å¯†ç¢¼'),
            el('input', {id: 'newPassword', type: 'password', placeholder: 'è«‹è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘6ä½)'})
          ),
          el('div', {},
            el('label', {}, 'ç¢ºèªæ–°å¯†ç¢¼'),
            el('input', {id: 'confirmPassword', type: 'password', placeholder: 'è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼'})
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => doChangePassword(userId)}, 'ä¿®æ”¹å¯†ç¢¼'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );

      openModal(modal);
    }

    async function doChangePassword(userId) {
      const currentPassword = $("#currentPassword").value;
      const newPassword = $("#newPassword").value;
      const confirmPassword = $("#confirmPassword").value;

      if (!currentPassword || !newPassword || !confirmPassword) {
        toast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
        return;
      }

      if (newPassword.length < 6) {
        toast('æ–°å¯†ç¢¼è‡³å°‘éœ€è¦6ä½', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        toast('æ–°å¯†ç¢¼å’Œç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´', 'error');
        return;
      }

      try {
        await apiRequest(`/users/${userId}/change-password`, {
          method: 'POST',
          body: JSON.stringify({
            currentPassword,
            newPassword,
            confirmPassword
          })
        });

        closeModal();
        toast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸ', 'success');
      } catch (error) {
        toast('å¯†ç¢¼ä¿®æ”¹å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // æ•™å¸«å€‹äººè³‡æ–™ç®¡ç†é é¢
    async function renderTeacherProfileManage() {
      showOnly('view-teacher-profile-manage');
      const wrap = $("#view-teacher-profile-manage");
      wrap.innerHTML = '';

      // æ­¡è¿æ©«å¹…
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, 'æˆ‘çš„æ•™å¸«è³‡æ–™'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, 'ç®¡ç†æ‚¨çš„æ•™å¸«æª”æ¡ˆå’Œæ•™å­¸è³‡æ–™')
      ));

      try {
        // ç²å–æ•™å¸«å®Œæ•´è³‡æ–™
        const profile = await apiRequest(`/teachers/${currentUser.id}/profile`);

        // åŸºæœ¬è³‡æ–™å¡ç‰‡
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, 'åŸºæœ¬è³‡æ–™'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editProfile(profile)}, 'ç·¨è¼¯'),
            el('button', {class: 'btn small', onclick: () => changePassword(profile.id)}, 'ä¿®æ”¹å¯†ç¢¼')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'row wrap', style: 'align-items:center; gap:16px'},
            el('div', {style: 'position:relative'},
              createAvatar(profile, 80, { round: true }),
              el('button', {
                class: 'btn small',
                style: 'position:absolute; bottom:-8px; right:-8px; border-radius:50%; width:32px; height:32px; padding:0; font-size:12px',
                onclick: () => uploadAvatar(profile.id),
                title: 'æ›´æ›é ­åƒ'
              }, 'ğŸ“·')
            ),
            el('div', {},
              el('div', {class: 'title'}, profile.name),
              el('div', {class: 'muted'}, profile.email),
              profile.bio ? el('div', {style: 'margin-top:8px'}, profile.bio) : null
            )
          ),
          el('div', {class: 'form-grid', style: 'margin-top:16px'},
            el('div', {},
              el('label', {}, 'é›»è©±'),
              el('div', {}, profile.phone || 'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'æ™‚å€'),
              el('div', {}, profile.timezone || 'Asia/Taipei')
            )
          )
        ));

        // æ•™å¸«å°ˆæ¥­è³‡æ–™å¡ç‰‡
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, 'æ•™å¸«è³‡æ–™'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editTeacherProfile(profile)}, 'ç·¨è¼¯')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'form-grid'},
            el('div', {},
              el('label', {}, 'æ•™å­¸ç¶“é©—'),
              el('div', {}, profile.experienceSince ?
                `å¾ ${profile.experienceSince} å¹´é–‹å§‹ (${profile.experienceYears} å¹´ç¶“é©—)` :
                'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'æ™‚è–ª'),
              el('div', {}, `$${profile.hourlyRate || 0} USD`)
            ),
            el('div', {},
              el('label', {}, 'æ•™å­¸åœ°å€'),
              el('div', {}, profile.region || 'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'å¯æ•™æˆèªè¨€'),
              el('div', {}, profile.languages?.join(', ') || 'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'æ•™å­¸é ˜åŸŸ'),
              el('div', {}, profile.domains?.join(', ') || 'æœªè¨­å®š')
            ),
            el('div', {},
              el('label', {}, 'è©•åˆ†'),
              el('div', {}, `${profile.rating || 0} åˆ† (${profile.ratingsCount || 0} è©•åƒ¹)`)
            )
          ),
          profile.introduction ? el('div', {style: 'margin-top:16px'},
            el('label', {}, 'è‡ªæˆ‘ä»‹ç´¹'),
            el('div', {style: 'margin-top:4px; padding:12px; background:#f9fafb; border-radius:8px'},
              profile.introduction)
          ) : null,
          profile.certificates ? el('div', {style: 'margin-top:16px'},
            el('label', {}, 'è­‰æ›¸è³‡è¨Š'),
            el('div', {style: 'margin-top:4px; padding:12px; background:#f9fafb; border-radius:8px'},
              profile.certificates)
          ) : null
        ));

        // æ•™å¸«ç›¸ç°¿
        renderTeacherGallery(profile.id);

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, 'è¼‰å…¥å¤±æ•—'),
          el('p', {}, error.message)
        ));
      }
    }

    function editTeacherProfile(profile) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, 'ç·¨è¼¯æ•™å¸«è³‡æ–™'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'è‡ªæˆ‘ä»‹ç´¹'),
            el('textarea', {id: 'editIntroduction', value: profile.introduction || '', rows: 4, placeholder: 'è«‹ä»‹ç´¹æ‚¨çš„æ•™å­¸ç†å¿µå’Œç¶“é©—'})
          ),
          el('div', {},
            el('label', {}, 'è­‰æ›¸è³‡è¨Š'),
            el('textarea', {id: 'editCertificates', value: profile.certificates || '', rows: 3, placeholder: 'è«‹åˆ—å‡ºæ‚¨çš„æ•™å­¸ç›¸é—œè­‰æ›¸'})
          ),
          el('div', {},
            el('label', {}, 'é–‹å§‹æ•™å­¸å¹´ä»½'),
            el('input', {id: 'editExperienceSince', type: 'number', value: profile.experienceSince || '', min: 1990, max: new Date().getFullYear(), placeholder: 'ä¾‹å¦‚ï¼š2020'})
          ),
          el('div', {},
            el('label', {}, 'æ™‚è–ª (USD)'),
            el('input', {id: 'editHourlyRate', type: 'number', value: profile.hourlyRate || '', min: 0, step: 0.5, placeholder: 'ä¾‹å¦‚ï¼š25'})
          ),
          el('div', {},
            el('label', {}, 'æ•™å­¸åœ°å€'),
            el('input', {id: 'editRegion', value: profile.region || '', placeholder: 'ä¾‹å¦‚ï¼šå°åŒ—å¸‚'})
          ),
          el('div', {},
            el('label', {}, 'å¯æ•™æˆèªè¨€ (ç”¨é€—è™Ÿåˆ†éš”)'),
            el('input', {id: 'editLanguages', value: profile.languages?.join(', ') || '', placeholder: 'ä¾‹å¦‚ï¼šä¸­æ–‡, è‹±æ–‡, æ—¥æ–‡'})
          ),
          el('div', {},
            el('label', {}, 'æ•™å­¸é ˜åŸŸ (ç”¨é€—è™Ÿåˆ†éš”)'),
            el('input', {id: 'editDomains', value: profile.domains?.join(', ') || '', placeholder: 'ä¾‹å¦‚ï¼šè‹±èªæœƒè©±, å•†å‹™è‹±èª, è€ƒè©¦æº–å‚™'})
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => saveTeacherProfile(profile.id)}, 'å„²å­˜'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );

      openModal(modal);
    }

    async function saveTeacherProfile(teacherId) {
      try {
        const updateData = {
          introduction: $("#editIntroduction").value,
          certificates: $("#editCertificates").value,
          experienceSince: parseInt($("#editExperienceSince").value) || undefined,
          hourlyRate: parseFloat($("#editHourlyRate").value) || undefined,
          region: $("#editRegion").value,
          languages: $("#editLanguages").value.split(',').map(s => s.trim()).filter(s => s),
          domains: $("#editDomains").value.split(',').map(s => s.trim()).filter(s => s)
        };

        await apiRequest(`/teachers/${teacherId}/profile`, {
          method: 'PUT',
          body: JSON.stringify(updateData)
        });

        closeModal();
        toast('æ•™å¸«è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
        renderTeacherProfileManage(); // é‡æ–°è¼‰å…¥é é¢
      } catch (error) {
        toast('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // æ•™å¸«ç›¸ç°¿åŠŸèƒ½
    async function renderTeacherGallery(teacherId) {
      const wrap = $("#view-teacher-profile-manage");

      try {
        const gallery = await apiRequest(`/teachers/${teacherId}/gallery`);

        const galleryCard = el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, 'æ•™å¸«ç›¸ç°¿'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => uploadGalleryFile(teacherId)}, 'ä¸Šå‚³æª”æ¡ˆ')
          ),
          el('div', {class: 'hr'}),
          gallery.items.length > 0 ?
            el('div', {class: 'gallery-grid'},
              ...gallery.items.map(item => createGalleryItem(item))
            ) :
            el('div', {class: 'subtle', style: 'text-align:center; padding:40px'},
              el('div', {style: 'font-size:48px; margin-bottom:16px'}, 'ğŸ“'),
              el('div', {class: 'muted'}, 'é‚„æ²’æœ‰ä¸Šå‚³ä»»ä½•æª”æ¡ˆ'),
              el('button', {class: 'btn primary', style: 'margin-top:16px', onclick: () => uploadGalleryFile(teacherId)}, 'ä¸Šå‚³ç¬¬ä¸€å€‹æª”æ¡ˆ')
            )
        );

        wrap.appendChild(galleryCard);

      } catch (error) {
        console.error('è¼‰å…¥ç›¸ç°¿å¤±æ•—:', error);
      }
    }

    function createGalleryItem(item) {
      const container = el('div', {class: 'gallery-item'});

      if (item.type === 'image') {
        container.appendChild(el('img', {
          src: item.url,
          alt: item.filename,
          onclick: () => viewGalleryItem(item)
        }));
      } else if (item.type === 'video') {
        container.appendChild(el('video', {
          src: item.url,
          onclick: () => viewGalleryItem(item)
        }));
        container.appendChild(el('div', {class: 'play-btn'}, 'â–¶'));
      } else if (item.type === 'audio') {
        container.appendChild(el('div', {
          style: 'background:#f3f4f6; display:grid; place-items:center; height:100%; font-size:48px',
          onclick: () => viewGalleryItem(item)
        }, 'ğŸµ'));
        container.appendChild(el('div', {class: 'play-btn'}, 'â–¶'));
      } else {
        container.appendChild(el('div', {
          style: 'background:#f3f4f6; display:grid; place-items:center; height:100%; font-size:48px',
          onclick: () => viewGalleryItem(item)
        }, 'ğŸ“„'));
      }

      return container;
    }

    function viewGalleryItem(item) {
      let content;

      if (item.type === 'image') {
        content = el('img', {
          src: item.url,
          style: 'max-width:100%; max-height:70vh; object-fit:contain'
        });
      } else if (item.type === 'video') {
        content = el('video', {
          src: item.url,
          controls: true,
          style: 'max-width:100%; max-height:70vh'
        });
      } else if (item.type === 'audio') {
        content = el('div', {style: 'text-align:center; padding:40px'},
          el('div', {style: 'font-size:64px; margin-bottom:16px'}, 'ğŸµ'),
          el('audio', {
            src: item.url,
            controls: true,
            style: 'width:100%; max-width:400px'
          })
        );
      } else {
        content = el('div', {style: 'text-align:center; padding:40px'},
          el('div', {style: 'font-size:64px; margin-bottom:16px'}, 'ğŸ“„'),
          el('p', {}, 'ç„¡æ³•é è¦½æ­¤æª”æ¡ˆé¡å‹'),
          el('a', {href: item.url, target: '_blank', class: 'btn primary'}, 'ä¸‹è¼‰æª”æ¡ˆ')
        );
      }

      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, item.filename),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'text-align:center'}, content)
      );

      openModal(modal);
    }

    async function uploadGalleryFile(teacherId) {
      const input = el('input', {
        type: 'file',
        accept: 'image/*,video/*,audio/*',
        style: 'display:none',
        onchange: async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // æª¢æŸ¥æ–‡ä»¶å¤§å° (10MB)
          if (file.size > 10 * 1024 * 1024) {
            toast('æª”æ¡ˆä¸èƒ½è¶…é 10MB', 'error');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('file', file);

            await apiRequest(`/teachers/${teacherId}/gallery`, {
              method: 'POST',
              body: formData,
              headers: {} // è®“ç€è¦½å™¨è‡ªå‹•è¨­å®š Content-Type
            });

            toast('æª”æ¡ˆä¸Šå‚³æˆåŠŸ', 'success');
            renderTeacherProfileManage(); // é‡æ–°è¼‰å…¥é é¢
          } catch (error) {
            toast('ä¸Šå‚³å¤±æ•—ï¼š' + error.message, 'error');
          }
        }
      });

      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }
  </script>
</body>
</html>
