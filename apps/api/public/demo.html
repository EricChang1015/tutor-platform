<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>家教系統 Demo</title>
  <style>
    /* Light theme */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --muted:#6b7280; --text:#111827;
      --brand:#2563eb; --brand-2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ok:#10b981; --border:#e5e7eb; --chip:#f3f4f6; --chip-2:#eef2ff;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji",
      "Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border); z-index:10;
    }
    .nav{display:flex; align-items:center; gap:12px; padding:10px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; color:#0b1420}
    .logo-badge{
      width:34px; height:34px; border-radius:8px; display:grid; place-items:center;
      color:#fff; background:linear-gradient(135deg,#22c55e,#16a34a); font-size:18px; font-weight:900;
      box-shadow:0 6px 16px rgba(34,197,94,.35), inset 0 0 10px rgba(255,255,255,.3);
    }
    .spacer{flex:1}
    .tabbar{display:flex; gap:6px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
      color:#374151; cursor:pointer; transition:.2s; font-size:14px;
    }
    .tab.active{background:#e8f5ff; border-color:#cde6ff; color:#0b4ea2}
    .search{display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border);
      padding:6px 10px; border-radius:12px; min-width:220px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:#111827}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#ffffff; color:#111827; cursor:pointer; transition:.15s;
      box-shadow:0 2px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; border-color:transparent; font-weight:700}
    .btn.success{background:linear-gradient(135deg,#34d399,#10b981); color:#fff; border:0; font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3b2700; border:0; font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#fda4a4,#ef4444); color:#fff; border:0; font-weight:700}
    .btn.ghost{background:#f3f4f6}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:13px}
    .btn.icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af; border:1px solid #e0e7ff}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--border); font-size:12px}
    /* 時區選擇器樣式 */
    .timezone-selector{
      display:flex; align-items:center; gap:8px; background:#f0f9ff; border:1px solid #bae6fd;
      padding:8px 12px; border-radius:12px; margin:8px 0;
    }
    .timezone-selector select{
      background:white; border:1px solid #cbd5e1; border-radius:8px; padding:4px 8px;
      font-size:13px; color:#374151;
    }
    .timezone-info{
      font-size:12px; color:#0369a1; margin-left:8px;
    }
    .row{display:flex; gap:12px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .subtle{
      background:#f9fafb; border:1px dashed var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .title{font-size:18px; font-weight:800; margin:8px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#e5e7eb,transparent); margin:12px 0}
    /* Avatars */
    .avatar{
      width:54px; height:54px; border-radius:14px; background:linear-gradient(135deg,#e5f9f0,#d1fae5); border:1px solid var(--border);
      display:grid; place-items:center; font-weight:900; color:#065f46; overflow:hidden;
    }
    .avatar.sm{width:36px; height:36px; border-radius:10px; font-size:14px}
    .avatar.round{border-radius:50%}
    .avatar img{width:100%; height:100%; object-fit:cover}

    /* 圖片裁切器 */
    .crop-container{
      position:relative; max-width:400px; margin:16px auto;
    }
    .crop-preview{
      width:100px; height:100px; border-radius:50%; overflow:hidden; border:2px solid var(--border);
      margin:16px auto; background:#f3f4f6;
    }
    .crop-preview img{width:100%; height:100%; object-fit:cover}

    /* 表單樣式 */
    .form-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}
    .form-grid label{display:block; font-weight:600; margin-bottom:4px; color:#374151}
    .form-grid input, .form-grid textarea, .form-grid select{
      width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:8px;
      background:white; font-size:14px;
    }
    .form-grid input:focus, .form-grid textarea:focus, .form-grid select:focus{
      outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,0.1);
    }

    /* 檔案上傳區域 */
    .upload-area{
      border:2px dashed var(--border); border-radius:12px; padding:24px; text-align:center;
      background:#f9fafb; cursor:pointer; transition:.2s;
    }
    .upload-area:hover{border-color:var(--brand); background:#f0f9ff}
    .upload-area.dragover{border-color:var(--brand); background:#e0f2fe}

    /* 相簿網格 */
    .gallery-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px}
    .gallery-item{
      aspect-ratio:1; border-radius:12px; overflow:hidden; border:1px solid var(--border);
      position:relative; cursor:pointer; transition:.2s;
    }
    .gallery-item:hover{transform:scale(1.02); box-shadow:var(--shadow)}
    .gallery-item img, .gallery-item video{width:100%; height:100%; object-fit:cover}
    .gallery-item .play-btn{
      position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
      background:rgba(0,0,0,0.7); color:white; border-radius:50%; width:40px; height:40px;
      display:grid; place-items:center; font-size:16px;
    }
    /* Layout */
    main{padding:10px}
    section[hidden]{display:none !important}
    /* Teacher cards */
    .teacher-card{display:flex; gap:12px}
    .teacher-card .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    /* Materials */
    .materials{display:grid; grid-template-columns:280px 1fr; gap:14px}
    .tree{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:10px; max-height:60vh; overflow:auto}
    .tree ul{list-style:none; padding-left:12px; margin:0}
    .tree li{margin:6px 0}
    .tree .node{display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; cursor:pointer}
    .tree .node.active{background:#eef2ff; border:1px solid #e0e7ff}
    .node .icon{width:22px; text-align:center}
    .content-pane{min-height:320px}
    .pdf{background:#f9fafb; border-radius:10px; padding:20px; border:1px solid var(--border)}
    /* Schedule */
    .date-strip{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .date-pill{min-width:110px; text-align:center; padding:8px; border-radius:12px; background:#f3f4f6; border:1px solid var(--border); cursor:pointer}
    .date-pill.active{background:#e0f2fe; border-color:#bae6fd}
    .slots{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .slot{padding:10px; border-radius:10px; border:1px solid var(--border); background:#ffffff; text-align:center; cursor:pointer; transition:all 0.2s; font-size:14px}
    .slot:hover:not(.busy){background:#f0f9ff; border-color:#0ea5e9}
    .slot.busy{opacity:.45; text-decoration:line-through; cursor:not-allowed; background:#fef2f2}
    .slot.selected{outline:2px solid var(--brand); background:#e0f2fe}
    /* Calendar */
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{border:1px solid var(--border); background:#ffffff; min-height:80px; border-radius:10px; padding:6px; position:relative}
    .cal-cell .dot{position:absolute; right:8px; bottom:6px; width:8px; height:8px; border-radius:50%}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#6b7280; text-align:center}
    .dot-blue{background:#3b82f6} .dot-orange{background:#f59e0b} .dot-gray{background:#6b7280}
    /* Modal & Toast */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:20; padding:20px; overflow-y:auto}
    .modal{background:var(--surface); border:1px solid var(--border); border-radius:16px; width:min(560px,92vw); max-height:90vh; padding:18px; box-shadow:var(--shadow); overflow-y:auto; margin:auto}
    .toast{position:fixed; right:14px; bottom:14px; background:var(--surface); border:1px solid var(--border); padding:12px 14px; border-radius:12px; z-index:30; box-shadow:var(--shadow); max-width:400px; word-wrap:break-word}
    .toast.error{background:#fef2f2; border-color:#fecaca; color:#dc2626}
    .toast.success{background:#f0fdf4; border-color:#bbf7d0; color:#16a34a}
    .toast.warning{background:#fffbeb; border-color:#fed7aa; color:#d97706}
    /* Forms */
    label{font-size:13px; color:#6b7280}
    input,select,textarea{
      width:100%; background:#ffffff; color:#111827;
      border:1px solid var(--border); border-radius:10px; padding:10px; outline:none
    }
    textarea{min-height:80px; resize:vertical}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid > div{display:flex; flex-direction:column; gap:6px}
    /* Lists & tables */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:10px; background:#ffffff}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th{font-size:12px; text-transform:uppercase; color:#6b7280; background:#f9fafb; border-bottom:1px solid var(--border)}
    th, td{padding:12px; text-align:left}
    tr{border-bottom:1px solid var(--border)}
    tr:hover td{background:#fafafa}
    .hidden{display:none !important}
    /* Responsive */
    @media (max-width: 900px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .materials{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .cards-grid{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr))}
    }
    @media (max-width: 560px){
      .grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .slots{grid-template-columns:1fr; max-height:300px; overflow-y:auto}
      .search{min-width:unset; width:100%}
      .tabbar{width:100%; overflow:auto}
      th:nth-child(3), td:nth-child(3){white-space:nowrap}
      .modal{width:95vw; max-height:85vh; padding:16px}
      .date-strip{flex-wrap:wrap}
      .date-pill{min-width:80px; font-size:12px}
      .cards-grid{grid-template-columns:1fr}
      .teacher-card{flex-direction:column; text-align:center}
      .teacher-card .actions{justify-content:center}
      /* 改善手機端表格顯示 */
      table{font-size:14px}
      th, td{padding:8px 4px}
      .btn.small{padding:4px 8px; font-size:12px}
    }
    .hint{font-size:12px; color:#6b7280}
    .welcome{
      background:linear-gradient(90deg,#16a34a,#15803d); color:#fff; border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .status-chip{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-scheduled{background:#dbeafe; color:#1d4ed8}
    .status-canceled{background:#fee2e2; color:#dc2626}
    .status-completed{background:#dcfce7; color:#16a34a}
    .status-noshow{background:#fef3c7; color:#d97706}
    .status-pending{background:#f3f4f6; color:#6b7280}

    /* Purchase Cards */
    .cards-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px; margin-top:16px}
    .purchase-card{background:white; border-radius:8px; border:1px solid #e5e7eb; overflow:hidden; transition:all 0.2s}
    .purchase-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1); transform:translateY(-2px)}
    .purchase-card.draft{border-left:4px solid #f59e0b}
    .purchase-card.active{border-left:4px solid #10b981}
    .purchase-card.expired{border-left:4px solid #ef4444}
    .purchase-card.consumed{border-left:4px solid #6b7280}
    .card-header{padding:16px 16px 0; display:flex; justify-content:space-between; align-items:flex-start}
    .card-header h3{margin:0; font-size:16px; font-weight:600; color:#111827}
    .card-body{padding:16px}
    .card-info{display:grid; gap:8px}
    .info-item{display:flex; justify-content:space-between; align-items:center}
    .info-item label{font-size:14px; color:#6b7280; font-weight:500}
    .info-item span{font-size:14px; color:#111827; font-weight:600}
    .card-notes{margin-top:12px; padding:8px; background:#f9fafb; border-radius:4px; font-size:12px; color:#6b7280}

    /* Admin 樣式 */
    .tabs{display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:20px}
    .tab-btn{padding:12px 24px; border:none; background:none; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s}
    .tab-btn:hover{background:#f9fafb}
    .tab-btn.active{border-bottom-color:#3b82f6; color:#3b82f6; font-weight:600}

    .data-table{width:100%; border-collapse:collapse; margin-top:16px}
    .data-table th, .data-table td{padding:12px; text-align:left; border-bottom:1px solid #e5e7eb}
    .data-table th{background:#f9fafb; font-weight:600; color:#374151}
    .data-table tr:hover{background:#f9fafb}

    .badge{display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600}
    .badge.admin{background:#fef3c7; color:#d97706}
    .badge.teacher{background:#dbeafe; color:#1d4ed8}
    .badge.student{background:#dcfce7; color:#16a34a}
    .badge.success{background:#dcfce7; color:#16a34a}
    .badge.danger{background:#fee2e2; color:#dc2626}

    .btn-group{display:flex; gap:4px; flex-wrap:wrap}
    .btn-group .btn{margin:0}

    .avatar-small{width:32px; height:32px; border-radius:50%; object-fit:cover}

    .pagination{display:flex; justify-content:space-between; align-items:center; margin-top:16px; padding:16px 0}
    .pagination-info{color:#6b7280; font-size:14px}
    .pagination-buttons{display:flex; gap:4px}

    .stat-item{text-align:center}
    .stat-number{font-size:24px; font-weight:700; color:#111827}
    .stat-label{font-size:14px; color:#6b7280; margin-top:4px}

    .loading, .error, .empty{text-align:center; padding:40px; color:#6b7280}
    .error{color:#dc2626}
    .card-actions{padding:0 16px 16px; display:flex; gap:8px; justify-content:flex-end}
    .section{margin-bottom:32px}
    .section h2{margin:0 0 16px; font-size:18px; font-weight:700; color:#111827}
    .purchase-card.consumed{border-left:4px solid #6b7280}
    .card-header{padding:16px 16px 0; display:flex; justify-content:space-between; align-items:flex-start}
    .card-header h3{margin:0; font-size:16px; font-weight:600; color:#111827}
    .card-body{padding:16px}
    .card-info{display:grid; gap:8px}
    .info-item{display:flex; justify-content:space-between; align-items:center}
    .info-item label{font-size:14px; color:#6b7280; font-weight:500}
    .info-item span{font-size:14px; color:#111827; font-weight:600}
    .card-notes{margin-top:12px; padding:8px; background:#f9fafb; border-radius:4px; font-size:12px; color:#6b7280}
    .card-actions{padding:0 16px 16px; display:flex; gap:8px; justify-content:flex-end}
    .section{margin-bottom:32px}
    .section h2{margin:0 0 16px; font-size:18px; font-weight:700; color:#111827}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">TG</div>家教系統 Demo</div>
      <div class="spacer"></div>
      <div id="searchBar" class="search hidden">
        <span>🔎</span>
        <input id="globalSearch" placeholder="搜尋老師、擅長領域、地區…" />
      </div>
      <div id="tabbar" class="tabbar"></div>
      <div class="spacer"></div>
      <div id="timezone-container" class="timezone-selector hidden">
        <span>🌍</span>
        <select id="timezone-select" onchange="updateTimezone()">
          <option value="Asia/Taipei">台北</option>
          <option value="America/New_York">紐約</option>
          <option value="America/Los_Angeles">洛杉磯</option>
          <option value="Europe/London">倫敦</option>
          <option value="Europe/Paris">巴黎</option>
          <option value="Asia/Tokyo">東京</option>
          <option value="UTC">UTC</option>
        </select>
        <span id="current-time" class="timezone-info"></span>
      </div>
      <button id="notifBtn" class="btn icon hidden" title="通知">🔔<span id="notifDot" class="badge hidden">0</span></button>
      <div id="userMenu" class="row">
        <button id="resetBtn" class="btn small ghost hidden">重置 Demo</button>
        <button id="loginBtn" class="btn primary">登入</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="view-login">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">登入</div>
          <div class="muted">使用下方帳密體驗不同角色（admin / student / teacher）。</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div><label>帳號</label><input id="login-username" placeholder="admin@example.com" /></div>
            <div><label>密碼</label><input id="login-password" type="password" placeholder="password" /></div>
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button id="login-submit" class="btn success">登入</button>
            <span class="hint">初次開啟會自動建立示範資料。</span>
          </div>
          <div class="hr"></div>
          <div class="chips">
            <button class="btn small" data-demo-fill="admin">填入 admin</button>
            <button class="btn small" data-demo-fill="student">填入 student</button>
            <button class="btn small" data-demo-fill="teacher">填入 teacher</button>
          </div>
        </div>
        <div class="card">
          <div class="title">本 Demo 特色</div>
          <ul>
            <li>推薦教師：卡片清單、收藏、查看 Profile、預約。</li>
            <li>教材：資料夾樹、教材頁/模擬 PDF、從教材帶入預約。</li>
            <li>預約課表：半小時切片、留言、行事曆 .ics。</li>
            <li>我的預約：先列表、後日曆；取消/改期、評價。</li>
            <li>老師端：可用時段設定、預約列表、相簿上傳。</li>
            <li>管理端：教材管理、教師上架、評價審核。</li>
            <li>通知中心：預約/審核等事件推播。</li>
          </ul>
          <div class="subtle">
            <b>提示：</b>所有資料透過真實API提供，點「重置 Demo」可回到出廠狀態。
          </div>
        </div>
      </div>
    </section>

    <!-- Teachers -->
    <section id="view-teachers" hidden>
      <div class="row wrap">
        <div class="title">推薦教師</div>
        <span class="pill" id="courseContext">預約課程：自由對話</span>
        <div class="spacer"></div>
        <div class="row wrap">
          <select id="filter-tag" class="pill">
            <option value="">全部領域</option>
            <option>English</option>
            <option>Conversation</option>
            <option>Pronunciation</option>
            <option>IELTS</option>
          </select>
          <select id="filter-region" class="pill">
            <option value="">全部地區</option>
            <option>Taiwan</option>
          </select>
          <select id="filter-sort" class="pill">
            <option value="rating">排序：評分</option>
            <option value="exp">排序：年資</option>
            <option value="soonest">排序：最近可約</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" id="teachersGrid"></div>
    </section>

    <!-- Teacher Profile -->
    <section id="view-teacher-profile" hidden></section>

    <!-- Materials -->
    <section id="view-materials" hidden>
      <div class="row wrap">
        <div class="title">教材</div>
        <div class="spacer"></div>
        <div id="materials-actions" class="row wrap hidden">
          <button class="btn small" data-mt-action="add-folder">＋ 新增資料夾</button>
          <button class="btn small" data-mt-action="add-page">＋ 新增教材頁</button>
          <button class="btn small" data-mt-action="add-pdf">＋ 新增 PDF</button>
        </div>
      </div>
      <div class="materials">
        <div class="tree" id="materialsTree"></div>
        <div class="card content-pane" id="materialsContent"></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" hidden></section>

    <!-- Bookings -->
    <section id="view-bookings" hidden></section>

    <!-- Purchases -->
    <section id="view-purchases" hidden></section>

    <!-- Student Profile -->
    <section id="view-student" hidden></section>

    <!-- Teacher Profile Management -->
    <section id="view-teacher-profile-manage" hidden></section>

    <!-- Teacher Dashboard -->
    <section id="view-teacher-dashboard" hidden></section>

    <!-- Admin -->
    <section id="view-admin" hidden>
      <div class="container">
        <div class="title">管理員後台</div>
        <div class="subtitle">用戶管理系統</div>

        <!-- 用戶管理選項卡 -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="user-list">用戶列表</button>
          <button class="tab-btn" data-tab="create-user">新增用戶</button>
          <button class="tab-btn" data-tab="system-stats">系統統計</button>
        </div>

        <!-- 用戶列表 -->
        <div id="admin-tab-user-list" class="tab-content">
          <div class="card">
            <div class="title">用戶列表</div>

            <!-- 搜尋和篩選 -->
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
              <div>
                <label>搜尋</label>
                <input id="user-search" placeholder="姓名或Email" />
              </div>
              <div>
                <label>角色</label>
                <select id="user-role-filter">
                  <option value="">全部</option>
                  <option value="admin">管理員</option>
                  <option value="teacher">教師</option>
                  <option value="student">學生</option>
                </select>
              </div>
              <div>
                <label>狀態</label>
                <select id="user-status-filter">
                  <option value="">全部</option>
                  <option value="true">啟用</option>
                  <option value="false">停用</option>
                </select>
              </div>
              <div style="align-self: end;">
                <button class="btn primary" onclick="searchUsers()">搜尋</button>
              </div>
            </div>

            <!-- 用戶表格 -->
            <div id="users-table-container">
              <div class="loading">載入中...</div>
            </div>

            <!-- 分頁 -->
            <div id="users-pagination" class="pagination"></div>
          </div>
        </div>

        <!-- 新增用戶 -->
        <div id="admin-tab-create-user" class="tab-content" hidden>
          <div class="card">
            <div class="title">新增用戶</div>

            <div class="form-grid">
              <div>
                <label>角色 *</label>
                <select id="new-user-role" onchange="toggleTeacherFields()">
                  <option value="student">學生</option>
                  <option value="teacher">教師</option>
                  <option value="admin">管理員</option>
                </select>
              </div>
              <div>
                <label>Email *</label>
                <input id="new-user-email" type="email" placeholder="user@example.com" />
              </div>
              <div>
                <label>姓名 *</label>
                <input id="new-user-name" placeholder="用戶姓名" />
              </div>
              <div>
                <label>初始密碼</label>
                <input id="new-user-password" type="password" placeholder="留空使用預設密碼" />
              </div>
              <div>
                <label>電話</label>
                <input id="new-user-phone" placeholder="電話號碼" />
              </div>
              <div>
                <label>時區</label>
                <select id="new-user-timezone">
                  <option value="Asia/Taipei">Asia/Taipei</option>
                  <option value="UTC">UTC</option>
                  <option value="America/New_York">America/New_York</option>
                </select>
              </div>
            </div>

            <div>
              <label>個人簡介</label>
              <textarea id="new-user-bio" placeholder="個人簡介"></textarea>
            </div>

            <!-- 教師專用欄位 -->
            <div id="teacher-fields" style="display: none;">
              <div class="hr"></div>
              <div class="subtitle">教師檔案</div>

              <div class="form-grid">
                <div>
                  <label>教學經驗年數</label>
                  <input id="new-teacher-experience" type="number" min="0" placeholder="5" />
                </div>
                <div>
                  <label>開始教學年份</label>
                  <input id="new-teacher-since" type="number" min="1990" placeholder="2020" />
                </div>
                <div>
                  <label>每30分鐘價格(USD)</label>
                  <input id="new-teacher-price" type="number" min="0" step="0.01" placeholder="25.00" />
                </div>
              </div>

              <div>
                <label>教師介紹</label>
                <textarea id="new-teacher-intro" placeholder="教師自我介紹"></textarea>
              </div>

              <div>
                <label>證書資訊 (逗號分隔)</label>
                <textarea id="new-teacher-certifications" placeholder="TESOL, IELTS, TOEFL"></textarea>
              </div>

              <div class="form-grid">
                <div>
                  <label>教學領域 (逗號分隔)</label>
                  <input id="new-teacher-domains" placeholder="English, Conversation, Business" />
                </div>
                <div>
                  <label>教學地區 (逗號分隔)</label>
                  <input id="new-teacher-regions" placeholder="Taiwan, Online" />
                </div>
                <div>
                  <label>語言能力 (逗號分隔)</label>
                  <input id="new-teacher-languages" placeholder="English, Chinese" />
                </div>
              </div>
            </div>

            <div class="row" style="margin-top: 20px;">
              <button class="btn primary" onclick="createUser()">創建用戶</button>
              <button class="btn" onclick="clearCreateUserForm()">清空表單</button>
            </div>
          </div>
        </div>

        <!-- 系統統計 -->
        <div id="admin-tab-system-stats" class="tab-content" hidden>
          <div class="grid cols-3">
            <div class="card">
              <div class="title">用戶統計</div>
              <div id="user-stats">載入中...</div>
            </div>
            <div class="card">
              <div class="title">預約統計</div>
              <div id="booking-stats">載入中...</div>
            </div>
            <div class="card">
              <div class="title">系統狀態</div>
              <div id="system-stats">載入中...</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal + Toast -->
  <div id="modalHost" class="modal-backdrop hidden"><div class="modal" id="modalBox"></div></div>
  <div id="toastHost" class="toast hidden"></div>

  <script>
    // API 基礎設定
    const API_BASE = window.location.origin;
    let accessToken = '';
    let currentUser = null;
    let currentTimezone = 'Asia/Taipei';
    let DB = {
      courseContext: null,
      favorites: {},
      notifications: []
    };

    // 工具函數
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{
        if(k==='class') node.className=v;
        else if(k==='html') node.innerHTML=v;
        else if(k.startsWith('on') && typeof v==='function') node.addEventListener(k.substring(2), v);
        else if(v!==undefined) node.setAttribute(k,v);
      });
      children.forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    };

    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit', weekday:'short'});
    const fmtDateFull = d => new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const fmtDateWithTimezone = (d, timezone) => {
      const options = {
        timeZone: timezone || currentTimezone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false
      };
      return new Date(d).toLocaleString('zh-TW', options);
    };
    const toast = (msg, type = 'info')=>{
      const t=$("#toastHost");
      t.textContent=msg;
      t.className = `toast ${type}`;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), type === 'error' ? 4000 : 2200);
    };

    // 時區相關函數
    function getCurrentTimezone() {
      return currentTimezone;
    }

    function updateTimezone() {
      const select = $("#timezone-select");
      currentTimezone = select.value;
      updateCurrentTimeDisplay();
      console.log('時區已更新為:', currentTimezone);

      // 如果在預約頁面，重新載入資料
      if (current() === 'bookings') {
        renderBookings();
      }
    }

    function updateCurrentTimeDisplay() {
      const timeSpan = $("#current-time");
      if (timeSpan) {
        const now = new Date();
        const options = {
          timeZone: currentTimezone,
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        };
        const localTime = now.toLocaleString('zh-TW', options);
        timeSpan.textContent = localTime;
      }
    }

    function initializeTimezone() {
      // 嘗試檢測用戶的時區
      const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const select = $("#timezone-select");

      // 如果用戶時區在選項中，則設為預設值
      const options = Array.from(select.options);
      const userOption = options.find(option => option.value === userTimezone);
      if (userOption) {
        select.value = userTimezone;
        currentTimezone = userTimezone;
      }

      updateCurrentTimeDisplay();

      // 每分鐘更新時間顯示
      setInterval(updateCurrentTimeDisplay, 60000);
    }
    const openModal = (node)=>{ $("#modalBox").innerHTML=''; $("#modalBox").appendChild(node); $("#modalHost").classList.remove('hidden'); };
    const closeModal = ()=> $("#modalHost").classList.add('hidden');
    $("#modalHost").addEventListener('click', e=>{ if(e.target.id==='modalHost') closeModal(); });

    // 創建模態框的輔助函數
    function createModal(title, content, buttons = []) {
      const modal = document.createElement('div');

      // 標題列
      const header = document.createElement('div');
      header.className = 'row wrap';
      header.innerHTML = `
        <h3 style="margin:0">${title}</h3>
        <div class="spacer"></div>
        <button class="btn small" onclick="closeModal()">✕</button>
      `;

      // 分隔線
      const hr = document.createElement('div');
      hr.className = 'hr';

      // 內容
      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = content;

      // 按鈕列
      const buttonRow = document.createElement('div');
      buttonRow.className = 'row wrap';
      buttonRow.style.marginTop = '16px';

      buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.className = button.class || 'btn';
        btn.textContent = button.text;
        btn.onclick = button.onclick;
        buttonRow.appendChild(btn);
      });

      // 組裝模態框
      modal.appendChild(header);
      modal.appendChild(hr);
      modal.appendChild(contentDiv);
      if (buttons.length > 0) {
        modal.appendChild(buttonRow);
      }

      return modal;
    }

    // 頭像組件
    function createAvatar(user, size = 54, options = {}) {
      const { round = false, className = '' } = options;
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      const avatarClass = `avatar ${round ? 'round' : ''} ${className}`.trim();

      if (user.avatarUrl) {
        return el('div', {
          class: avatarClass,
          style: `width:${size}px; height:${size}px`,
          title: user.name
        }, el('img', {
          src: user.avatarUrl,
          alt: user.name,
          style: 'width:100%; height:100%; object-fit:cover'
        }));
      } else {
        return el('div', {
          class: avatarClass,
          style: `width:${size}px; height:${size}px`,
          title: user.name
        }, initials);
      }
    }

    function showErrorModal(title, message, actions = []) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0; color:#dc2626'}, title),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'margin:16px 0; line-height:1.5'}, message),
        actions.length > 0 ? el('div', {class: 'row wrap', style: 'margin-top:16px; gap:8px'},
          ...actions.map(action =>
            el('button', {
              class: action.primary ? 'btn primary' : 'btn',
              onclick: () => {
                closeModal();
                if (action.action) action.action();
              }
            }, action.text)
          )
        ) : el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: closeModal}, '確定')
        )
      );

      openModal(modal);
    }

    // API 請求函數
    async function apiRequest(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      const headers = {
        ...options.headers
      };

      // 只有在body不是FormData時才設置Content-Type
      if (!(options.body instanceof FormData) && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
      }

      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }

      // 調試信息
      console.log('API Request:', {
        url,
        method: options.method || 'GET',
        bodyType: options.body ? options.body.constructor.name : 'undefined',
        isFormData: options.body instanceof FormData
      });

      try {
        const response = await fetch(url, {
          ...options,
          headers
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return await response.json();
        }
        return null;
      } catch (error) {
        console.error('API Request failed:', error);
        toast('API 請求失敗: ' + error.message, 'error');
        throw error;
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      setupEventListeners();
      initializeTimezone(); // 初始化時區功能
      headerUI();
      goto('login');
    }

    function setupEventListeners() {
      // 登入相關
      $("#login-submit").addEventListener('click', doLogin);
      $("#loginBtn").addEventListener('click', () => goto('login'));
      
      // Demo 填入按鈕
      document.querySelectorAll('[data-demo-fill]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const role = e.target.dataset.demoFill;
          fillDemoCredentials(role);
        });
      });

      // Tab 導航
      $("#tabbar").addEventListener('click', (e) => {
        if (e.target.dataset.go) {
          goto(e.target.dataset.go);
        }
      });

      // 重置按鈕
      $("#resetBtn").addEventListener('click', resetDemo);
    }

    function fillDemoCredentials(role) {
      const credentials = {
        admin: { username: 'admin@example.com', password: 'password' },
        student: { username: 'student1@example.com', password: 'password' },
        teacher: { username: 'teacher1@example.com', password: 'password' }
      };

      if (credentials[role]) {
        $("#login-username").value = credentials[role].username;
        $("#login-password").value = credentials[role].password;
      }
    }

    // 路由系統
    const ROUTES = ['login','teachers','teacher-profile','materials','schedule','bookings','student','teacher-dashboard','admin'];
    const goto = (hash)=>{ location.hash = '#/'+hash; };
    const current = ()=> (location.hash.replace('#/','')||'login');

    window.addEventListener('hashchange', render);

    function render() {
      const route = current();
      showOnly('view-' + route.split('/')[0]);
      
      if (route.startsWith('teachers') && route !== 'teachers') {
        renderTeachers();
      } else if (route === 'teachers') {
        renderTeachers();
      } else if (route === 'materials') {
        renderMaterials();
      } else if (route === 'bookings') {
        renderBookings();
      } else if (route === 'purchases') {
        renderPurchases();
      } else if (route === 'student') {
        renderStudentProfile();
      } else if (route === 'teacher-profile') {
        renderTeacherProfileManage();
      } else if (route === 'admin') {
        renderAdmin();
      }
    }

    function showOnly(id) {
      ['view-login','view-teachers','view-teacher-profile','view-materials','view-schedule','view-bookings','view-purchases','view-student','view-teacher-profile-manage','view-teacher-dashboard','view-admin']
      .forEach(v => $( '#'+v ).hidden = (v!==id));
    }

    // 認證相關函數
    async function doLogin() {
      const username = $("#login-username").value;
      const password = $("#login-password").value;

      if (!username || !password) {
        toast('請輸入帳號和密碼');
        return;
      }

      try {
        const response = await apiRequest('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });

        if (response.accessToken) {
          accessToken = response.accessToken;

          // 獲取用戶信息
          const userInfo = await apiRequest('/auth/me');
          currentUser = userInfo;

          headerUI();
          goto('teachers');
          toast(`歡迎，${currentUser.name || currentUser.email}`);
        }
      } catch (error) {
        toast('登入失敗：' + error.message, 'error');
      }
    }

    async function doLogout() {
      try {
        if (accessToken) {
          await apiRequest('/auth/logout', { method: 'POST' });
        }
      } catch (error) {
        console.error('Logout error:', error);
      }

      accessToken = '';
      currentUser = null;
      headerUI();
      goto('login');
      toast('已登出');
    }

    // 頭部UI更新
    function headerUI() {
      const logged = !!currentUser;
      $("#loginBtn").classList.toggle('hidden', logged);
      $("#searchBar").classList.toggle('hidden', !logged);
      $("#notifBtn").classList.toggle('hidden', !logged);
      $("#resetBtn").classList.toggle('hidden', !logged);
      $("#timezone-container").classList.toggle('hidden', !logged);

      if (logged) {
        const menu = $("#userMenu");
        let logoutBtn = menu.querySelector('#logoutBtn');
        if (!logoutBtn) {
          logoutBtn = el('button', {id:'logoutBtn', class:'btn'}, `登出（${currentUser.name || currentUser.username}）`);
          logoutBtn.addEventListener('click', doLogout);
          menu.appendChild(logoutBtn);
        }
      } else {
        const logoutBtn = $("#userMenu").querySelector('#logoutBtn');
        if (logoutBtn) logoutBtn.remove();
      }

      navTabs();
    }

    function navTabs() {
      const role = currentUser?.role;
      const bar = $("#tabbar");
      bar.innerHTML = '';

      const addTab = (key, label, opts = {}) => {
        const b = el('button', {class:'tab', 'data-go':key}, label);
        if (current().startsWith(key)) b.classList.add('active');
        if (opts.hide) b.classList.add('hidden');
        bar.appendChild(b);
      };

      addTab('teachers', '推薦教師', {hide: !role});
      addTab('materials', '教材', {hide: !role});
      addTab('bookings', '我的預約', {hide: !role});
      addTab('purchases', '我的卡片', {hide: !role});
      if (role === 'student') addTab('student', '我的資料');
      if (role === 'teacher') {
        addTab('teacher-profile', '我的資料');
        addTab('teacher-dashboard', '老師後台');
      }
      if (role === 'admin') addTab('admin', '管理後台');
    }

    // 教師列表渲染
    async function renderTeachers() {
      showOnly('view-teachers');
      $("#courseContext").textContent = '預約課程：' + (DB.courseContext?.name || '自由對話');

      try {
        const response = await apiRequest('/teachers');
        const teachers = response.items || [];

        const grid = $("#teachersGrid");
        grid.innerHTML = '';

        teachers.forEach(teacher => {
          const card = createTeacherCard(teacher);
          grid.appendChild(card);
        });

      } catch (error) {
        console.error('Failed to load teachers:', error);
        toast('載入教師列表失敗', 'error');
      }
    }

    function createTeacherCard(teacher) {
      return el('div', {class: 'card teacher-card'},
        createAvatar(teacher, 54, { round: true }),
        el('div', {},
          el('div', {class: 'row wrap'},
            el('div', {class: 'title'}, teacher.name),
            el('span', {class: 'badge'}, `地區：${teacher.region}`),
            el('span', {class: 'badge'}, `經驗：${teacher.experienceYears} 年`),
            el('span', {class: 'badge'}, `評分：${teacher.rating}`)
          ),
          el('div', {class: 'tags'}, ...teacher.domains.map(domain => el('span', {class: 'pill'}, domain))),
          el('div', {class: 'muted'}, teacher.introSnippet || '專業教師'),
          el('div', {class: 'actions'},
            el('button', {class: 'btn small', onclick: () => openTeacherProfile(teacher.id)}, '查看 Profile'),
            el('button', {class: 'btn small primary', onclick: () => openSchedule(teacher.id)}, '預約'),
            currentUser?.role === 'student'
              ? el('button', {class: 'btn small', onclick: () => toggleFav(teacher.id)}, '☆ 收藏')
              : null
          )
        )
      );
    }

    // 教師詳情
    async function openTeacherProfile(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        renderTeacherProfile(teacher);
        goto(`teacher-profile/${teacherId}`);
      } catch (error) {
        toast('載入教師詳情失敗');
      }
    }

    function renderTeacherProfile(teacher) {
      showOnly('view-teacher-profile');
      const wrap = $("#view-teacher-profile");
      wrap.innerHTML = '';

      wrap.appendChild(el('div', {class: 'card'},
        el('div', {class: 'row wrap'},
          createAvatar(teacher),
          el('div', {},
            el('div', {class: 'title'}, teacher.name),
            el('div', {class: 'chips'},
              el('span', {class: 'badge'}, `地區：${teacher.region}`),
              el('span', {class: 'badge'}, `年資：${teacher.experienceYears} 年`),
              el('span', {class: 'badge'}, `評分：${teacher.rating}`)
            )
          ),
          el('div', {class: 'spacer'}),
          el('div', {class: 'row wrap'},
            el('button', {class: 'btn primary small', onclick: () => openSchedule(teacher.id)}, '一鍵預約'),
            el('button', {class: 'btn small', onclick: () => goto('teachers')}, '返回列表')
          )
        ),
        el('div', {class: 'tags', style: 'margin-top:6px'}, ...teacher.domains.map(x => el('span', {class: 'pill'}, x))),
        el('div', {class: 'hr'}),
        el('div', {}, el('b', {}, '自我介紹'), el('div', {class: 'muted'}, teacher.intro || '專業教師，歡迎預約課程'))
      ));
    }

    // 預約相關
    async function openSchedule(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        showScheduleModal(teacher);
      } catch (error) {
        toast('載入教師資訊失敗');
      }
    }

    function showScheduleModal(teacher) {
      const today = new Date();
      const dates = [];

      // 生成未來7天的日期
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        dates.push(date);
      }

      const modal = el('div', {style: 'max-height:90vh; overflow-y:auto'},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, `預約 ${teacher.name} 的課程`),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'muted'}, '選擇日期和時間'),
        el('div', {class: 'date-strip', id: 'dateStrip'}),
        el('div', {id: 'timeSlots', style: 'margin-top:16px; max-height:250px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px'}),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '課程標題'),
            el('input', {id: 'courseTitle', value: DB.courseContext?.name || '自由對話'})
          ),
          el('div', {},
            el('label', {}, '持續時間'),
            el('select', {id: 'duration'},
              el('option', {value: '30'}, '30分鐘'),
              el('option', {value: '60'}, '60分鐘'),
              el('option', {value: '90'}, '90分鐘')
            )
          )
        ),
        el('div', {},
          el('label', {}, '給老師的留言'),
          el('textarea', {id: 'bookingMessage', placeholder: '可以告訴老師您的學習目標或特殊需求...', rows: 3})
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px; position:sticky; bottom:0; background:white; padding-top:16px; border-top:1px solid #e5e7eb; margin-left:-18px; margin-right:-18px; padding-left:18px; padding-right:18px'},
          el('button', {class: 'btn primary', onclick: () => submitBooking(teacher.id)}, '確認預約'),
          el('button', {class: 'btn', onclick: closeModal}, '取消')
        )
      );

      openModal(modal);

      // 渲染日期選擇
      renderDateStrip(dates);

      // 預設選擇今天
      selectDate(dates[0], teacher.id);
    }

    function renderDateStrip(dates) {
      const strip = $("#dateStrip");
      strip.innerHTML = '';

      dates.forEach((date, index) => {
        const pill = el('div', {
          class: `date-pill ${index === 0 ? 'active' : ''}`,
          onclick: () => {
            document.querySelectorAll('.date-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            selectDate(date, getCurrentTeacherId());
          }
        },
          el('div', {style: 'font-weight:600'}, date.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'})),
          el('div', {style: 'font-size:12px'}, date.toLocaleDateString('zh-TW', {weekday:'short'}))
        );
        strip.appendChild(pill);
      });
    }

    function getCurrentTeacherId() {
      // 從模態框中獲取當前教師ID，這裡簡化處理
      return window.currentTeacherId;
    }

    async function selectDate(date, teacherId) {
      window.currentTeacherId = teacherId;
      window.selectedDate = date;

      const dateStr = date.toISOString().split('T')[0];

      try {
        // 獲取教師時間表（支援時區）
        const response = await fetch(`${API_BASE}/teacher-availability/teacher-timetable?teacherId=${teacherId}&date=${dateStr}&timezone=${currentTimezone}`);
        const result = await response.json();

        if (result.code === 0) {
          renderTimeSlots(result.data || []);
        } else {
          renderTimeSlots([]);
        }
      } catch (error) {
        console.error('Failed to load timetable:', error);
        renderTimeSlots([]);
      }
    }

    function renderTimeSlots(timetable) {
      const container = $("#timeSlots");
      container.innerHTML = '';

      if (timetable.length === 0) {
        container.appendChild(el('div', {class: 'muted'}, '該日期暫無可用時段'));
        return;
      }

      container.appendChild(el('div', {class: 'muted', style: 'margin-bottom:8px'}, '可用時段：'));

      const slots = el('div', {class: 'slots'});

      timetable.forEach(slot => {
        if (slot.canReserve === 1) {
          const slotEl = el('div', {
            class: 'slot',
            onclick: () => {
              document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
              slotEl.classList.add('selected');
              window.selectedTimeSlot = slot;
            }
          }, slot.time);
          slots.appendChild(slotEl);
        }
      });

      container.appendChild(slots);
    }

    async function submitBooking(teacherId) {
      if (!window.selectedDate || !window.selectedTimeSlot) {
        toast('請選擇日期和時間');
        return;
      }

      const courseTitle = $("#courseTitle").value;
      const duration = parseInt($("#duration").value);
      const message = $("#bookingMessage").value;

      // 構建預約時間（支援時區）
      const [hours, minutes] = window.selectedTimeSlot.time.split(':');
      const dateStr = window.selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD
      const timeStr = `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00`;

      // 創建時區感知的時間字串
      const timezoneOffsetStr = currentTimezone === 'Asia/Shanghai' ? '+08:00' :
                               currentTimezone === 'Asia/Taipei' ? '+08:00' :
                               currentTimezone === 'America/New_York' ? '-05:00' :
                               currentTimezone === 'America/Los_Angeles' ? '-08:00' :
                               currentTimezone === 'Europe/London' ? '+00:00' :
                               '+08:00'; // 默認

      const startsAtISO = `${dateStr}T${timeStr}${timezoneOffsetStr}`;

      const bookingData = {
        teacherId,
        startsAt: startsAtISO,
        durationMinutes: duration,
        timezone: currentTimezone,
        courseTitle,
        message,
        materialId: DB.courseContext?.id
      };

      try {
        await apiRequest('/bookings', {
          method: 'POST',
          body: JSON.stringify(bookingData)
        });

        closeModal();
        toast('預約成功！', 'success');

        // 如果在預約頁面，刷新列表
        if (current() === 'bookings') {
          renderBookings();
        }
      } catch (error) {
        console.error('Booking failed:', error);

        // 提供更詳細的錯誤信息
        let errorMessage = '預約失敗';
        if (error.message) {
          if (error.message.includes('Insufficient cards')) {
            errorMessage = '預約失敗：課卡不足，請先購買或激活課卡';
          } else if (error.message.includes('Time slot conflicts')) {
            errorMessage = '預約失敗：時間衝突，請選擇其他時間';
          } else if (error.message.includes('Teacher not found')) {
            errorMessage = '預約失敗：教師不存在';
          } else if (error.message.includes('Invalid time')) {
            errorMessage = '預約失敗：時間格式錯誤，請重新選擇';
          } else {
            errorMessage = `預約失敗：${error.message}`;
          }
        }

        // 顯示錯誤提示
        showErrorModal('預約失敗', errorMessage, [
          {text: '重新選擇時間', action: () => {}},
          {text: '查看我的卡片', action: () => {closeModal(); goto('purchases');}},
          {text: '關閉', action: () => {}}
        ]);
      }
    }

    function toggleFav(teacherId) {
      toast('收藏功能開發中...');
      // TODO: 實現收藏功能
    }

    // 取消預約
    async function cancelBooking(bookingId) {
      if (!confirm('確定要取消這個預約嗎？\n\n根據取消政策，可能會扣除取消卡或課卡。')) {
        return;
      }

      try {
        const response = await apiRequest(`/bookings/${bookingId}/cancel`, {
          method: 'POST',
          body: JSON.stringify({
            reason: '學生主動取消',
            cause: 'student_request'
          })
        });

        toast('預約已取消');

        // 顯示退款信息
        if (response.refund) {
          const refundInfo = response.refund;
          let message = '取消結果：\n';
          if (refundInfo.lessonCardsReturned > 0) {
            message += `• 退還課卡：${refundInfo.lessonCardsReturned} 張\n`;
          }
          if (refundInfo.cancelCardsConsumed > 0) {
            message += `• 扣除取消卡：${refundInfo.cancelCardsConsumed} 張\n`;
          }
          if (refundInfo.compensationGranted > 0) {
            message += `• 補償課卡：${refundInfo.compensationGranted} 張\n`;
          }
          if (refundInfo.notes) {
            message += `• 備註：${refundInfo.notes}`;
          }

          alert(message);
        }

        // 刷新預約列表
        if (current() === 'bookings') {
          renderBookings();
        }
      } catch (error) {
        toast('取消失敗：' + error.message, 'error');
      }
    }

    // 獲取狀態顯示組件
    function getStatusChip(status) {
      const statusMap = {
        'scheduled': { text: '即將開始', class: 'status-scheduled' },
        'canceled': { text: '已取消', class: 'status-canceled' },
        'completed': { text: '已完成', class: 'status-completed' },
        'noshow': { text: '未出席', class: 'status-noshow' },
        'pending': { text: '待確認', class: 'status-pending' },
        'pending_teacher': { text: '待教師確認', class: 'status-pending' }
      };

      const statusInfo = statusMap[status] || { text: status, class: 'status-pending' };
      return el('span', {class: `status-chip ${statusInfo.class}`}, statusInfo.text);
    }

    // 獲取狀態文本
    function getStatusText(status) {
      const statusMap = {
        'scheduled': '已確認',
        'canceled': '已取消',
        'completed': '已完成',
        'noshow': '未出席',
        'pending': '待確認',
        'pending_teacher': '待教師確認'
      };

      return statusMap[status] || status;
    }

    // 顯示預約詳情
    function showBookingDetails(booking) {
      const localTime = booking.startsAtLocal || fmtDateWithTimezone(booking.startsAt, currentTimezone);
      const teacherTime = booking.teacherLocalTime || fmtDateWithTimezone(booking.startsAt, booking.teacher?.timezone || 'Asia/Taipei');

      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '預約詳情'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '課程標題'),
            el('div', {}, booking.courseTitle || '自由對話')
          ),
          el('div', {},
            el('label', {}, '教師'),
            el('div', {}, booking.teacher?.name || '未知老師')
          ),
          el('div', {},
            el('label', {}, '您的時間'),
            el('div', {}, localTime)
          ),
          el('div', {},
            el('label', {}, '教師時間'),
            el('div', {}, teacherTime)
          ),
          el('div', {},
            el('label', {}, '狀態'),
            el('div', {}, getStatusText(booking.status))
          )
        ),
        booking.message ? el('div', {},
          el('label', {}, '留言'),
          el('div', {class: 'muted'}, booking.message)
        ) : null,
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          booking.canCancel !== false ?
            el('button', {class: 'btn danger', onclick: () => { closeModal(); cancelBooking(booking.id); }}, '取消預約') :
            null,
          el('button', {class: 'btn', onclick: closeModal}, '關閉')
        )
      );

      openModal(modal);
    }

    // 教材相關
    async function renderMaterials() {
      showOnly('view-materials');
      $("#materials-actions").classList.toggle('hidden', currentUser?.role !== 'admin');

      try {
        const response = await apiRequest('/materials?include=all');
        renderMaterialsTree(response.folders || []);
        renderMaterialsContent();
      } catch (error) {
        console.error('Failed to load materials:', error);
        toast('載入教材失敗');
      }
    }

    function renderMaterialsTree(folders) {
      const tree = $("#materialsTree");
      tree.innerHTML = '';

      if (!folders || folders.length === 0) {
        tree.appendChild(el('div', {class: 'muted'}, '暫無教材'));
        return;
      }

      const ul = el('ul');
      folders.forEach(folder => {
        ul.appendChild(createFolderNode(folder));
      });
      tree.appendChild(ul);
    }

    function createFolderNode(folder) {
      const li = el('li');
      const icon = '📁';
      const nodeEl = el('div', {
        class: 'node',
        onclick: () => selectMaterial(folder)
      },
        el('span', {class: 'icon'}, icon),
        el('span', {}, folder.name)
      );

      li.appendChild(nodeEl);

      // 添加子資料夾
      if (folder.children?.length) {
        const subUl = el('ul');
        folder.children.forEach(child => {
          subUl.appendChild(createFolderNode(child));
        });
        li.appendChild(subUl);
      }

      // 添加教材項目
      if (folder.materials?.length) {
        const materialsUl = el('ul');
        folder.materials.forEach(material => {
          const materialLi = el('li');
          const materialIcon = material.type === 'pdf' ? '📄' : '📝';
          const materialNode = el('div', {
            class: 'node',
            onclick: () => selectMaterial(material)
          },
            el('span', {class: 'icon'}, materialIcon),
            el('span', {}, material.title)
          );
          materialLi.appendChild(materialNode);
          materialsUl.appendChild(materialLi);
        });
        li.appendChild(materialsUl);
      }

      return li;
    }

    function selectMaterial(material) {
      // 移除之前的選中狀態
      document.querySelectorAll('.tree .node.active').forEach(node => {
        node.classList.remove('active');
      });

      // 添加當前選中狀態
      event.currentTarget.classList.add('active');

      renderMaterialsContent(material);
    }

    function renderMaterialsContent(material) {
      const pane = $("#materialsContent");
      pane.innerHTML = '';

      if (!material) {
        pane.appendChild(el('div', {class: 'title'}, '選擇教材'));
        pane.appendChild(el('div', {class: 'muted'}, '請從左側選擇教材查看內容'));
        return;
      }

      const title = material.name || material.title || '未命名';
      pane.appendChild(el('div', {class: 'title'}, title));

      if (material.name && !material.type) {
        // 這是一個資料夾
        pane.appendChild(el('div', {class: 'muted'}, '這是一個資料夾，包含多個教材項目'));
        const childCount = (material.children?.length || 0) + (material.materials?.length || 0);
        pane.appendChild(el('div', {class: 'muted'}, `包含 ${childCount} 個項目`));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn', onclick: () => selectCourseContext(material)}, '選擇此課程')
        ));
      } else {
        // 這是一個教材
        const content = material.content || '暫無內容描述';
        pane.appendChild(el('div', {class: 'muted'}, `類型：${material.type === 'pdf' ? 'PDF文件' : '教材頁面'}`));
        pane.appendChild(el('div', {class: 'hr'}));
        pane.appendChild(el('div', {class: 'card'},
          el('h4', {}, '教材內容'),
          el('p', {}, content)
        ));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn primary', onclick: () => selectCourseContext(material)}, '預約老師'),
          el('span', {class: 'hint'}, '將帶入推薦教師頁，並於預約時自動填入教材')
        ));
      }
    }

    function selectCourseContext(material) {
      const name = material.name || material.title || '未命名教材';
      DB.courseContext = {id: material.id, name: name};
      goto('teachers');
      toast('已帶入教材至預約流程');
    }

    // 預約列表
    async function renderBookings() {
      showOnly('view-bookings');
      const wrap = $("#view-bookings");
      wrap.innerHTML = '';

      // 歡迎橫幅
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, `歡迎回來，${currentUser?.name || '用戶'}！`),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, '準備好開始今天的學習之旅了嗎？')
      ));

      try {
        const response = await apiRequest(`/bookings?timezone=${currentTimezone}`);
        const bookings = response.items || [];

        // 當前預約
        const listCard = el('div', {class: 'card', style: 'margin-top:16px'},
          el('div', {class: 'row wrap'},
            el('h2', {class: 'title', style: 'margin:0'}, '當前預約'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small ghost', onclick: () => goto('teachers')}, '去預約更多')
          )
        );

        if (bookings.length === 0) {
          listCard.appendChild(el('div', {class: 'muted', style: 'padding:12px'}, '目前沒有預約課程'));
        } else {
          const table = createBookingsTable(bookings);
          listCard.appendChild(table);
        }

        wrap.appendChild(listCard);

      } catch (error) {
        console.error('Failed to load bookings:', error);
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'muted'}, '載入預約列表失敗')
        ));
      }
    }

    function createBookingsTable(bookings) {
      const table = el('table');
      const thead = el('thead', {}, el('tr', {},
        el('th', {}, '課程'),
        el('th', {}, '老師'),
        el('th', {}, '時間'),
        el('th', {}, '狀態'),
        el('th', {}, '操作')
      ));

      const tbody = el('tbody');
      bookings.forEach(booking => {
        // 顯示本地時間和教師時區時間
        const localTime = booking.startsAtLocal || fmtDateWithTimezone(booking.startsAt, currentTimezone);
        const teacherTime = booking.teacherLocalTime ?
          `教師時間: ${booking.teacherLocalTime}` :
          fmtDateWithTimezone(booking.startsAt, booking.teacher?.timezone || 'Asia/Taipei');

        const tr = el('tr', {},
          el('td', {}, booking.courseTitle || '自由對話'),
          el('td', {}, booking.teacher?.name || '未知老師'),
          el('td', {},
            el('div', {}, localTime),
            el('div', {class: 'muted', style: 'font-size:11px'}, teacherTime)
          ),
          el('td', {}, getStatusChip(booking.status)),
          el('td', {},
            el('div', {class: 'row wrap'},
              el('button', {class: 'btn small', onclick: () => showBookingDetails(booking)}, '詳情'),
              booking.canCancel !== false ?
                el('button', {class: 'btn small danger', onclick: () => cancelBooking(booking.id)}, '取消') :
                null
            )
          )
        );
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      return table;
    }

    // 重置Demo
    async function resetDemo() {
      if (!currentUser || currentUser.role !== 'admin') {
        toast('此功能需要管理員權限');
        return;
      }

      if (!confirm('確定要重置所有Demo資料嗎？')) {
        return;
      }

      try {
        await apiRequest('/admin/reset-data', { method: 'POST' });
        toast('Demo資料已重置');
      } catch (error) {
        toast('重置失敗：' + error.message);
      }
    }

    // === Admin 用戶管理功能 ===

    let currentUsersPage = 1;
    let currentUsersQuery = {};

    async function renderAdmin() {
      showOnly('view-admin');

      // 初始化選項卡
      initAdminTabs();

      // 載入用戶列表
      await loadUsers();

      // 載入統計資料
      await loadSystemStats();
    }

    function initAdminTabs() {
      const tabBtns = document.querySelectorAll('#view-admin .tab-btn');
      const tabContents = document.querySelectorAll('#view-admin .tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;

          // 更新按鈕狀態
          tabBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // 顯示對應內容
          tabContents.forEach(content => {
            content.hidden = !content.id.includes(tabName);
          });
        });
      });
    }

    async function loadUsers(page = 1) {
      currentUsersPage = page;
      const container = $('#users-table-container');
      container.innerHTML = '<div class="loading">載入中...</div>';

      try {
        const query = {
          page,
          pageSize: 20,
          ...currentUsersQuery
        };

        const queryString = new URLSearchParams(query).toString();
        const response = await apiRequest(`/admin/users?${queryString}`);

        renderUsersTable(response);
        renderUsersPagination(response);
      } catch (error) {
        container.innerHTML = `<div class="error">載入失敗: ${error.message}</div>`;
      }
    }

    function renderUsersTable(data) {
      const container = $('#users-table-container');

      if (!data.items || data.items.length === 0) {
        container.innerHTML = '<div class="empty">沒有找到用戶</div>';
        return;
      }

      const table = document.createElement('table');
      table.className = 'data-table';

      // 表頭
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>頭像</th>
          <th>姓名</th>
          <th>Email</th>
          <th>角色</th>
          <th>狀態</th>
          <th>註冊時間</th>
          <th>操作</th>
        </tr>
      `;
      table.appendChild(thead);

      // 表身
      const tbody = document.createElement('tbody');
      data.items.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <img src="${user.avatarUrl || '/default-avatar.svg'}"
                 alt="Avatar" class="avatar-small"
                 style="width: 32px; height: 32px; border-radius: 50%;" />
          </td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>
            <span class="badge ${user.role}">${getRoleText(user.role)}</span>
          </td>
          <td>
            <span class="badge ${user.active ? 'success' : 'danger'}">
              ${user.active ? '啟用' : '停用'}
            </span>
          </td>
          <td>${formatDate(user.createdAt)}</td>
          <td>
            <div class="btn-group">
              <button class="btn small" onclick="editUser('${user.id}')">編輯</button>
              <button class="btn small" onclick="resetUserPassword('${user.id}')">重置密碼</button>
              ${user.role === 'teacher' ?
                `<button class="btn small" onclick="manageTeacherProfile('${user.id}')">檔案</button>` :
                ''
              }
              <button class="btn small ${user.active ? 'danger' : 'success'}"
                      onclick="toggleUserStatus('${user.id}', ${!user.active})">
                ${user.active ? '停用' : '啟用'}
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      container.innerHTML = '';
      container.appendChild(table);
    }

    function renderUsersPagination(data) {
      const container = $('#users-pagination');

      if (data.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '<div class="pagination-info">';
      html += `顯示 ${(data.page - 1) * data.pageSize + 1}-${Math.min(data.page * data.pageSize, data.total)} `;
      html += `共 ${data.total} 筆</div>`;
      html += '<div class="pagination-buttons">';

      // 上一頁
      if (data.page > 1) {
        html += `<button class="btn small" onclick="loadUsers(${data.page - 1})">上一頁</button>`;
      }

      // 頁碼
      const startPage = Math.max(1, data.page - 2);
      const endPage = Math.min(data.totalPages, data.page + 2);

      for (let i = startPage; i <= endPage; i++) {
        const active = i === data.page ? 'primary' : '';
        html += `<button class="btn small ${active}" onclick="loadUsers(${i})">${i}</button>`;
      }

      // 下一頁
      if (data.page < data.totalPages) {
        html += `<button class="btn small" onclick="loadUsers(${data.page + 1})">下一頁</button>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    function searchUsers() {
      const search = $('#user-search').value.trim();
      const role = $('#user-role-filter').value;
      const active = $('#user-status-filter').value;

      currentUsersQuery = {};
      if (search) currentUsersQuery.search = search;
      if (role) currentUsersQuery.role = role;
      if (active !== '') currentUsersQuery.active = active;

      loadUsers(1);
    }

    function getRoleText(role) {
      const roleMap = {
        admin: '管理員',
        teacher: '教師',
        student: '學生'
      };
      return roleMap[role] || role;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('zh-TW');
    }

    function toggleTeacherFields() {
      const role = $('#new-user-role').value;
      const teacherFields = $('#teacher-fields');
      teacherFields.style.display = role === 'teacher' ? 'block' : 'none';
    }

    async function createUser() {
      const role = $('#new-user-role').value;
      const email = $('#new-user-email').value.trim();
      const name = $('#new-user-name').value.trim();

      if (!email || !name) {
        toast('請填寫必要欄位');
        return;
      }

      const userData = {
        role,
        email,
        name,
        password: $('#new-user-password').value.trim() || undefined,
        phone: $('#new-user-phone').value.trim() || undefined,
        bio: $('#new-user-bio').value.trim() || undefined,
        timezone: $('#new-user-timezone').value,
        active: true
      };

      // 如果是教師，添加教師檔案資料
      if (role === 'teacher') {
        const domains = $('#new-teacher-domains').value.trim();
        const regions = $('#new-teacher-regions').value.trim();
        const languages = $('#new-teacher-languages').value.trim();
        const certifications = $('#new-teacher-certifications').value.trim();

        Object.assign(userData, {
          intro: $('#new-teacher-intro').value.trim() || undefined,
          certifications: certifications ? certifications.split(',').map(s => s.trim()) : undefined,
          experienceYears: parseInt($('#new-teacher-experience').value) || undefined,
          experienceSince: parseInt($('#new-teacher-since').value) || undefined,
          unitPriceUsd: parseFloat($('#new-teacher-price').value) || undefined,
          domains: domains ? domains.split(',').map(s => s.trim()) : undefined,
          regions: regions ? regions.split(',').map(s => s.trim()) : undefined,
          languages: languages ? languages.split(',').map(s => s.trim()) : undefined
        });
      }

      try {
        const endpoint = role === 'teacher' ? '/admin/teachers' : '/admin/users';
        await apiRequest(endpoint, {
          method: 'POST',
          body: JSON.stringify(userData)
        });

        toast('用戶創建成功');
        clearCreateUserForm();
        loadUsers(currentUsersPage); // 重新載入用戶列表
      } catch (error) {
        toast('創建失敗：' + error.message);
      }
    }

    function clearCreateUserForm() {
      $('#new-user-role').value = 'student';
      $('#new-user-email').value = '';
      $('#new-user-name').value = '';
      $('#new-user-password').value = '';
      $('#new-user-phone').value = '';
      $('#new-user-bio').value = '';
      $('#new-user-timezone').value = 'Asia/Taipei';

      // 清空教師欄位
      $('#new-teacher-intro').value = '';
      $('#new-teacher-certifications').value = '';
      $('#new-teacher-experience').value = '';
      $('#new-teacher-since').value = '';
      $('#new-teacher-price').value = '';
      $('#new-teacher-domains').value = '';
      $('#new-teacher-regions').value = '';
      $('#new-teacher-languages').value = '';

      toggleTeacherFields();
    }

    async function editUser(userId) {
      try {
        const user = await apiRequest(`/admin/users/${userId}`);
        showEditUserModal(user);
      } catch (error) {
        toast('載入用戶資料失敗：' + error.message);
      }
    }

    function showEditUserModal(user) {
      const modal = createModal('編輯用戶', `
        <div class="form-grid">
          <div>
            <label>姓名</label>
            <input id="edit-user-name" value="${user.name}" />
          </div>
          <div>
            <label>電話</label>
            <input id="edit-user-phone" value="${user.phone || ''}" />
          </div>
          <div>
            <label>時區</label>
            <select id="edit-user-timezone">
              <option value="Asia/Taipei" ${user.timezone === 'Asia/Taipei' ? 'selected' : ''}>Asia/Taipei</option>
              <option value="UTC" ${user.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
              <option value="America/New_York" ${user.timezone === 'America/New_York' ? 'selected' : ''}>America/New_York</option>
            </select>
          </div>
          <div>
            <label>狀態</label>
            <select id="edit-user-active">
              <option value="true" ${user.active ? 'selected' : ''}>啟用</option>
              <option value="false" ${!user.active ? 'selected' : ''}>停用</option>
            </select>
          </div>
        </div>
        <div>
          <label>個人簡介</label>
          <textarea id="edit-user-bio">${user.bio || ''}</textarea>
        </div>
      `, [
        {
          text: '儲存',
          class: 'primary',
          onclick: () => saveUserEdit(user.id)
        },
        {
          text: '取消',
          onclick: () => closeModal()
        }
      ]);

      openModal(modal);
    }

    async function saveUserEdit(userId) {
      const userData = {
        name: $('#edit-user-name').value.trim(),
        phone: $('#edit-user-phone').value.trim() || undefined,
        bio: $('#edit-user-bio').value.trim() || undefined,
        timezone: $('#edit-user-timezone').value,
        active: $('#edit-user-active').value === 'true'
      };

      try {
        await apiRequest(`/admin/users/${userId}`, {
          method: 'PUT',
          body: JSON.stringify(userData)
        });

        toast('用戶資料更新成功');
        closeModal();
        loadUsers(currentUsersPage);
      } catch (error) {
        toast('更新失敗：' + error.message);
      }
    }

    async function resetUserPassword(userId) {
      const newPassword = prompt('請輸入新密碼（留空使用預設密碼 "password123"）:');
      if (newPassword === null) return; // 用戶取消

      const password = newPassword.trim() || 'password123';

      try {
        await apiRequest(`/admin/users/${userId}/reset-password`, {
          method: 'POST',
          body: JSON.stringify({
            newPassword: password,
            forceChangeOnNextLogin: false
          })
        });

        toast('密碼重置成功');
      } catch (error) {
        toast('密碼重置失敗：' + error.message);
      }
    }

    async function toggleUserStatus(userId, newStatus) {
      const action = newStatus ? '啟用' : '停用';
      if (!confirm(`確定要${action}此用戶嗎？`)) return;

      try {
        await apiRequest(`/admin/users/${userId}`, {
          method: 'PUT',
          body: JSON.stringify({ active: newStatus })
        });

        toast(`用戶${action}成功`);
        loadUsers(currentUsersPage);
      } catch (error) {
        toast(`${action}失敗：` + error.message);
      }
    }

    async function manageTeacherProfile(teacherId) {
      try {
        const user = await apiRequest(`/admin/users/${teacherId}`);
        showTeacherProfileModal(user);
      } catch (error) {
        toast('載入教師資料失敗：' + error.message);
      }
    }

    function showTeacherProfileModal(user) {
      const profile = user.teacherProfile || {};

      const modal = createModal('管理教師檔案', `
        <div class="form-grid">
          <div>
            <label>教學經驗年數</label>
            <input id="edit-teacher-experience" type="number" min="0" value="${profile.experienceYears || ''}" />
          </div>
          <div>
            <label>開始教學年份</label>
            <input id="edit-teacher-since" type="number" min="1990" value="${profile.experienceSince || ''}" />
          </div>
          <div>
            <label>每30分鐘價格(USD)</label>
            <input id="edit-teacher-price" type="number" min="0" step="0.01" value="${profile.unitPriceUsd || ''}" />
          </div>
        </div>
        <div>
          <label>教師介紹</label>
          <textarea id="edit-teacher-intro">${profile.intro || ''}</textarea>
        </div>
        <div>
          <label>證書資訊 (逗號分隔)</label>
          <textarea id="edit-teacher-certifications">${(profile.certifications || []).join(', ')}</textarea>
        </div>
        <div class="form-grid">
          <div>
            <label>教學領域 (逗號分隔)</label>
            <input id="edit-teacher-domains" value="${(profile.domains || []).join(', ')}" />
          </div>
          <div>
            <label>教學地區 (逗號分隔)</label>
            <input id="edit-teacher-regions" value="${(profile.regions || []).join(', ')}" />
          </div>
          <div>
            <label>語言能力 (逗號分隔)</label>
            <input id="edit-teacher-languages" value="${(profile.languages || []).join(', ')}" />
          </div>
        </div>
        <div>
          <label>會議偏好</label>
          <textarea id="edit-teacher-meeting">${profile.meetingPreference ? JSON.stringify(profile.meetingPreference) : ''}</textarea>
        </div>
      `, [
        {
          text: '儲存檔案',
          class: 'primary',
          onclick: () => saveTeacherProfile(user.id)
        },
        {
          text: '管理相簿',
          onclick: () => manageTeacherGallery(user.id)
        },
        {
          text: '取消',
          onclick: () => closeModal()
        }
      ]);

      openModal(modal);
    }

    async function saveTeacherProfile(teacherId) {
      const domains = $('#edit-teacher-domains').value.trim();
      const regions = $('#edit-teacher-regions').value.trim();
      const languages = $('#edit-teacher-languages').value.trim();
      const certifications = $('#edit-teacher-certifications').value.trim();

      const profileData = {
        intro: $('#edit-teacher-intro').value.trim() || undefined,
        certifications: certifications ? certifications.split(',').map(s => s.trim()) : undefined,
        experienceYears: parseInt($('#edit-teacher-experience').value) || undefined,
        experienceSince: parseInt($('#edit-teacher-since').value) || undefined,
        unitPriceUsd: parseFloat($('#edit-teacher-price').value) || undefined,
        meetingPreference: (() => {
          const value = $('#edit-teacher-meeting').value.trim();
          if (!value) return undefined;
          try {
            return JSON.parse(value);
          } catch {
            return { mode: 'zoom_personal', defaultUrl: value };
          }
        })(),
        domains: domains ? domains.split(',').map(s => s.trim()) : undefined,
        regions: regions ? regions.split(',').map(s => s.trim()) : undefined,
        languages: languages ? languages.split(',').map(s => s.trim()) : undefined
      };

      try {
        await apiRequest(`/admin/teachers/${teacherId}/profile`, {
          method: 'PUT',
          body: JSON.stringify(profileData)
        });

        toast('教師檔案更新成功');
        closeModal();
      } catch (error) {
        toast('更新失敗：' + error.message);
      }
    }

    async function manageTeacherGallery(teacherId) {
      // 這裡可以實現教師相簿管理功能
      toast('教師相簿管理功能開發中...');
    }

    async function loadSystemStats() {
      try {
        // 載入用戶統計
        const usersResponse = await apiRequest('/admin/users?pageSize=1');
        const userStats = `
          <div class="stat-item">
            <div class="stat-number">${usersResponse.total}</div>
            <div class="stat-label">總用戶數</div>
          </div>
        `;
        $('#user-stats').innerHTML = userStats;

        // 載入預約統計
        const bookingsResponse = await apiRequest('/admin/bookings');
        const bookingStats = `
          <div class="stat-item">
            <div class="stat-number">${bookingsResponse.total || 0}</div>
            <div class="stat-label">總預約數</div>
          </div>
        `;
        $('#booking-stats').innerHTML = bookingStats;

        // 系統狀態
        const systemStats = `
          <div class="stat-item">
            <div class="stat-number">正常</div>
            <div class="stat-label">系統狀態</div>
          </div>
        `;
        $('#system-stats').innerHTML = systemStats;

      } catch (error) {
        console.error('載入統計資料失敗:', error);
      }
    }

    // 卡片管理
    async function renderPurchases() {
      showOnly('view-purchases');
      const wrap = $("#view-purchases");
      wrap.innerHTML = '';

      // 歡迎橫幅
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, '我的卡片'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, '管理您的課程卡片和激活狀態')
      ));

      try {
        const response = await apiRequest('/purchases');
        const purchases = response.items || [];

        if (purchases.length === 0) {
          wrap.appendChild(el('div', {class: 'empty-state'},
            el('div', {class: 'empty-icon'}, '💳'),
            el('h3', {}, '暫無卡片'),
            el('p', {}, '您目前沒有任何課程卡片')
          ));
          return;
        }

        // 按狀態分組顯示
        const activeCards = purchases.filter(p => p.status === 'active' && !p.isExpired);
        const draftCards = purchases.filter(p => p.status === 'draft');
        const expiredCards = purchases.filter(p => p.status === 'expired' || p.isExpired);
        const consumedCards = purchases.filter(p => p.status === 'consumed');

        // 可用卡片
        if (activeCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, '可用卡片'),
            el('div', {class: 'cards-grid'},
              ...activeCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // 待激活卡片
        if (draftCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, '待激活卡片'),
            el('div', {class: 'cards-grid'},
              ...draftCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // 已過期卡片
        if (expiredCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, '已過期卡片'),
            el('div', {class: 'cards-grid'},
              ...expiredCards.map(card => createPurchaseCard(card))
            )
          ));
        }

        // 已用完卡片
        if (consumedCards.length > 0) {
          wrap.appendChild(el('div', {class: 'section'},
            el('h2', {}, '已用完卡片'),
            el('div', {class: 'cards-grid'},
              ...consumedCards.map(card => createPurchaseCard(card))
            )
          ));
        }

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, '載入失敗'),
          el('p', {}, error.message)
        ));
      }
    }

    function createPurchaseCard(purchase) {
      const isActive = purchase.status === 'active' && !purchase.isExpired;
      const canActivate = purchase.canActivate;

      return el('div', {class: `purchase-card ${purchase.status}`},
        el('div', {class: 'card-header'},
          el('h3', {}, purchase.packageName),
          getPurchaseStatusChip(purchase)
        ),
        el('div', {class: 'card-body'},
          el('div', {class: 'card-info'},
            el('div', {class: 'info-item'},
              el('label', {}, '類型'),
              el('span', {}, getPurchaseTypeText(purchase.type))
            ),
            el('div', {class: 'info-item'},
              el('label', {}, '數量'),
              el('span', {}, `${purchase.remaining}/${purchase.quantity}`)
            ),
            purchase.activatedAt ? el('div', {class: 'info-item'},
              el('label', {}, '激活時間'),
              el('span', {}, fmtDate(purchase.activatedAt))
            ) : null,
            purchase.expiresAt ? el('div', {class: 'info-item'},
              el('label', {}, '過期時間'),
              el('span', {}, fmtDate(purchase.expiresAt))
            ) : null
          ),
          purchase.notes ? el('div', {class: 'card-notes'}, purchase.notes) : null
        ),
        el('div', {class: 'card-actions'},
          canActivate ?
            el('button', {class: 'btn primary', onclick: () => activatePurchase(purchase.id)}, '激活') :
            null,
          el('button', {class: 'btn small', onclick: () => showPurchaseDetails(purchase)}, '詳情')
        )
      );
    }

    function getPurchaseStatusChip(purchase) {
      const statusMap = {
        'draft': { text: '待激活', class: 'status-pending' },
        'active': { text: purchase.isExpired ? '已過期' : '可用', class: purchase.isExpired ? 'status-canceled' : 'status-scheduled' },
        'expired': { text: '已過期', class: 'status-canceled' },
        'consumed': { text: '已用完', class: 'status-completed' }
      };

      const statusInfo = statusMap[purchase.status] || { text: purchase.status, class: 'status-pending' };
      return el('span', {class: `status-chip ${statusInfo.class}`}, statusInfo.text);
    }

    function getPurchaseTypeText(type) {
      const typeMap = {
        'lesson_card': '約課次卡',
        'trial_card': '體驗次卡',
        'compensation_card': '補償次卡',
        'cancel_card': '取消約課次卡'
      };
      return typeMap[type] || type;
    }

    async function activatePurchase(purchaseId) {
      if (!confirm('確定要激活這張卡片嗎？\n\n激活後將開始計算過期時間。')) {
        return;
      }

      try {
        await apiRequest(`/purchases/${purchaseId}/activate`, {
          method: 'POST',
          body: JSON.stringify({})
        });

        toast('卡片激活成功', 'success');
        renderPurchases(); // 重新載入
      } catch (error) {
        toast('激活失敗：' + error.message, 'error');
      }
    }

    function showPurchaseDetails(purchase) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '卡片詳情'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '套餐名稱'),
            el('div', {}, purchase.packageName)
          ),
          el('div', {},
            el('label', {}, '類型'),
            el('div', {}, getPurchaseTypeText(purchase.type))
          ),
          el('div', {},
            el('label', {}, '數量'),
            el('div', {}, `剩餘 ${purchase.remaining} / 總共 ${purchase.quantity}`)
          ),
          el('div', {},
            el('label', {}, '狀態'),
            el('div', {}, getPurchaseStatusChip(purchase))
          ),
          purchase.activatedAt ? el('div', {},
            el('label', {}, '激活時間'),
            el('div', {}, fmtDate(purchase.activatedAt))
          ) : null,
          purchase.expiresAt ? el('div', {},
            el('label', {}, '過期時間'),
            el('div', {}, fmtDate(purchase.expiresAt))
          ) : null
        ),
        purchase.notes ? el('div', {},
          el('label', {}, '備註'),
          el('div', {class: 'muted'}, purchase.notes)
        ) : null,
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          purchase.canActivate ?
            el('button', {class: 'btn primary', onclick: () => { closeModal(); activatePurchase(purchase.id); }}, '激活') :
            null,
          el('button', {class: 'btn', onclick: closeModal}, '關閉')
        )
      );

      openModal(modal);
    }

    // 學生資料頁面
    async function renderStudentProfile() {
      showOnly('view-student');
      const wrap = $("#view-student");
      wrap.innerHTML = '';

      // 歡迎橫幅
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, '我的資料'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, '管理您的個人資料和設定')
      ));

      try {
        // 獲取用戶資料
        const user = await apiRequest(`/users/${currentUser.id}`);

        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, '個人資料'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editProfile(user)}, '編輯'),
            el('button', {class: 'btn small', onclick: () => changePassword(user.id)}, '修改密碼')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'row wrap', style: 'align-items:center; gap:16px'},
            el('div', {style: 'position:relative'},
              createAvatar(user, 80, { round: true }),
              el('button', {
                class: 'btn small',
                style: 'position:absolute; bottom:-8px; right:-8px; border-radius:50%; width:32px; height:32px; padding:0; font-size:12px',
                onclick: () => uploadAvatar(user.id),
                title: '更換頭像'
              }, '📷')
            ),
            el('div', {},
              el('div', {class: 'title'}, user.name),
              el('div', {class: 'muted'}, user.email),
              user.bio ? el('div', {style: 'margin-top:8px'}, user.bio) : null
            )
          ),
          el('div', {class: 'form-grid', style: 'margin-top:16px'},
            el('div', {},
              el('label', {}, '電話'),
              el('div', {}, user.phone || '未設定')
            ),
            el('div', {},
              el('label', {}, '時區'),
              el('div', {}, user.timezone || 'Asia/Taipei')
            )
          )
        ));

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, '載入失敗'),
          el('p', {}, error.message)
        ));
      }
    }

    async function uploadAvatar(userId) {
      const input = el('input', {
        type: 'file',
        accept: 'image/*',
        style: 'display:none',
        onchange: async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // 檢查文件大小 (5MB)
          if (file.size > 5 * 1024 * 1024) {
            toast('頭像文件不能超過 5MB', 'error');
            return;
          }

          // 顯示圖片裁切器
          showImageCropper(file, userId);
        }
      });

      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }

    function showImageCropper(file, userId) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const modal = createCropperModal(img, file, userId);
          openModal(modal);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function editProfile(user) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '編輯個人資料'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '姓名'),
            el('input', {id: 'editName', value: user.name})
          ),
          el('div', {},
            el('label', {}, '個人簡介'),
            el('textarea', {id: 'editBio', value: user.bio || '', rows: 3})
          ),
          el('div', {},
            el('label', {}, '電話'),
            el('input', {id: 'editPhone', value: user.phone || ''})
          ),
          el('div', {},
            el('label', {}, '時區'),
            el('select', {id: 'editTimezone'},
              el('option', {value: 'Asia/Taipei', selected: user.timezone === 'Asia/Taipei'}, '台北 (UTC+8)'),
              el('option', {value: 'Asia/Tokyo', selected: user.timezone === 'Asia/Tokyo'}, '東京 (UTC+9)'),
              el('option', {value: 'America/New_York', selected: user.timezone === 'America/New_York'}, '紐約 (UTC-5)'),
              el('option', {value: 'Europe/London', selected: user.timezone === 'Europe/London'}, '倫敦 (UTC+0)')
            )
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => saveProfile(user.id)}, '儲存'),
          el('button', {class: 'btn', onclick: closeModal}, '取消')
        )
      );

      openModal(modal);
    }

    async function saveProfile(userId) {
      try {
        const updateData = {
          name: $("#editName").value,
          bio: $("#editBio").value,
          phone: $("#editPhone").value,
          timezone: $("#editTimezone").value
        };

        await apiRequest(`/users/${userId}`, {
          method: 'PATCH',
          body: JSON.stringify(updateData)
        });

        closeModal();
        toast('資料更新成功', 'success');
        renderStudentProfile(); // 重新載入頁面
      } catch (error) {
        toast('更新失敗：' + error.message, 'error');
      }
    }

    function createCropperModal(img, file, userId) {
      const canvas = el('canvas', { width: 400, height: 400 });
      const ctx = canvas.getContext('2d');
      const preview = el('canvas', { width: 100, height: 100, class: 'crop-preview' });
      const previewCtx = preview.getContext('2d');

      // 計算圖片縮放比例以適應 canvas
      const scale = Math.min(400 / img.width, 400 / img.height);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      const offsetX = (400 - scaledWidth) / 2;
      const offsetY = (400 - scaledHeight) / 2;

      // 裁切區域 (正方形，居中)
      const cropSize = Math.min(scaledWidth, scaledHeight) * 0.8;
      let cropX = (400 - cropSize) / 2;
      let cropY = (400 - cropSize) / 2;

      function drawImage() {
        // 清除 canvas
        ctx.clearRect(0, 0, 400, 400);

        // 繪製圖片
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

        // 繪製遮罩
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect(0, 0, 400, 400);

        // 清除裁切區域
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(cropX + cropSize/2, cropY + cropSize/2, cropSize/2, 0, 2 * Math.PI);
        ctx.fill();

        // 繪製裁切邊框
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cropX + cropSize/2, cropY + cropSize/2, cropSize/2, 0, 2 * Math.PI);
        ctx.stroke();

        // 更新預覽
        updatePreview();
      }

      function updatePreview() {
        previewCtx.clearRect(0, 0, 100, 100);

        // 計算裁切區域在原圖中的位置
        const originalCropX = (cropX - offsetX) / scale;
        const originalCropY = (cropY - offsetY) / scale;
        const originalCropSize = cropSize / scale;

        // 繪製裁切後的圖片到預覽
        previewCtx.drawImage(
          img,
          originalCropX, originalCropY, originalCropSize, originalCropSize,
          0, 0, 100, 100
        );
      }

      // 拖拽功能
      let isDragging = false;
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // 檢查是否點擊在裁切區域內
        const centerX = cropX + cropSize/2;
        const centerY = cropY + cropSize/2;
        const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);

        if (distance <= cropSize/2) {
          isDragging = true;
        }
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // 更新裁切位置，確保不超出邊界
        cropX = Math.max(0, Math.min(400 - cropSize, x - cropSize/2));
        cropY = Math.max(0, Math.min(400 - cropSize, y - cropSize/2));

        drawImage();
      });

      canvas.addEventListener('mouseup', () => {
        isDragging = false;
      });

      drawImage();

      return el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '裁切頭像'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'text-align:center'},
          el('p', {class: 'muted'}, '拖拽圓圈調整裁切位置'),
          el('div', {class: 'crop-container'}, canvas),
          el('div', {style: 'margin:16px 0'},
            el('strong', {}, '預覽：'),
            el('div', {style: 'margin-top:8px'}, preview)
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {
            class: 'btn primary',
            onclick: () => cropAndUpload(canvas, cropX, cropY, cropSize, offsetX, offsetY, scale, img, file, userId)
          }, '確認上傳'),
          el('button', {class: 'btn', onclick: closeModal}, '取消')
        )
      );
    }

    async function cropAndUpload(canvas, cropX, cropY, cropSize, offsetX, offsetY, scale, img, file, userId) {
      try {
        // 創建最終的裁切 canvas
        const finalCanvas = el('canvas', { width: 500, height: 500 });
        const finalCtx = finalCanvas.getContext('2d');

        // 計算原圖中的裁切區域
        const originalCropX = (cropX - offsetX) / scale;
        const originalCropY = (cropY - offsetY) / scale;
        const originalCropSize = cropSize / scale;

        // 繪製裁切後的圖片
        finalCtx.drawImage(
          img,
          originalCropX, originalCropY, originalCropSize, originalCropSize,
          0, 0, 500, 500
        );

        // 轉換為 blob
        finalCanvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append('file', blob, `avatar-${userId}.jpg`);

          await apiRequest(`/users/${userId}/avatar`, {
            method: 'POST',
            body: formData,
            headers: {} // 讓瀏覽器自動設定 Content-Type
          });

          closeModal();
          toast('頭像上傳成功', 'success');

          // 重新載入頁面
          if (currentUser.role === 'student') {
            renderStudentProfile();
          } else if (currentUser.role === 'teacher') {
            renderTeacherProfileManage();
          }
        }, 'image/jpeg', 0.9);

      } catch (error) {
        toast('上傳失敗：' + error.message, 'error');
      }
    }

    // 密碼修改功能
    function changePassword(userId) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '修改密碼'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '當前密碼'),
            el('input', {id: 'currentPassword', type: 'password', placeholder: '請輸入當前密碼'})
          ),
          el('div', {},
            el('label', {}, '新密碼'),
            el('input', {id: 'newPassword', type: 'password', placeholder: '請輸入新密碼 (至少6位)'})
          ),
          el('div', {},
            el('label', {}, '確認新密碼'),
            el('input', {id: 'confirmPassword', type: 'password', placeholder: '請再次輸入新密碼'})
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => doChangePassword(userId)}, '修改密碼'),
          el('button', {class: 'btn', onclick: closeModal}, '取消')
        )
      );

      openModal(modal);
    }

    async function doChangePassword(userId) {
      const currentPassword = $("#currentPassword").value;
      const newPassword = $("#newPassword").value;
      const confirmPassword = $("#confirmPassword").value;

      if (!currentPassword || !newPassword || !confirmPassword) {
        toast('請填寫所有欄位', 'error');
        return;
      }

      if (newPassword.length < 6) {
        toast('新密碼至少需要6位', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        toast('新密碼和確認密碼不一致', 'error');
        return;
      }

      try {
        await apiRequest(`/users/${userId}/change-password`, {
          method: 'POST',
          body: JSON.stringify({
            currentPassword,
            newPassword,
            confirmPassword
          })
        });

        closeModal();
        toast('密碼修改成功', 'success');
      } catch (error) {
        toast('密碼修改失敗：' + error.message, 'error');
      }
    }

    // 教師個人資料管理頁面
    async function renderTeacherProfileManage() {
      showOnly('view-teacher-profile-manage');
      const wrap = $("#view-teacher-profile-manage");
      wrap.innerHTML = '';

      // 歡迎橫幅
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, '我的教師資料'),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, '管理您的教師檔案和教學資料')
      ));

      try {
        // 獲取教師完整資料
        const profile = await apiRequest(`/teachers/${currentUser.id}/profile`);

        // 基本資料卡片
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, '基本資料'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editProfile(profile)}, '編輯'),
            el('button', {class: 'btn small', onclick: () => changePassword(profile.id)}, '修改密碼')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'row wrap', style: 'align-items:center; gap:16px'},
            el('div', {style: 'position:relative'},
              createAvatar(profile, 80, { round: true }),
              el('button', {
                class: 'btn small',
                style: 'position:absolute; bottom:-8px; right:-8px; border-radius:50%; width:32px; height:32px; padding:0; font-size:12px',
                onclick: () => uploadAvatar(profile.id),
                title: '更換頭像'
              }, '📷')
            ),
            el('div', {},
              el('div', {class: 'title'}, profile.name),
              el('div', {class: 'muted'}, profile.email),
              profile.bio ? el('div', {style: 'margin-top:8px'}, profile.bio) : null
            )
          ),
          el('div', {class: 'form-grid', style: 'margin-top:16px'},
            el('div', {},
              el('label', {}, '電話'),
              el('div', {}, profile.phone || '未設定')
            ),
            el('div', {},
              el('label', {}, '時區'),
              el('div', {}, profile.timezone || 'Asia/Taipei')
            )
          )
        ));

        // 教師專業資料卡片
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, '教師資料'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => editTeacherProfile(profile)}, '編輯')
          ),
          el('div', {class: 'hr'}),
          el('div', {class: 'form-grid'},
            el('div', {},
              el('label', {}, '教學經驗'),
              el('div', {}, profile.experienceSince ?
                `從 ${profile.experienceSince} 年開始 (${profile.experienceYears} 年經驗)` :
                '未設定')
            ),
            el('div', {},
              el('label', {}, '時薪'),
              el('div', {}, `$${profile.hourlyRate || 0} USD`)
            ),
            el('div', {},
              el('label', {}, '教學地區'),
              el('div', {}, profile.region || '未設定')
            ),
            el('div', {},
              el('label', {}, '可教授語言'),
              el('div', {}, profile.languages?.join(', ') || '未設定')
            ),
            el('div', {},
              el('label', {}, '教學領域'),
              el('div', {}, profile.domains?.join(', ') || '未設定')
            ),
            el('div', {},
              el('label', {}, '評分'),
              el('div', {}, `${profile.rating || 0} 分 (${profile.ratingsCount || 0} 評價)`)
            )
          ),
          profile.introduction ? el('div', {style: 'margin-top:16px'},
            el('label', {}, '自我介紹'),
            el('div', {style: 'margin-top:4px; padding:12px; background:#f9fafb; border-radius:8px'},
              profile.introduction)
          ) : null,
          profile.certificates ? el('div', {style: 'margin-top:16px'},
            el('label', {}, '證書資訊'),
            el('div', {style: 'margin-top:4px; padding:12px; background:#f9fafb; border-radius:8px'},
              profile.certificates)
          ) : null
        ));

        // 教師相簿
        renderTeacherGallery(profile.id);

      } catch (error) {
        wrap.appendChild(el('div', {class: 'error'},
          el('h3', {}, '載入失敗'),
          el('p', {}, error.message)
        ));
      }
    }

    function editTeacherProfile(profile) {
      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, '編輯教師資料'),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, '自我介紹'),
            el('textarea', {id: 'editIntroduction', value: profile.introduction || '', rows: 4, placeholder: '請介紹您的教學理念和經驗'})
          ),
          el('div', {},
            el('label', {}, '證書資訊'),
            el('textarea', {id: 'editCertificates', value: profile.certificates || '', rows: 3, placeholder: '請列出您的教學相關證書'})
          ),
          el('div', {},
            el('label', {}, '開始教學年份'),
            el('input', {id: 'editExperienceSince', type: 'number', value: profile.experienceSince || '', min: 1990, max: new Date().getFullYear(), placeholder: '例如：2020'})
          ),
          el('div', {},
            el('label', {}, '時薪 (USD)'),
            el('input', {id: 'editHourlyRate', type: 'number', value: profile.hourlyRate || '', min: 0, step: 0.5, placeholder: '例如：25'})
          ),
          el('div', {},
            el('label', {}, '教學地區'),
            el('input', {id: 'editRegion', value: profile.region || '', placeholder: '例如：台北市'})
          ),
          el('div', {},
            el('label', {}, '可教授語言 (用逗號分隔)'),
            el('input', {id: 'editLanguages', value: profile.languages?.join(', ') || '', placeholder: '例如：中文, 英文, 日文'})
          ),
          el('div', {},
            el('label', {}, '教學領域 (用逗號分隔)'),
            el('input', {id: 'editDomains', value: profile.domains?.join(', ') || '', placeholder: '例如：英語會話, 商務英語, 考試準備'})
          )
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => saveTeacherProfile(profile.id)}, '儲存'),
          el('button', {class: 'btn', onclick: closeModal}, '取消')
        )
      );

      openModal(modal);
    }

    async function saveTeacherProfile(teacherId) {
      try {
        const updateData = {
          introduction: $("#editIntroduction").value,
          certificates: $("#editCertificates").value,
          experienceSince: parseInt($("#editExperienceSince").value) || undefined,
          hourlyRate: parseFloat($("#editHourlyRate").value) || undefined,
          region: $("#editRegion").value,
          languages: $("#editLanguages").value.split(',').map(s => s.trim()).filter(s => s),
          domains: $("#editDomains").value.split(',').map(s => s.trim()).filter(s => s)
        };

        await apiRequest(`/teachers/${teacherId}/profile`, {
          method: 'PUT',
          body: JSON.stringify(updateData)
        });

        closeModal();
        toast('教師資料更新成功', 'success');
        renderTeacherProfileManage(); // 重新載入頁面
      } catch (error) {
        toast('更新失敗：' + error.message, 'error');
      }
    }

    // 教師相簿功能
    async function renderTeacherGallery(teacherId) {
      const wrap = $("#view-teacher-profile-manage");

      try {
        const gallery = await apiRequest(`/teachers/${teacherId}/gallery`);

        const galleryCard = el('div', {class: 'card'},
          el('div', {class: 'row wrap'},
            el('h2', {style: 'margin:0'}, '教師相簿'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small', onclick: () => uploadGalleryFile(teacherId)}, '上傳檔案')
          ),
          el('div', {class: 'hr'}),
          gallery.items.length > 0 ?
            el('div', {class: 'gallery-grid'},
              ...gallery.items.map(item => createGalleryItem(item))
            ) :
            el('div', {class: 'subtle', style: 'text-align:center; padding:40px'},
              el('div', {style: 'font-size:48px; margin-bottom:16px'}, '📁'),
              el('div', {class: 'muted'}, '還沒有上傳任何檔案'),
              el('button', {class: 'btn primary', style: 'margin-top:16px', onclick: () => uploadGalleryFile(teacherId)}, '上傳第一個檔案')
            )
        );

        wrap.appendChild(galleryCard);

      } catch (error) {
        console.error('載入相簿失敗:', error);
      }
    }

    function createGalleryItem(item) {
      const container = el('div', {class: 'gallery-item'});

      if (item.type === 'image') {
        container.appendChild(el('img', {
          src: item.url,
          alt: item.filename,
          onclick: () => viewGalleryItem(item)
        }));
      } else if (item.type === 'video') {
        container.appendChild(el('video', {
          src: item.url,
          onclick: () => viewGalleryItem(item)
        }));
        container.appendChild(el('div', {class: 'play-btn'}, '▶'));
      } else if (item.type === 'audio') {
        container.appendChild(el('div', {
          style: 'background:#f3f4f6; display:grid; place-items:center; height:100%; font-size:48px',
          onclick: () => viewGalleryItem(item)
        }, '🎵'));
        container.appendChild(el('div', {class: 'play-btn'}, '▶'));
      } else {
        container.appendChild(el('div', {
          style: 'background:#f3f4f6; display:grid; place-items:center; height:100%; font-size:48px',
          onclick: () => viewGalleryItem(item)
        }, '📄'));
      }

      return container;
    }

    function viewGalleryItem(item) {
      let content;

      if (item.type === 'image') {
        content = el('img', {
          src: item.url,
          style: 'max-width:100%; max-height:70vh; object-fit:contain'
        });
      } else if (item.type === 'video') {
        content = el('video', {
          src: item.url,
          controls: true,
          style: 'max-width:100%; max-height:70vh'
        });
      } else if (item.type === 'audio') {
        content = el('div', {style: 'text-align:center; padding:40px'},
          el('div', {style: 'font-size:64px; margin-bottom:16px'}, '🎵'),
          el('audio', {
            src: item.url,
            controls: true,
            style: 'width:100%; max-width:400px'
          })
        );
      } else {
        content = el('div', {style: 'text-align:center; padding:40px'},
          el('div', {style: 'font-size:64px; margin-bottom:16px'}, '📄'),
          el('p', {}, '無法預覽此檔案類型'),
          el('a', {href: item.url, target: '_blank', class: 'btn primary'}, '下載檔案')
        );
      }

      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, item.filename),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, '✕')
        ),
        el('div', {class: 'hr'}),
        el('div', {style: 'text-align:center'}, content)
      );

      openModal(modal);
    }

    async function uploadGalleryFile(teacherId) {
      const input = el('input', {
        type: 'file',
        accept: 'image/*,video/*,audio/*',
        style: 'display:none',
        onchange: async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // 檢查文件大小 (10MB)
          if (file.size > 10 * 1024 * 1024) {
            toast('檔案不能超過 10MB', 'error');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('file', file);

            await apiRequest(`/teachers/${teacherId}/gallery`, {
              method: 'POST',
              body: formData,
              headers: {} // 讓瀏覽器自動設定 Content-Type
            });

            toast('檔案上傳成功', 'success');
            renderTeacherProfileManage(); // 重新載入頁面
          } catch (error) {
            toast('上傳失敗：' + error.message, 'error');
          }
        }
      });

      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }
  </script>
</body>
</html>
