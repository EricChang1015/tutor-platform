<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å®¶æ•™ç³»çµ± Demo</title>
  <style>
    /* Light theme */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --muted:#6b7280; --text:#111827;
      --brand:#2563eb; --brand-2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ok:#10b981; --border:#e5e7eb; --chip:#f3f4f6; --chip-2:#eef2ff;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji",
      "Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border); z-index:10;
    }
    .nav{display:flex; align-items:center; gap:12px; padding:10px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; color:#0b1420}
    .logo-badge{
      width:34px; height:34px; border-radius:8px; display:grid; place-items:center;
      color:#fff; background:linear-gradient(135deg,#22c55e,#16a34a); font-size:18px; font-weight:900;
      box-shadow:0 6px 16px rgba(34,197,94,.35), inset 0 0 10px rgba(255,255,255,.3);
    }
    .spacer{flex:1}
    .tabbar{display:flex; gap:6px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
      color:#374151; cursor:pointer; transition:.2s; font-size:14px;
    }
    .tab.active{background:#e8f5ff; border-color:#cde6ff; color:#0b4ea2}
    .search{display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border);
      padding:6px 10px; border-radius:12px; min-width:220px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:#111827}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#ffffff; color:#111827; cursor:pointer; transition:.15s;
      box-shadow:0 2px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; border-color:transparent; font-weight:700}
    .btn.success{background:linear-gradient(135deg,#34d399,#10b981); color:#fff; border:0; font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3b2700; border:0; font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#fda4a4,#ef4444); color:#fff; border:0; font-weight:700}
    .btn.ghost{background:#f3f4f6}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:13px}
    .btn.icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af; border:1px solid #e0e7ff}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--border); font-size:12px}
    /* æ™‚å€é¸æ“‡å™¨æ¨£å¼ */
    .timezone-selector{
      display:flex; align-items:center; gap:8px; background:#f0f9ff; border:1px solid #bae6fd;
      padding:8px 12px; border-radius:12px; margin:8px 0;
    }
    .timezone-selector select{
      background:white; border:1px solid #cbd5e1; border-radius:8px; padding:4px 8px;
      font-size:13px; color:#374151;
    }
    .timezone-info{
      font-size:12px; color:#0369a1; margin-left:8px;
    }
    .row{display:flex; gap:12px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .subtle{
      background:#f9fafb; border:1px dashed var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .title{font-size:18px; font-weight:800; margin:8px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#e5e7eb,transparent); margin:12px 0}
    /* Avatars */
    .avatar{
      width:54px; height:54px; border-radius:14px; background:linear-gradient(135deg,#e5f9f0,#d1fae5); border:1px solid var(--border);
      display:grid; place-items:center; font-weight:900; color:#065f46
    }
    .avatar.sm{width:36px; height:36px; border-radius:10px; font-size:14px}
    /* Layout */
    main{padding:10px}
    section[hidden]{display:none !important}
    /* Teacher cards */
    .teacher-card{display:flex; gap:12px}
    .teacher-card .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    /* Materials */
    .materials{display:grid; grid-template-columns:280px 1fr; gap:14px}
    .tree{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:10px; max-height:60vh; overflow:auto}
    .tree ul{list-style:none; padding-left:12px; margin:0}
    .tree li{margin:6px 0}
    .tree .node{display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; cursor:pointer}
    .tree .node.active{background:#eef2ff; border:1px solid #e0e7ff}
    .node .icon{width:22px; text-align:center}
    .content-pane{min-height:320px}
    .pdf{background:#f9fafb; border-radius:10px; padding:20px; border:1px solid var(--border)}
    /* Schedule */
    .date-strip{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .date-pill{min-width:110px; text-align:center; padding:8px; border-radius:12px; background:#f3f4f6; border:1px solid var(--border); cursor:pointer}
    .date-pill.active{background:#e0f2fe; border-color:#bae6fd}
    .slots{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .slot{padding:10px; border-radius:10px; border:1px solid var(--border); background:#ffffff; text-align:center; cursor:pointer}
    .slot.busy{opacity:.45; text-decoration:line-through; cursor:not-allowed}
    .slot.selected{outline:2px solid var(--brand)}
    /* Calendar */
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{border:1px solid var(--border); background:#ffffff; min-height:80px; border-radius:10px; padding:6px; position:relative}
    .cal-cell .dot{position:absolute; right:8px; bottom:6px; width:8px; height:8px; border-radius:50%}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#6b7280; text-align:center}
    .dot-blue{background:#3b82f6} .dot-orange{background:#f59e0b} .dot-gray{background:#6b7280}
    /* Modal & Toast */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:grid; place-items:center; z-index:20}
    .modal{background:var(--surface); border:1px solid var(--border); border-radius:16px; width:min(560px,92vw); padding:18px; box-shadow:var(--shadow)}
    .toast{position:fixed; right:14px; bottom:14px; background:var(--surface); border:1px solid var(--border); padding:12px 14px; border-radius:12px; z-index:30; box-shadow:var(--shadow)}
    /* Forms */
    label{font-size:13px; color:#6b7280}
    input,select,textarea{
      width:100%; background:#ffffff; color:#111827;
      border:1px solid var(--border); border-radius:10px; padding:10px; outline:none
    }
    textarea{min-height:80px; resize:vertical}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid > div{display:flex; flex-direction:column; gap:6px}
    /* Lists & tables */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:10px; background:#ffffff}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th{font-size:12px; text-transform:uppercase; color:#6b7280; background:#f9fafb; border-bottom:1px solid var(--border)}
    th, td{padding:12px; text-align:left}
    tr{border-bottom:1px solid var(--border)}
    tr:hover td{background:#fafafa}
    .hidden{display:none !important}
    /* Responsive */
    @media (max-width: 900px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .materials{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .slots{grid-template-columns:1fr}
      .search{min-width:unset; width:100%}
      .tabbar{width:100%; overflow:auto}
      th:nth-child(3), td:nth-child(3){white-space:nowrap}
    }
    .hint{font-size:12px; color:#6b7280}
    .welcome{
      background:linear-gradient(90deg,#16a34a,#15803d); color:#fff; border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .status-chip{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-upcoming{background:#dbeafe; color:#1d4ed8}
    .status-completed{background:#e5e7eb; color:#374151}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">TG</div>å®¶æ•™ç³»çµ± Demo</div>
      <div class="spacer"></div>
      <div id="searchBar" class="search hidden">
        <span>ğŸ”</span>
        <input id="globalSearch" placeholder="æœå°‹è€å¸«ã€æ“…é•·é ˜åŸŸã€åœ°å€â€¦" />
      </div>
      <div id="tabbar" class="tabbar"></div>
      <div class="spacer"></div>
      <div id="timezone-container" class="timezone-selector hidden">
        <span>ğŸŒ</span>
        <select id="timezone-select" onchange="updateTimezone()">
          <option value="Asia/Taipei">å°åŒ—</option>
          <option value="America/New_York">ç´ç´„</option>
          <option value="America/Los_Angeles">æ´›æ‰ç£¯</option>
          <option value="Europe/London">å€«æ•¦</option>
          <option value="Europe/Paris">å·´é»</option>
          <option value="Asia/Tokyo">æ±äº¬</option>
          <option value="UTC">UTC</option>
        </select>
        <span id="current-time" class="timezone-info"></span>
      </div>
      <button id="notifBtn" class="btn icon hidden" title="é€šçŸ¥">ğŸ””<span id="notifDot" class="badge hidden">0</span></button>
      <div id="userMenu" class="row">
        <button id="resetBtn" class="btn small ghost hidden">é‡ç½® Demo</button>
        <button id="loginBtn" class="btn primary">ç™»å…¥</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="view-login">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">ç™»å…¥</div>
          <div class="muted">ä½¿ç”¨ä¸‹æ–¹å¸³å¯†é«”é©—ä¸åŒè§’è‰²ï¼ˆadmin / student / teacherï¼‰ã€‚</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div><label>å¸³è™Ÿ</label><input id="login-username" placeholder="admin@example.com" /></div>
            <div><label>å¯†ç¢¼</label><input id="login-password" type="password" placeholder="password" /></div>
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button id="login-submit" class="btn success">ç™»å…¥</button>
            <span class="hint">åˆæ¬¡é–‹å•Ÿæœƒè‡ªå‹•å»ºç«‹ç¤ºç¯„è³‡æ–™ã€‚</span>
          </div>
          <div class="hr"></div>
          <div class="chips">
            <button class="btn small" data-demo-fill="admin">å¡«å…¥ admin</button>
            <button class="btn small" data-demo-fill="student">å¡«å…¥ student</button>
            <button class="btn small" data-demo-fill="teacher">å¡«å…¥ teacher</button>
          </div>
        </div>
        <div class="card">
          <div class="title">æœ¬ Demo ç‰¹è‰²</div>
          <ul>
            <li>æ¨è–¦æ•™å¸«ï¼šå¡ç‰‡æ¸…å–®ã€æ”¶è—ã€æŸ¥çœ‹ Profileã€é ç´„ã€‚</li>
            <li>æ•™æï¼šè³‡æ–™å¤¾æ¨¹ã€æ•™æé /æ¨¡æ“¬ PDFã€å¾æ•™æå¸¶å…¥é ç´„ã€‚</li>
            <li>é ç´„èª²è¡¨ï¼šåŠå°æ™‚åˆ‡ç‰‡ã€ç•™è¨€ã€è¡Œäº‹æ›† .icsã€‚</li>
            <li>æˆ‘çš„é ç´„ï¼šå…ˆåˆ—è¡¨ã€å¾Œæ—¥æ›†ï¼›å–æ¶ˆ/æ”¹æœŸã€è©•åƒ¹ã€‚</li>
            <li>è€å¸«ç«¯ï¼šå¯ç”¨æ™‚æ®µè¨­å®šã€é ç´„åˆ—è¡¨ã€ç›¸ç°¿ä¸Šå‚³ã€‚</li>
            <li>ç®¡ç†ç«¯ï¼šæ•™æç®¡ç†ã€æ•™å¸«ä¸Šæ¶ã€è©•åƒ¹å¯©æ ¸ã€‚</li>
            <li>é€šçŸ¥ä¸­å¿ƒï¼šé ç´„/å¯©æ ¸ç­‰äº‹ä»¶æ¨æ’­ã€‚</li>
          </ul>
          <div class="subtle">
            <b>æç¤ºï¼š</b>æ‰€æœ‰è³‡æ–™é€éçœŸå¯¦APIæä¾›ï¼Œé»ã€Œé‡ç½® Demoã€å¯å›åˆ°å‡ºå» ç‹€æ…‹ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Teachers -->
    <section id="view-teachers" hidden>
      <div class="row wrap">
        <div class="title">æ¨è–¦æ•™å¸«</div>
        <span class="pill" id="courseContext">é ç´„èª²ç¨‹ï¼šè‡ªç”±å°è©±</span>
        <div class="spacer"></div>
        <div class="row wrap">
          <select id="filter-tag" class="pill">
            <option value="">å…¨éƒ¨é ˜åŸŸ</option>
            <option>English</option>
            <option>Conversation</option>
            <option>Pronunciation</option>
            <option>IELTS</option>
          </select>
          <select id="filter-region" class="pill">
            <option value="">å…¨éƒ¨åœ°å€</option>
            <option>Taiwan</option>
          </select>
          <select id="filter-sort" class="pill">
            <option value="rating">æ’åºï¼šè©•åˆ†</option>
            <option value="exp">æ’åºï¼šå¹´è³‡</option>
            <option value="soonest">æ’åºï¼šæœ€è¿‘å¯ç´„</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" id="teachersGrid"></div>
    </section>

    <!-- Teacher Profile -->
    <section id="view-teacher-profile" hidden></section>

    <!-- Materials -->
    <section id="view-materials" hidden>
      <div class="row wrap">
        <div class="title">æ•™æ</div>
        <div class="spacer"></div>
        <div id="materials-actions" class="row wrap hidden">
          <button class="btn small" data-mt-action="add-folder">ï¼‹ æ–°å¢è³‡æ–™å¤¾</button>
          <button class="btn small" data-mt-action="add-page">ï¼‹ æ–°å¢æ•™æé </button>
          <button class="btn small" data-mt-action="add-pdf">ï¼‹ æ–°å¢ PDF</button>
        </div>
      </div>
      <div class="materials">
        <div class="tree" id="materialsTree"></div>
        <div class="card content-pane" id="materialsContent"></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" hidden></section>

    <!-- Bookings -->
    <section id="view-bookings" hidden></section>

    <!-- Student Profile -->
    <section id="view-student" hidden></section>

    <!-- Teacher Dashboard -->
    <section id="view-teacher-dashboard" hidden></section>

    <!-- Admin -->
    <section id="view-admin" hidden></section>
  </main>

  <!-- Modal + Toast -->
  <div id="modalHost" class="modal-backdrop hidden"><div class="modal" id="modalBox"></div></div>
  <div id="toastHost" class="toast hidden"></div>

  <script>
    // API åŸºç¤è¨­å®š
    const API_BASE = window.location.origin;
    let accessToken = '';
    let currentUser = null;
    let currentTimezone = 'Asia/Taipei';
    let DB = {
      courseContext: null,
      favorites: {},
      notifications: []
    };

    // å·¥å…·å‡½æ•¸
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{
        if(k==='class') node.className=v;
        else if(k==='html') node.innerHTML=v;
        else if(k.startsWith('on') && typeof v==='function') node.addEventListener(k.substring(2), v);
        else if(v!==undefined) node.setAttribute(k,v);
      });
      children.forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    };

    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit', weekday:'short'});
    const fmtDateFull = d => new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const fmtDateWithTimezone = (d, timezone) => {
      const options = {
        timeZone: timezone || currentTimezone,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false
      };
      return new Date(d).toLocaleString('zh-TW', options);
    };
    const toast = (msg)=>{ const t=$("#toastHost"); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };

    // æ™‚å€ç›¸é—œå‡½æ•¸
    function getCurrentTimezone() {
      return currentTimezone;
    }

    function updateTimezone() {
      const select = $("#timezone-select");
      currentTimezone = select.value;
      updateCurrentTimeDisplay();
      console.log('æ™‚å€å·²æ›´æ–°ç‚º:', currentTimezone);

      // å¦‚æœåœ¨é ç´„é é¢ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
      if (current() === 'bookings') {
        renderBookings();
      }
    }

    function updateCurrentTimeDisplay() {
      const timeSpan = $("#current-time");
      if (timeSpan) {
        const now = new Date();
        const options = {
          timeZone: currentTimezone,
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        };
        const localTime = now.toLocaleString('zh-TW', options);
        timeSpan.textContent = localTime;
      }
    }

    function initializeTimezone() {
      // å˜—è©¦æª¢æ¸¬ç”¨æˆ¶çš„æ™‚å€
      const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const select = $("#timezone-select");

      // å¦‚æœç”¨æˆ¶æ™‚å€åœ¨é¸é …ä¸­ï¼Œå‰‡è¨­ç‚ºé è¨­å€¼
      const options = Array.from(select.options);
      const userOption = options.find(option => option.value === userTimezone);
      if (userOption) {
        select.value = userTimezone;
        currentTimezone = userTimezone;
      }

      updateCurrentTimeDisplay();

      // æ¯åˆ†é˜æ›´æ–°æ™‚é–“é¡¯ç¤º
      setInterval(updateCurrentTimeDisplay, 60000);
    }
    const openModal = (node)=>{ $("#modalBox").innerHTML=''; $("#modalBox").appendChild(node); $("#modalHost").classList.remove('hidden'); };
    const closeModal = ()=> $("#modalHost").classList.add('hidden');
    $("#modalHost").addEventListener('click', e=>{ if(e.target.id==='modalHost') closeModal(); });

    // API è«‹æ±‚å‡½æ•¸
    async function apiRequest(endpoint, options = {}) {
      const url = `${API_BASE}${endpoint}`;
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };

      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }

      try {
        const response = await fetch(url, {
          ...options,
          headers
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return await response.json();
        }
        return null;
      } catch (error) {
        console.error('API Request failed:', error);
        toast('API è«‹æ±‚å¤±æ•—: ' + error.message);
        throw error;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      setupEventListeners();
      initializeTimezone(); // åˆå§‹åŒ–æ™‚å€åŠŸèƒ½
      headerUI();
      goto('login');
    }

    function setupEventListeners() {
      // ç™»å…¥ç›¸é—œ
      $("#login-submit").addEventListener('click', doLogin);
      $("#loginBtn").addEventListener('click', () => goto('login'));
      
      // Demo å¡«å…¥æŒ‰éˆ•
      document.querySelectorAll('[data-demo-fill]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const role = e.target.dataset.demoFill;
          fillDemoCredentials(role);
        });
      });

      // Tab å°èˆª
      $("#tabbar").addEventListener('click', (e) => {
        if (e.target.dataset.go) {
          goto(e.target.dataset.go);
        }
      });

      // é‡ç½®æŒ‰éˆ•
      $("#resetBtn").addEventListener('click', resetDemo);
    }

    function fillDemoCredentials(role) {
      const credentials = {
        admin: { username: 'admin@example.com', password: 'password' },
        student: { username: 'student1@example.com', password: 'password' },
        teacher: { username: 'teacher1@example.com', password: 'password' }
      };

      if (credentials[role]) {
        $("#login-username").value = credentials[role].username;
        $("#login-password").value = credentials[role].password;
      }
    }

    // è·¯ç”±ç³»çµ±
    const ROUTES = ['login','teachers','teacher-profile','materials','schedule','bookings','student','teacher-dashboard','admin'];
    const goto = (hash)=>{ location.hash = '#/'+hash; };
    const current = ()=> (location.hash.replace('#/','')||'login');

    window.addEventListener('hashchange', render);

    function render() {
      const route = current();
      showOnly('view-' + route.split('/')[0]);
      
      if (route.startsWith('teachers') && route !== 'teachers') {
        renderTeachers();
      } else if (route === 'teachers') {
        renderTeachers();
      } else if (route === 'materials') {
        renderMaterials();
      } else if (route === 'bookings') {
        renderBookings();
      }
    }

    function showOnly(id) {
      ['view-login','view-teachers','view-teacher-profile','view-materials','view-schedule','view-bookings','view-student','view-teacher-dashboard','view-admin']
      .forEach(v => $( '#'+v ).hidden = (v!==id));
    }

    // èªè­‰ç›¸é—œå‡½æ•¸
    async function doLogin() {
      const username = $("#login-username").value;
      const password = $("#login-password").value;

      if (!username || !password) {
        toast('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
        return;
      }

      try {
        const response = await apiRequest('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });

        if (response.accessToken) {
          accessToken = response.accessToken;
          currentUser = response.user;
          headerUI();
          goto('teachers');
          toast(`æ­¡è¿ï¼Œ${currentUser.name || currentUser.username}`);
        }
      } catch (error) {
        toast('ç™»å…¥å¤±æ•—ï¼š' + error.message);
      }
    }

    async function doLogout() {
      try {
        if (accessToken) {
          await apiRequest('/auth/logout', { method: 'POST' });
        }
      } catch (error) {
        console.error('Logout error:', error);
      }

      accessToken = '';
      currentUser = null;
      headerUI();
      goto('login');
      toast('å·²ç™»å‡º');
    }

    // é ­éƒ¨UIæ›´æ–°
    function headerUI() {
      const logged = !!currentUser;
      $("#loginBtn").classList.toggle('hidden', logged);
      $("#searchBar").classList.toggle('hidden', !logged);
      $("#notifBtn").classList.toggle('hidden', !logged);
      $("#resetBtn").classList.toggle('hidden', !logged);
      $("#timezone-container").classList.toggle('hidden', !logged);

      if (logged) {
        const menu = $("#userMenu");
        let logoutBtn = menu.querySelector('#logoutBtn');
        if (!logoutBtn) {
          logoutBtn = el('button', {id:'logoutBtn', class:'btn'}, `ç™»å‡ºï¼ˆ${currentUser.name || currentUser.username}ï¼‰`);
          logoutBtn.addEventListener('click', doLogout);
          menu.appendChild(logoutBtn);
        }
      } else {
        const logoutBtn = $("#userMenu").querySelector('#logoutBtn');
        if (logoutBtn) logoutBtn.remove();
      }

      navTabs();
    }

    function navTabs() {
      const role = currentUser?.role;
      const bar = $("#tabbar");
      bar.innerHTML = '';

      const addTab = (key, label, opts = {}) => {
        const b = el('button', {class:'tab', 'data-go':key}, label);
        if (current().startsWith(key)) b.classList.add('active');
        if (opts.hide) b.classList.add('hidden');
        bar.appendChild(b);
      };

      addTab('teachers', 'æ¨è–¦æ•™å¸«', {hide: !role});
      addTab('materials', 'æ•™æ', {hide: !role});
      addTab('bookings', 'æˆ‘çš„é ç´„', {hide: !role});
      if (role === 'student') addTab('student', 'æˆ‘çš„è³‡æ–™');
      if (role === 'teacher') addTab('teacher-dashboard', 'è€å¸«å¾Œå°');
      if (role === 'admin') addTab('admin', 'ç®¡ç†å¾Œå°');
    }

    // æ•™å¸«åˆ—è¡¨æ¸²æŸ“
    async function renderTeachers() {
      showOnly('view-teachers');
      $("#courseContext").textContent = 'é ç´„èª²ç¨‹ï¼š' + (DB.courseContext?.name || 'è‡ªç”±å°è©±');

      try {
        const response = await apiRequest('/teachers');
        const teachers = response.items || [];

        const grid = $("#teachersGrid");
        grid.innerHTML = '';

        teachers.forEach(teacher => {
          const card = createTeacherCard(teacher);
          grid.appendChild(card);
        });

      } catch (error) {
        console.error('Failed to load teachers:', error);
        toast('è¼‰å…¥æ•™å¸«åˆ—è¡¨å¤±æ•—');
      }
    }

    function createTeacherCard(teacher) {
      const initials = teacher.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      return el('div', {class: 'card teacher-card'},
        el('div', {class: 'avatar', title: teacher.name}, initials),
        el('div', {},
          el('div', {class: 'row wrap'},
            el('div', {class: 'title'}, teacher.name),
            el('span', {class: 'badge'}, `åœ°å€ï¼š${teacher.region}`),
            el('span', {class: 'badge'}, `ç¶“é©—ï¼š${teacher.experienceYears} å¹´`),
            el('span', {class: 'badge'}, `è©•åˆ†ï¼š${teacher.rating}`)
          ),
          el('div', {class: 'tags'}, ...teacher.domains.map(domain => el('span', {class: 'pill'}, domain))),
          el('div', {class: 'muted'}, teacher.introSnippet || 'å°ˆæ¥­æ•™å¸«'),
          el('div', {class: 'actions'},
            el('button', {class: 'btn small', onclick: () => openTeacherProfile(teacher.id)}, 'æŸ¥çœ‹ Profile'),
            el('button', {class: 'btn small primary', onclick: () => openSchedule(teacher.id)}, 'é ç´„'),
            currentUser?.role === 'student'
              ? el('button', {class: 'btn small', onclick: () => toggleFav(teacher.id)}, 'â˜† æ”¶è—')
              : null
          )
        )
      );
    }

    // æ•™å¸«è©³æƒ…
    async function openTeacherProfile(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        renderTeacherProfile(teacher);
        goto(`teacher-profile/${teacherId}`);
      } catch (error) {
        toast('è¼‰å…¥æ•™å¸«è©³æƒ…å¤±æ•—');
      }
    }

    function renderTeacherProfile(teacher) {
      showOnly('view-teacher-profile');
      const wrap = $("#view-teacher-profile");
      wrap.innerHTML = '';

      const initials = teacher.name[0];

      wrap.appendChild(el('div', {class: 'card'},
        el('div', {class: 'row wrap'},
          el('div', {class: 'avatar'}, initials),
          el('div', {},
            el('div', {class: 'title'}, teacher.name),
            el('div', {class: 'chips'},
              el('span', {class: 'badge'}, `åœ°å€ï¼š${teacher.region}`),
              el('span', {class: 'badge'}, `å¹´è³‡ï¼š${teacher.experienceYears} å¹´`),
              el('span', {class: 'badge'}, `è©•åˆ†ï¼š${teacher.rating}`)
            )
          ),
          el('div', {class: 'spacer'}),
          el('div', {class: 'row wrap'},
            el('button', {class: 'btn primary small', onclick: () => openSchedule(teacher.id)}, 'ä¸€éµé ç´„'),
            el('button', {class: 'btn small', onclick: () => goto('teachers')}, 'è¿”å›åˆ—è¡¨')
          )
        ),
        el('div', {class: 'tags', style: 'margin-top:6px'}, ...teacher.domains.map(x => el('span', {class: 'pill'}, x))),
        el('div', {class: 'hr'}),
        el('div', {}, el('b', {}, 'è‡ªæˆ‘ä»‹ç´¹'), el('div', {class: 'muted'}, teacher.intro || 'å°ˆæ¥­æ•™å¸«ï¼Œæ­¡è¿é ç´„èª²ç¨‹'))
      ));
    }

    // é ç´„ç›¸é—œ
    async function openSchedule(teacherId) {
      try {
        const teacher = await apiRequest(`/teachers/${teacherId}`);
        showScheduleModal(teacher);
      } catch (error) {
        toast('è¼‰å…¥æ•™å¸«è³‡è¨Šå¤±æ•—');
      }
    }

    function showScheduleModal(teacher) {
      const today = new Date();
      const dates = [];

      // ç”Ÿæˆæœªä¾†7å¤©çš„æ—¥æœŸ
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        dates.push(date);
      }

      const modal = el('div', {},
        el('div', {class: 'row wrap'},
          el('h3', {style: 'margin:0'}, `é ç´„ ${teacher.name} çš„èª²ç¨‹`),
          el('div', {class: 'spacer'}),
          el('button', {class: 'btn small', onclick: closeModal}, 'âœ•')
        ),
        el('div', {class: 'hr'}),
        el('div', {class: 'muted'}, 'é¸æ“‡æ—¥æœŸå’Œæ™‚é–“'),
        el('div', {class: 'date-strip', id: 'dateStrip'}),
        el('div', {id: 'timeSlots', style: 'margin-top:16px'}),
        el('div', {class: 'hr'}),
        el('div', {class: 'form-grid'},
          el('div', {},
            el('label', {}, 'èª²ç¨‹æ¨™é¡Œ'),
            el('input', {id: 'courseTitle', value: DB.courseContext?.name || 'è‡ªç”±å°è©±'})
          ),
          el('div', {},
            el('label', {}, 'æŒçºŒæ™‚é–“'),
            el('select', {id: 'duration'},
              el('option', {value: '30'}, '30åˆ†é˜'),
              el('option', {value: '60'}, '60åˆ†é˜'),
              el('option', {value: '90'}, '90åˆ†é˜')
            )
          )
        ),
        el('div', {},
          el('label', {}, 'çµ¦è€å¸«çš„ç•™è¨€'),
          el('textarea', {id: 'bookingMessage', placeholder: 'å¯ä»¥å‘Šè¨´è€å¸«æ‚¨çš„å­¸ç¿’ç›®æ¨™æˆ–ç‰¹æ®Šéœ€æ±‚...'})
        ),
        el('div', {class: 'row wrap', style: 'margin-top:16px'},
          el('button', {class: 'btn primary', onclick: () => submitBooking(teacher.id)}, 'ç¢ºèªé ç´„'),
          el('button', {class: 'btn', onclick: closeModal}, 'å–æ¶ˆ')
        )
      );

      openModal(modal);

      // æ¸²æŸ“æ—¥æœŸé¸æ“‡
      renderDateStrip(dates);

      // é è¨­é¸æ“‡ä»Šå¤©
      selectDate(dates[0], teacher.id);
    }

    function renderDateStrip(dates) {
      const strip = $("#dateStrip");
      strip.innerHTML = '';

      dates.forEach((date, index) => {
        const pill = el('div', {
          class: `date-pill ${index === 0 ? 'active' : ''}`,
          onclick: () => {
            document.querySelectorAll('.date-pill').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            selectDate(date, getCurrentTeacherId());
          }
        },
          el('div', {style: 'font-weight:600'}, date.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'})),
          el('div', {style: 'font-size:12px'}, date.toLocaleDateString('zh-TW', {weekday:'short'}))
        );
        strip.appendChild(pill);
      });
    }

    function getCurrentTeacherId() {
      // å¾æ¨¡æ…‹æ¡†ä¸­ç²å–ç•¶å‰æ•™å¸«IDï¼Œé€™è£¡ç°¡åŒ–è™•ç†
      return window.currentTeacherId;
    }

    async function selectDate(date, teacherId) {
      window.currentTeacherId = teacherId;
      window.selectedDate = date;

      const dateStr = date.toISOString().split('T')[0];

      try {
        // ç²å–æ•™å¸«æ™‚é–“è¡¨ï¼ˆæ”¯æ´æ™‚å€ï¼‰
        const response = await fetch(`${API_BASE}/teacher-availability/teacher-timetable?teacherId=${teacherId}&date=${dateStr}&timezone=${currentTimezone}`);
        const result = await response.json();

        if (result.code === 0) {
          renderTimeSlots(result.data || []);
        } else {
          renderTimeSlots([]);
        }
      } catch (error) {
        console.error('Failed to load timetable:', error);
        renderTimeSlots([]);
      }
    }

    function renderTimeSlots(timetable) {
      const container = $("#timeSlots");
      container.innerHTML = '';

      if (timetable.length === 0) {
        container.appendChild(el('div', {class: 'muted'}, 'è©²æ—¥æœŸæš«ç„¡å¯ç”¨æ™‚æ®µ'));
        return;
      }

      container.appendChild(el('div', {class: 'muted', style: 'margin-bottom:8px'}, 'å¯ç”¨æ™‚æ®µï¼š'));

      const slots = el('div', {class: 'slots'});

      timetable.forEach(slot => {
        if (slot.canReserve === 1) {
          const slotEl = el('div', {
            class: 'slot',
            onclick: () => {
              document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
              slotEl.classList.add('selected');
              window.selectedTimeSlot = slot;
            }
          }, slot.time);
          slots.appendChild(slotEl);
        }
      });

      container.appendChild(slots);
    }

    async function submitBooking(teacherId) {
      if (!window.selectedDate || !window.selectedTimeSlot) {
        toast('è«‹é¸æ“‡æ—¥æœŸå’Œæ™‚é–“');
        return;
      }

      const courseTitle = $("#courseTitle").value;
      const duration = parseInt($("#duration").value);
      const message = $("#bookingMessage").value;

      // æ§‹å»ºé ç´„æ™‚é–“ï¼ˆæ”¯æ´æ™‚å€ï¼‰
      const [hours, minutes] = window.selectedTimeSlot.time.split(':');
      const startsAt = new Date(window.selectedDate);
      startsAt.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      const bookingData = {
        teacherId,
        startsAt: startsAt.toISOString(),
        durationMinutes: duration,
        timezone: currentTimezone,
        courseTitle,
        message,
        materialId: DB.courseContext?.id
      };

      try {
        await apiRequest('/bookings', {
          method: 'POST',
          body: JSON.stringify(bookingData)
        });

        closeModal();
        toast('é ç´„æˆåŠŸï¼');

        // å¦‚æœåœ¨é ç´„é é¢ï¼Œåˆ·æ–°åˆ—è¡¨
        if (current() === 'bookings') {
          renderBookings();
        }
      } catch (error) {
        toast('é ç´„å¤±æ•—ï¼š' + error.message);
      }
    }

    function toggleFav(teacherId) {
      toast('æ”¶è—åŠŸèƒ½é–‹ç™¼ä¸­...');
      // TODO: å¯¦ç¾æ”¶è—åŠŸèƒ½
    }

    // æ•™æç›¸é—œ
    async function renderMaterials() {
      showOnly('view-materials');
      $("#materials-actions").classList.toggle('hidden', currentUser?.role !== 'admin');

      try {
        const response = await apiRequest('/materials?include=all');
        renderMaterialsTree(response.folders || []);
        renderMaterialsContent();
      } catch (error) {
        console.error('Failed to load materials:', error);
        toast('è¼‰å…¥æ•™æå¤±æ•—');
      }
    }

    function renderMaterialsTree(folders) {
      const tree = $("#materialsTree");
      tree.innerHTML = '';

      if (!folders || folders.length === 0) {
        tree.appendChild(el('div', {class: 'muted'}, 'æš«ç„¡æ•™æ'));
        return;
      }

      const ul = el('ul');
      folders.forEach(folder => {
        ul.appendChild(createFolderNode(folder));
      });
      tree.appendChild(ul);
    }

    function createFolderNode(folder) {
      const li = el('li');
      const icon = 'ğŸ“';
      const nodeEl = el('div', {
        class: 'node',
        onclick: () => selectMaterial(folder)
      },
        el('span', {class: 'icon'}, icon),
        el('span', {}, folder.name)
      );

      li.appendChild(nodeEl);

      // æ·»åŠ å­è³‡æ–™å¤¾
      if (folder.children?.length) {
        const subUl = el('ul');
        folder.children.forEach(child => {
          subUl.appendChild(createFolderNode(child));
        });
        li.appendChild(subUl);
      }

      // æ·»åŠ æ•™æé …ç›®
      if (folder.materials?.length) {
        const materialsUl = el('ul');
        folder.materials.forEach(material => {
          const materialLi = el('li');
          const materialIcon = material.type === 'pdf' ? 'ğŸ“„' : 'ğŸ“';
          const materialNode = el('div', {
            class: 'node',
            onclick: () => selectMaterial(material)
          },
            el('span', {class: 'icon'}, materialIcon),
            el('span', {}, material.title)
          );
          materialLi.appendChild(materialNode);
          materialsUl.appendChild(materialLi);
        });
        li.appendChild(materialsUl);
      }

      return li;
    }

    function selectMaterial(material) {
      // ç§»é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.tree .node.active').forEach(node => {
        node.classList.remove('active');
      });

      // æ·»åŠ ç•¶å‰é¸ä¸­ç‹€æ…‹
      event.currentTarget.classList.add('active');

      renderMaterialsContent(material);
    }

    function renderMaterialsContent(material) {
      const pane = $("#materialsContent");
      pane.innerHTML = '';

      if (!material) {
        pane.appendChild(el('div', {class: 'title'}, 'é¸æ“‡æ•™æ'));
        pane.appendChild(el('div', {class: 'muted'}, 'è«‹å¾å·¦å´é¸æ“‡æ•™ææŸ¥çœ‹å…§å®¹'));
        return;
      }

      const title = material.name || material.title || 'æœªå‘½å';
      pane.appendChild(el('div', {class: 'title'}, title));

      if (material.name && !material.type) {
        // é€™æ˜¯ä¸€å€‹è³‡æ–™å¤¾
        pane.appendChild(el('div', {class: 'muted'}, 'é€™æ˜¯ä¸€å€‹è³‡æ–™å¤¾ï¼ŒåŒ…å«å¤šå€‹æ•™æé …ç›®'));
        const childCount = (material.children?.length || 0) + (material.materials?.length || 0);
        pane.appendChild(el('div', {class: 'muted'}, `åŒ…å« ${childCount} å€‹é …ç›®`));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn', onclick: () => selectCourseContext(material)}, 'é¸æ“‡æ­¤èª²ç¨‹')
        ));
      } else {
        // é€™æ˜¯ä¸€å€‹æ•™æ
        const content = material.content || 'æš«ç„¡å…§å®¹æè¿°';
        pane.appendChild(el('div', {class: 'muted'}, `é¡å‹ï¼š${material.type === 'pdf' ? 'PDFæ–‡ä»¶' : 'æ•™æé é¢'}`));
        pane.appendChild(el('div', {class: 'hr'}));
        pane.appendChild(el('div', {class: 'card'},
          el('h4', {}, 'æ•™æå…§å®¹'),
          el('p', {}, content)
        ));
        pane.appendChild(el('div', {class: 'row wrap'},
          el('button', {class: 'btn primary', onclick: () => selectCourseContext(material)}, 'é ç´„è€å¸«'),
          el('span', {class: 'hint'}, 'å°‡å¸¶å…¥æ¨è–¦æ•™å¸«é ï¼Œä¸¦æ–¼é ç´„æ™‚è‡ªå‹•å¡«å…¥æ•™æ')
        ));
      }
    }

    function selectCourseContext(material) {
      const name = material.name || material.title || 'æœªå‘½åæ•™æ';
      DB.courseContext = {id: material.id, name: name};
      goto('teachers');
      toast('å·²å¸¶å…¥æ•™æè‡³é ç´„æµç¨‹');
    }

    // é ç´„åˆ—è¡¨
    async function renderBookings() {
      showOnly('view-bookings');
      const wrap = $("#view-bookings");
      wrap.innerHTML = '';

      // æ­¡è¿æ©«å¹…
      wrap.appendChild(el('div', {class: 'welcome'},
        el('h1', {style: 'margin:0; font-size:20px; font-weight:800'}, `æ­¡è¿å›ä¾†ï¼Œ${currentUser?.name || 'ç”¨æˆ¶'}ï¼`),
        el('p', {style: 'margin:6px 0 0; color:#e7ffe7'}, 'æº–å‚™å¥½é–‹å§‹ä»Šå¤©çš„å­¸ç¿’ä¹‹æ—…äº†å—ï¼Ÿ')
      ));

      try {
        const response = await apiRequest(`/bookings?timezone=${currentTimezone}`);
        const bookings = response.items || [];

        // ç•¶å‰é ç´„
        const listCard = el('div', {class: 'card', style: 'margin-top:16px'},
          el('div', {class: 'row wrap'},
            el('h2', {class: 'title', style: 'margin:0'}, 'ç•¶å‰é ç´„'),
            el('div', {class: 'spacer'}),
            el('button', {class: 'btn small ghost', onclick: () => goto('teachers')}, 'å»é ç´„æ›´å¤š')
          )
        );

        if (bookings.length === 0) {
          listCard.appendChild(el('div', {class: 'muted', style: 'padding:12px'}, 'ç›®å‰æ²’æœ‰é ç´„èª²ç¨‹'));
        } else {
          const table = createBookingsTable(bookings);
          listCard.appendChild(table);
        }

        wrap.appendChild(listCard);

      } catch (error) {
        console.error('Failed to load bookings:', error);
        wrap.appendChild(el('div', {class: 'card'},
          el('div', {class: 'muted'}, 'è¼‰å…¥é ç´„åˆ—è¡¨å¤±æ•—')
        ));
      }
    }

    function createBookingsTable(bookings) {
      const table = el('table');
      const thead = el('thead', {}, el('tr', {},
        el('th', {}, 'èª²ç¨‹'),
        el('th', {}, 'è€å¸«'),
        el('th', {}, 'æ™‚é–“'),
        el('th', {}, 'ç‹€æ…‹'),
        el('th', {}, 'æ“ä½œ')
      ));

      const tbody = el('tbody');
      bookings.forEach(booking => {
        // é¡¯ç¤ºæœ¬åœ°æ™‚é–“å’Œæ•™å¸«æ™‚å€æ™‚é–“
        const localTime = booking.startsAtLocal || fmtDateWithTimezone(booking.startsAt, currentTimezone);
        const teacherTime = booking.teacherLocalTime ?
          `æ•™å¸«æ™‚é–“: ${booking.teacherLocalTime}` :
          fmtDateWithTimezone(booking.startsAt, booking.teacher?.timezone || 'Asia/Taipei');

        const tr = el('tr', {},
          el('td', {}, booking.courseTitle || 'è‡ªç”±å°è©±'),
          el('td', {}, booking.teacher?.name || 'æœªçŸ¥è€å¸«'),
          el('td', {},
            el('div', {}, localTime),
            el('div', {class: 'muted', style: 'font-size:11px'}, teacherTime)
          ),
          el('td', {}, el('span', {class: 'status-chip status-upcoming'}, 'å³å°‡é–‹å§‹')),
          el('td', {},
            el('div', {class: 'row wrap'},
              el('button', {class: 'btn small'}, 'è©³æƒ…'),
              el('button', {class: 'btn small danger'}, 'å–æ¶ˆ')
            )
          )
        );
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      return table;
    }

    // é‡ç½®Demo
    async function resetDemo() {
      if (!currentUser || currentUser.role !== 'admin') {
        toast('æ­¤åŠŸèƒ½éœ€è¦ç®¡ç†å“¡æ¬Šé™');
        return;
      }

      if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰Demoè³‡æ–™å—ï¼Ÿ')) {
        return;
      }

      try {
        await apiRequest('/admin/reset-data', { method: 'POST' });
        toast('Demoè³‡æ–™å·²é‡ç½®');
      } catch (error) {
        toast('é‡ç½®å¤±æ•—ï¼š' + error.message);
      }
    }
  </script>
</body>
</html>
