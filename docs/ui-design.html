<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å®¶æ•™ç³»çµ± Demo</title>
  <style>
    /* Light theme */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --muted:#6b7280; --text:#111827;
      --brand:#2563eb; --brand-2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ok:#10b981; --border:#e5e7eb; --chip:#f3f4f6; --chip-2:#eef2ff;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji",
      "Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border); z-index:10;
    }
    .nav{display:flex; align-items:center; gap:12px; padding:10px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; color:#0b1420}
    .logo-badge{
      width:34px; height:34px; border-radius:8px; display:grid; place-items:center;
      color:#fff; background:linear-gradient(135deg,#22c55e,#16a34a); font-size:18px; font-weight:900;
      box-shadow:0 6px 16px rgba(34,197,94,.35), inset 0 0 10px rgba(255,255,255,.3);
    }
    .spacer{flex:1}
    .tabbar{display:flex; gap:6px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
      color:#374151; cursor:pointer; transition:.2s; font-size:14px;
    }
    .tab.active{background:#e8f5ff; border-color:#cde6ff; color:#0b4ea2}
    .search{display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border);
      padding:6px 10px; border-radius:12px; min-width:220px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:#111827}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#ffffff; color:#111827; cursor:pointer; transition:.15s;
      box-shadow:0 2px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; border-color:transparent; font-weight:700}
    .btn.success{background:linear-gradient(135deg,#34d399,#10b981); color:#fff; border:0; font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3b2700; border:0; font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#fda4a4,#ef4444); color:#fff; border:0; font-weight:700}
    .btn.ghost{background:#f3f4f6}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:13px}
    .btn.icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af; border:1px solid #e0e7ff}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--border); font-size:12px}
    .row{display:flex; gap:12px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .subtle{
      background:#f9fafb; border:1px dashed var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .title{font-size:18px; font-weight:800; margin:8px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#e5e7eb,transparent); margin:12px 0}
    /* Avatars */
    .avatar{
      width:54px; height:54px; border-radius:14px; background:linear-gradient(135deg,#e5f9f0,#d1fae5); border:1px solid var(--border);
      display:grid; place-items:center; font-weight:900; color:#065f46
    }
    .avatar.sm{width:36px; height:36px; border-radius:10px; font-size:14px}
    /* Layout */
    main{padding:10px}
    section[hidden]{display:none !important}
    /* Teacher cards */
    .teacher-card{display:flex; gap:12px}
    .teacher-card .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    /* Materials */
    .materials{display:grid; grid-template-columns:280px 1fr; gap:14px}
    .tree{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:10px; max-height:60vh; overflow:auto}
    .tree ul{list-style:none; padding-left:12px; margin:0}
    .tree li{margin:6px 0}
    .tree .node{display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; cursor:pointer}
    .tree .node.active{background:#eef2ff; border:1px solid #e0e7ff}
    .node .icon{width:22px; text-align:center}
    .content-pane{min-height:320px}
    .pdf{background:#f9fafb; border-radius:10px; padding:20px; border:1px solid var(--border)}
    /* Schedule */
    .date-strip{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .date-pill{min-width:110px; text-align:center; padding:8px; border-radius:12px; background:#f3f4f6; border:1px solid var(--border); cursor:pointer}
    .date-pill.active{background:#e0f2fe; border-color:#bae6fd}
    .slots{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .slot{padding:10px; border-radius:10px; border:1px solid var(--border); background:#ffffff; text-align:center; cursor:pointer}
    .slot.busy{opacity:.45; text-decoration:line-through; cursor:not-allowed}
    .slot.selected{outline:2px solid var(--brand)}
    /* Calendar */
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{border:1px solid var(--border); background:#ffffff; min-height:80px; border-radius:10px; padding:6px; position:relative}
    .cal-cell .dot{position:absolute; right:8px; bottom:6px; width:8px; height:8px; border-radius:50%}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#6b7280; text-align:center}
    .dot-blue{background:#3b82f6} .dot-orange{background:#f59e0b} .dot-gray{background:#6b7280}
    /* Modal & Toast */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:grid; place-items:center; z-index:20}
    .modal{background:var(--surface); border:1px solid var(--border); border-radius:16px; width:min(560px,92vw); padding:18px; box-shadow:var(--shadow)}
    .toast{position:fixed; right:14px; bottom:14px; background:var(--surface); border:1px solid var(--border); padding:12px 14px; border-radius:12px; z-index:30; box-shadow:var(--shadow)}
    /* Forms */
    label{font-size:13px; color:#6b7280}
    input,select,textarea{
      width:100%; background:#ffffff; color:#111827;
      border:1px solid var(--border); border-radius:10px; padding:10px; outline:none
    }
    textarea{min-height:80px; resize:vertical}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid > div{display:flex; flex-direction:column; gap:6px}
    /* Lists & tables */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:10px; background:#ffffff}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th{font-size:12px; text-transform:uppercase; color:#6b7280; background:#f9fafb; border-bottom:1px solid var(--border)}
    th, td{padding:12px; text-align:left}
    tr{border-bottom:1px solid var(--border)}
    tr:hover td{background:#fafafa}
    .hidden{display:none !important}
    /* Responsive */
    @media (max-width: 900px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .materials{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .slots{grid-template-columns:1fr}
      .search{min-width:unset; width:100%}
      .tabbar{width:100%; overflow:auto}
      th:nth-child(3), td:nth-child(3){white-space:nowrap}
    }
    .hint{font-size:12px; color:#6b7280}
    .welcome{
      background:linear-gradient(90deg,#16a34a,#15803d); color:#fff; border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .status-chip{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-upcoming{background:#dbeafe; color:#1d4ed8}
    .status-completed{background:#e5e7eb; color:#374151}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">TG</div>å®¶æ•™ç³»çµ± Demo</div>
      <div class="spacer"></div>
      <div id="searchBar" class="search hidden">
        <span>ğŸ”</span>
        <input id="globalSearch" placeholder="æœå°‹è€å¸«ã€æ“…é•·é ˜åŸŸã€åœ°å€â€¦" />
      </div>
      <div id="tabbar" class="tabbar"></div>
      <div class="spacer"></div>
      <button id="notifBtn" class="btn icon hidden" title="é€šçŸ¥">ğŸ””<span id="notifDot" class="badge hidden">0</span></button>
      <div id="userMenu" class="row">
        <button id="resetBtn" class="btn small ghost hidden">é‡ç½® Demo</button>
        <button id="loginBtn" class="btn primary">ç™»å…¥</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="view-login">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">ç™»å…¥</div>
          <div class="muted">ä½¿ç”¨ä¸‹æ–¹å¸³å¯†é«”é©—ä¸åŒè§’è‰²ï¼ˆadmin / student / teacherï¼‰ã€‚</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div><label>å¸³è™Ÿ</label><input id="login-username" placeholder="admin / student / teacher" /></div>
            <div><label>å¯†ç¢¼</label><input id="login-password" type="password" placeholder="åŒå¸³è™Ÿåç¨±" /></div>
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button id="login-submit" class="btn success">ç™»å…¥</button>
            <span class="hint">åˆæ¬¡é–‹å•Ÿæœƒè‡ªå‹•å»ºç«‹ç¤ºç¯„è³‡æ–™ã€‚</span>
          </div>
          <div class="hr"></div>
          <div class="chips">
            <button class="btn small" data-demo-fill="admin">å¡«å…¥ admin/admin</button>
            <button class="btn small" data-demo-fill="student">å¡«å…¥ student/student</button>
            <button class="btn small" data-demo-fill="teacher">å¡«å…¥ teacher/teacher</button>
          </div>
        </div>
        <div class="card">
          <div class="title">æœ¬ Demo ç‰¹è‰²</div>
          <ul>
            <li>æ¨è–¦æ•™å¸«ï¼šå¡ç‰‡æ¸…å–®ã€æ”¶è—ã€æŸ¥çœ‹ Profileã€é ç´„ã€‚</li>
            <li>æ•™æï¼šè³‡æ–™å¤¾æ¨¹ã€æ•™æé /æ¨¡æ“¬ PDFã€å¾æ•™æå¸¶å…¥é ç´„ã€‚</li>
            <li>é ç´„èª²è¡¨ï¼šåŠå°æ™‚åˆ‡ç‰‡ã€ç•™è¨€ã€è¡Œäº‹æ›† .icsã€‚</li>
            <li>æˆ‘çš„é ç´„ï¼šå…ˆåˆ—è¡¨ã€å¾Œæ—¥æ›†ï¼›å–æ¶ˆ/æ”¹æœŸã€è©•åƒ¹ã€‚</li>
            <li>è€å¸«ç«¯ï¼šå¯ç”¨æ™‚æ®µè¨­å®šã€é ç´„åˆ—è¡¨ã€ç›¸ç°¿ä¸Šå‚³ã€‚</li>
            <li>ç®¡ç†ç«¯ï¼šæ•™æç®¡ç†ã€æ•™å¸«ä¸Šæ¶ã€è©•åƒ¹å¯©æ ¸ã€‚</li>
            <li>é€šçŸ¥ä¸­å¿ƒï¼šé ç´„/å¯©æ ¸ç­‰äº‹ä»¶æ¨æ’­ã€‚</li>
          </ul>
          <div class="subtle">
            <b>æç¤ºï¼š</b>æ‰€æœ‰è³‡æ–™åƒ…å­˜æ–¼ç€è¦½å™¨ localStorageï¼Œé»ã€Œé‡ç½® Demoã€å¯å›åˆ°å‡ºå» ç‹€æ…‹ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- Teachers -->
    <section id="view-teachers" hidden>
      <div class="row wrap">
        <div class="title">æ¨è–¦æ•™å¸«</div>
        <span class="pill" id="courseContext">é ç´„èª²ç¨‹ï¼šè‡ªç”±å°è©±</span>
        <div class="spacer"></div>
        <div class="row wrap">
          <select id="filter-tag" class="pill">
            <option value="">å…¨éƒ¨é ˜åŸŸ</option>
            <option>å…’ç«¥è‹±èª</option>
            <option>æ—¥å¸¸è‹±èª</option>
            <option>å•†å‹™è‹±èª</option>
            <option>é›…æ€</option>
          </select>
          <select id="filter-region" class="pill">
            <option value="">å…¨éƒ¨åœ°å€</option>
            <option>å°åŒ—</option><option>å°ä¸­</option><option>é«˜é›„</option>
          </select>
          <select id="filter-sort" class="pill">
            <option value="rating">æ’åºï¼šè©•åˆ†</option>
            <option value="exp">æ’åºï¼šå¹´è³‡</option>
            <option value="soonest">æ’åºï¼šæœ€è¿‘å¯ç´„</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" id="teachersGrid"></div>
      <div class="hr"></div>
      <div class="card">
        <div class="row wrap">
          <div class="title">è‡ªç”±å°è©±ï¼ˆç³»çµ±æŒ‡æ´¾ï¼‰</div>
          <span class="muted">ä¸æŒ‡å®šè€å¸«ï¼Œç”±ç³»çµ±æŒ‡æ´¾åˆé©è€å¸«ã€‚</span>
          <div class="spacer"></div>
          <button id="anyScheduleBtn" class="btn">é¸æ“‡æ™‚æ®µ</button>
        </div>
      </div>
    </section>

    <!-- Teacher Profile -->
    <section id="view-teacher-profile" hidden></section>

    <!-- Materials -->
    <section id="view-materials" hidden>
      <div class="row wrap">
        <div class="title">æ•™æ</div>
        <div class="spacer"></div>
        <div id="materials-actions" class="row wrap hidden">
          <button class="btn small" data-mt-action="add-folder">ï¼‹ æ–°å¢è³‡æ–™å¤¾</button>
          <button class="btn small" data-mt-action="add-page">ï¼‹ æ–°å¢æ•™æé </button>
          <button class="btn small" data-mt-action="add-pdf">ï¼‹ æ–°å¢ PDF</button>
        </div>
      </div>
      <div class="materials">
        <div class="tree" id="materialsTree"></div>
        <div class="card content-pane" id="materialsContent"></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" hidden></section>

    <!-- Bookings -->
    <section id="view-bookings" hidden></section>

    <!-- Student Profile -->
    <section id="view-student" hidden></section>

    <!-- Teacher Dashboard -->
    <section id="view-teacher-dashboard" hidden></section>

    <!-- Admin -->
    <section id="view-admin" hidden></section>
  </main>

  <!-- Modal + Toast -->
  <div id="modalHost" class="modal-backdrop hidden"><div class="modal" id="modalBox"></div></div>
  <div id="toastHost" class="toast hidden"></div>

  <script>
  ;(() => {
    // ------- Utilities -------
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{
        if(k==='class') node.className=v;
        else if(k==='html') node.innerHTML=v;
        else if(k.startsWith('on') && typeof v==='function') node.addEventListener(k.substring(2), v);
        else if(v!==undefined) node.setAttribute(k,v);
      });
      children.forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    };
    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit', weekday:'short'});
    const fmtDateFull = d => new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const ymd = d => new Date(d).toISOString().substring(0,10);
    const addMin = (d, m)=> new Date(new Date(d).getTime()+m*60000);
    const rangeDays = (start, days)=> Array.from({length:days},(_,i)=> ymd(new Date(new Date(start).getTime()+i*86400000)));
    const uid = (p='id') => p + Math.random().toString(36).slice(2,9);
    const save = ()=> localStorage.setItem('TG_DEMO_L', JSON.stringify(DB));
    const load = ()=> JSON.parse(localStorage.getItem('TG_DEMO_L')||'null');
    const toast = (msg)=>{ const t=$("#toastHost"); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
    const openModal = (node)=>{ $("#modalBox").innerHTML=''; $("#modalBox").appendChild(node); $("#modalHost").classList.remove('hidden'); };
    const closeModal = ()=> $("#modalHost").classList.add('hidden');
    $("#modalHost").addEventListener('click', e=>{ if(e.target.id==='modalHost') closeModal(); });

    // ------- Seed demo data -------
    const seed = () => {
      const teachers = [
        {id:'t1', name:'Alice Wang', region:'å°åŒ—', exp:5, tags:['å…’ç«¥è‹±èª','æ—¥å¸¸è‹±èª'], langs:['ä¸­','è‹±'], rating:4.8, price:800, intro:'è¦ªåˆ‡æ´»æ½‘ã€å–„ç”¨éŠæˆ²åŒ–å¼•å°ï¼Œå°ˆæ³¨å…’ç«¥å£èªªèˆ‡è‡ªç„¶ç™¼éŸ³ã€‚', published:true},
        {id:'t2', name:'Ben Chen', region:'é«˜é›„', exp:8, tags:['å•†å‹™è‹±èª','é›…æ€'], langs:['ä¸­','è‹±'], rating:4.9, price:1200, intro:'åå¹´ä¼æ¥­å…§è¨“ç¶“é©—ï¼Œæ“…é•·ç°¡å ±èˆ‡æœƒè­°è‹±èªï¼›é›…æ€å£èªªæŒ‡å°ã€‚', published:true},
        {id:'t3', name:'Chloe Lin', region:'å°ä¸­', exp:3, tags:['æ—¥å¸¸è‹±èª'], langs:['ä¸­','è‹±','æ—¥'], rating:4.6, price:700, intro:'ç•™å­¸æ—¥æœ¬ï¼Œå–„æ–¼æœƒè©±æƒ…å¢ƒç·´ç¿’èˆ‡è·¨æ–‡åŒ–æºé€šã€‚', published:true},
      ];
      const users = {
        admin:{username:'admin', password:'admin', role:'admin', id:'u-admin', name:'ç³»çµ±ç®¡ç†å“¡'},
        student:{username:'student', password:'student', role:'student', id:'s1', name:'Student One', email:'student@example.com'},
        teacher:{username:'teacher', password:'teacher', role:'teacher', id:'t2', name:'Ben Chen'} // ç¶å®š t2
      };
      const materials = {
        id:'root', name:'å…¨éƒ¨æ•™æ', type:'folder', children:[
          {id:'free', name:'è‡ªç”±å°è©±ï¼ˆç„¡æ•™æï¼‰', type:'folder', children:[]},
          {id:'kids', name:'å…’ç«¥è‹±èª', type:'folder', children:[
            {id:'kids-p1', name:'å‹•ç‰©èˆ‡é¡è‰²ï¼ˆæ•™æé ï¼‰', type:'page', html:'<h2>å‹•ç‰©èˆ‡é¡è‰²</h2><p>å­¸ç¿’å¸¸è¦‹å‹•ç‰©èˆ‡é¡è‰²å½¢å®¹ã€‚</p>'},
            {id:'kids-pdf1', name:'å­—æ¯ç·´ç¿’ï¼ˆPDFï¼‰', type:'pdf'}
          ]},
          {id:'ielts', name:'é›…æ€', type:'folder', children:[
            {id:'ielts-p1', name:'å£èªªé«˜åˆ†ç­–ç•¥ï¼ˆæ•™æé ï¼‰', type:'page', html:'<h2>å£èªªç­–ç•¥</h2><p>ç­”æ¡ˆçµæ§‹ã€å»¶ä¼¸æŠ€å·§ã€‚</p>'}
          ]},
          {id:'daily', name:'æ—¥å¸¸è‹±èª', type:'folder', children:[
            {id:'daily-p1', name:'æ—…éŠæƒ…å¢ƒï¼ˆæ•™æé ï¼‰', type:'page', html:'<h2>æ—…éŠæƒ…å¢ƒ</h2><p>æ©Ÿå ´ã€é£¯åº—ã€é¤å»³å¸¸ç”¨å¥ã€‚</p>'}
          ]},
          {id:'biz', name:'å•†å‹™è‹±èª', type:'folder', children:[
            {id:'biz-p1', name:'Email å¯«ä½œï¼ˆæ•™æé ï¼‰', type:'page', html:'<h2>Email å¯«ä½œ</h2><p>æ¸…æ¥šä¸»é¡Œã€ç¦®è²Œçµèªèˆ‡è¡Œå‹•å‘¼ç±²ã€‚</p>'}
          ]}
        ]
      };
      // Availability: next 14 days half-hour slots
      const days = rangeDays(new Date(), 14);
      const genSlots = (morning=true, afternoon=true) => {
        const out=[]; const add=(hStart,hEnd)=>{ for(let h=hStart; h<hEnd; h++){ out.push(`${String(h).padStart(2,'0')}:00`); out.push(`${String(h).padStart(2,'0')}:30`);} };
        if(morning) add(9,12); if(afternoon) add(14,18); return out;
      };
      const availability = { t1:{}, t2:{}, t3:{} };
      days.forEach((d,i)=>{
        availability.t1[d]= genSlots(i%2===0, true);
        availability.t2[d]= genSlots(true, i%3!==0);
        availability.t3[d]= genSlots(i%2!==0, true);
      });
      // sample booking tomorrow
      const future1 = new Date(); future1.setDate(future1.getDate()+1); future1.setHours(17,0,0,0);
      const bk1 = {id:uid('bk'), studentId:'s1', teacherId:'t2', start:future1.toISOString(), duration:30, course:'è‡ªç”±å°è©±', message:'æƒ³ç·´ç¿’æœƒè­°è‹±æ–‡é–‹å ´', status:'scheduled', meet:'https://example.local/meet/ABCDE'};
      const reviews = [];
      const favorites = { s1: ['t2'] };
      const gallery = { t1:[], t2:[], t3:[] };
      return { users, teachers, materials, availability, bookings:[bk1], reviews, favorites, gallery, notifications:[], courseContext:null, currentUser:null };
    };
    let DB = load() || seed(); save();

    // ------- Router/UI -------
    const ROUTES = ['login','teachers','teacher-profile','materials','schedule','bookings','student','teacher-dashboard','admin'];
    const goto = (hash)=>{ location.hash = '#/'+hash; };
    const current = ()=> (location.hash.replace('#/','')||'login');
    const navTabs = () => {
      const role = DB.currentUser?.role;
      const bar = $("#tabbar"); bar.innerHTML='';
      const addTab = (key, label, opts={})=>{
        const b = el('button',{class:'tab','data-go':key}, label);
        if(current().startsWith(key)) b.classList.add('active');
        if(opts.hide) b.classList.add('hidden');
        bar.appendChild(b);
      };
      addTab('teachers','æ¨è–¦æ•™å¸«', {hide:!role});
      addTab('materials','æ•™æ', {hide:!role});
      addTab('bookings','æˆ‘çš„é ç´„', {hide:!role});
      if(role==='student') addTab('student','æˆ‘çš„è³‡æ–™');
      if(role==='teacher') addTab('teacher-dashboard','è€å¸«å¾Œå°');
      if(role==='admin') addTab('admin','ç®¡ç†å¾Œå°');
    };
    const headerUI = ()=>{
      const logged = !!DB.currentUser;
      $("#loginBtn").classList.toggle('hidden', logged);
      $("#searchBar").classList.toggle('hidden', !logged);
      $("#notifBtn").classList.toggle('hidden', !logged);
      $("#resetBtn").classList.toggle('hidden', !logged);
      if(logged){
        $("#userMenu").querySelector('#loginBtn')?.classList.add('hidden');
        const menu = $("#userMenu");
        menu.querySelector('#logoutBtn')?.remove();
        menu.appendChild(el('button',{id:'logoutBtn',class:'btn'}, `ç™»å‡ºï¼ˆ${DB.currentUser.name||DB.currentUser.username}ï¼‰`));
      }
      navTabs();
    };
    const pushNotif = (toRoleOrUserId, title, body) => {
      DB.notifications.push({id:uid('nt'), to:toRoleOrUserId, title, body, read:false, ts:new Date().toISOString()});
      save(); refreshNotifUI();
    };
    const refreshNotifUI = () => {
      const role = DB.currentUser?.role, uidC = DB.currentUser?.id;
      const list = DB.notifications.filter(n => n.to===role || n.to===uidC || n.to==='all');
      const unread = list.filter(n=>!n.read).length;
      const dot = $("#notifDot");
      if(unread>0){ dot.textContent=unread; dot.classList.remove('hidden'); } else { dot.classList.add('hidden'); }
    };

    // ------- Auth -------
    const doLogin = (u,p)=>{
      const user = Object.values(DB.users).find(x=>x.username===u && x.password===p);
      if(!user) return toast('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      DB.currentUser = { ...user };
      save();
      headerUI();
      goto('bookings'); // ç™»å…¥å­¸ç”Ÿæƒ…å¢ƒï¼Œç›´æ¥å°åˆ°æˆ‘çš„é ç´„
      render();
      toast(`æ­¡è¿ï¼Œ${DB.currentUser.name||DB.currentUser.username}`);
    };
    const doLogout = ()=>{
      DB.currentUser=null; save(); headerUI(); goto('login'); render();
    };

    // ------- Helpers -------
    const makeICS = (b)=>{
      const dt = new Date(b.start);
      const dtEnd = new Date(dt.getTime()+b.duration*60000);
      const toICS = (d)=> d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      const t = DB.teachers.find(x=>x.id===b.teacherId);
      const uidStr = `${b.id}@tg-demo.local`;
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//TG Demo//EN','CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        'UID:'+uidStr,
        'DTSTAMP:'+toICS(new Date()),
        'DTSTART:'+toICS(dt),
        'DTEND:'+toICS(dtEnd),
        'SUMMARY:'+`èˆ‡ ${t?.name||'è€å¸«'} çš„è‹±èªèª²`,
        'DESCRIPTION:'+ (b.course||'è‡ªç”±å°è©±') + 'ï¼›åŠ å…¥é€£çµï¼š' + b.meet,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics);
    };

    // ------- Pages -------
    function showOnly(id){
      ['view-login','view-teachers','view-teacher-profile','view-materials','view-schedule','view-bookings','view-student','view-teacher-dashboard','view-admin']
      .forEach(v => $( '#'+v ).hidden = (v!==id));
    }

    // Teachers page
    const renderTeachers = ()=>{
      showOnly('view-teachers');
      $("#courseContext").textContent = 'é ç´„èª²ç¨‹ï¼š' + (DB.courseContext?.name || 'è‡ªç”±å°è©±');
      const grid = $("#teachersGrid");
      const q = ($("#globalSearch").value||'').toLowerCase();
      const tag = $("#filter-tag").value||'';
      const region = $("#filter-region").value||'';
      const sort = $("#filter-sort").value||'rating';
      let items = DB.teachers.filter(t=>t.published);
      if(q) items = items.filter(t=> (t.name+t.region+t.tags.join('')).toLowerCase().includes(q));
      if(tag) items = items.filter(t=> t.tags.includes(tag));
      if(region) items = items.filter(t=> t.region===region);
      if(sort==='rating') items.sort((a,b)=> b.rating-a.rating);
      if(sort==='exp') items.sort((a,b)=> b.exp-a.exp);
      if(sort==='soonest'){
        const soon = id=>{
          const av = DB.availability[id]; const days = Object.keys(av).sort(); 
          for(const d of days){ const slots = av[d]; if(slots?.length) return new Date(`${d}T${slots[0]}:00`)-Date.now(); }
          return 1e15;
        };
        items.sort((a,b)=> soon(a.id)-soon(b.id));
      }
      grid.innerHTML='';
      items.forEach(t=>{
        const card = el('div',{class:'card teacher-card'},
          el('div',{class:'avatar',title:t.name}, t.name.split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase()),
          el('div',{}, 
            el('div',{class:'row wrap'},
              el('div',{class:'title'}, t.name),
              el('span',{class:'badge'}, `åœ°å€ï¼š${t.region}`),
              el('span',{class:'badge'}, `ç¶“é©—ï¼š${t.exp} å¹´`),
              el('span',{class:'badge'}, `è©•åˆ†ï¼š${t.rating.toFixed(1)}`)
            ),
            el('div',{class:'tags'}, ...t.tags.map(tag=> el('span',{class:'pill'}, tag))),
            el('div',{class:'muted'}, t.intro),
            el('div',{class:'actions'},
              el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, 'æŸ¥çœ‹ Profile'),
              el('button',{class:'btn small primary', onclick:()=>openSchedule(t.id)}, 'é ç´„'),
              DB.currentUser?.role==='student'
                ? el('button',{class:'btn small', onclick:()=>toggleFav(t.id)}, isFav(t.id)?'â˜… å·²æ”¶è—':'â˜† æ”¶è—')
                : null
            )
          )
        );
        grid.appendChild(card);
      });
    };
    const isFav = (tid)=> (DB.favorites[DB.currentUser?.id||'']||[]).includes(tid);
    const toggleFav = (tid)=>{
      if(!DB.currentUser || DB.currentUser.role!=='student') return toast('è«‹ä»¥å­¸ç”Ÿèº«åˆ†ç™»å…¥');
      const sid = DB.currentUser.id;
      DB.favorites[sid] ||= [];
      const i = DB.favorites[sid].indexOf(tid);
      if(i>=0) DB.favorites[sid].splice(i,1); else DB.favorites[sid].push(tid);
      save(); renderTeacherProfile(currentTeacherId||tid); renderTeachers();
      toast(i>=0?'å·²å–æ¶ˆæ”¶è—':'å·²æ”¶è—');
    };

    // Teacher Profile
    let currentTeacherId=null;
    const openTeacherProfile = (id)=>{ currentTeacherId=id; goto('teacher-profile/'+id); render(); };
    const renderTeacherProfile = (id)=>{
      showOnly('view-teacher-profile');
      const t = DB.teachers.find(x=>x.id===id);
      const wrap = $("#view-teacher-profile"); wrap.innerHTML='';
      if(!t) return wrap.appendChild(el('div',{class:'card'},'æ‰¾ä¸åˆ°è€å¸«'));
      const me = DB.currentUser;
      const myFav = me?.role==='student' ? isFav(id) : null;

      // Availability preview
      const av = DB.availability[id]||{};
      const days = Object.keys(av).sort().slice(0,7);
      const preview = el('div',{class:'row wrap'},
        ...days.map(d => el('div',{class:'pill'}, fmtDate(d)+'ï¼š'+ (av[d].slice(0,3).join('ã€') || 'â€”')))
      );

      // Gallery
      const gal = DB.gallery[id]||[];
      const galGrid = el('div',{class:'grid cols-3'}, ...(gal.length? gal.map(g=>{
        if(g.type.startsWith('image')) return el('img',{src:g.url, alt:g.name, style:'width:100%; border-radius:10px; border:1px solid var(--border)'}); 
        if(g.type.startsWith('video')) return el('video',{controls:true, src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'}); 
        if(g.type.startsWith('audio')) return el('audio',{controls:true, src:g.url, style:'width:100%'}); 
        return el('div',{class:'subtle'}, g.name);
      }) : [el('div',{class:'muted'},'å°šç„¡åª’é«”')]));

      const uploadRow = (me?.role==='teacher' && me.id===id)
        ? el('div',{class:'row wrap'}, 
            el('input',{type:'file', multiple:true, accept:'image/*,video/*,audio/*', onchange:(e)=>{
              const files = Array.from(e.target.files||[]);
              files.forEach(f=>{
                const url = URL.createObjectURL(f);
                DB.gallery[id].push({url, name:f.name, type:f.type});
              });
              save(); renderTeacherProfile(id); toast('å·²æ–°å¢åˆ°ç›¸ç°¿ï¼ˆç¤ºæ„ï¼‰');
            }}),
            el('span',{class:'hint'},'æ”¯æ´åœ–ç‰‡/éŸ³è¨Š/å½±ç‰‡ï¼Œåƒ…ç¤ºæ„ç”¨é€”ã€‚')
          )
        : null;

      // Reviews
      const allRv = DB.reviews.filter(r=>r.teacherId===id);
      const approved = allRv.filter(r=>r.status==='approved');
      const myRvs = allRv.filter(r=>r.studentId===me?.id);

      const rvList = approved.length ? approved.map(r=> el('div',{class:'item'},
        el('div',{}, `â­ ${r.rating}ï¼5`, el('div',{class:'muted'}, r.text)),
        el('div',{class:'muted'}, new Date(r.createdAt).toLocaleDateString())
      )) : [ el('div',{class:'muted'}, 'å°šç„¡å…¬é–‹è©•åƒ¹') ];

      const myRvList = myRvs.length ? myRvs.map(r=> el('div',{class:'item'},
        el('div',{}, `æˆ‘çµ¦çš„è©•åˆ†ï¼š${r.rating}ï¼Œ${r.text}`),
        el('span',{class:'badge'}, r.status==='pending'?'å¯©æ ¸ä¸­': r.status==='rejected'? 'æœªé€šé' : 'å·²å…¬é–‹')
      )) : null;

      wrap.appendChild(el('div',{class:'grid cols-3'},
        el('div',{class:'card'},
          el('div',{class:'row wrap'},
            el('div',{class:'avatar'}, t.name[0]),
            el('div',{},
              el('div',{class:'title'}, t.name),
              el('div',{class:'chips'},
                el('span',{class:'badge'}, `åœ°å€ï¼š${t.region}`),
                el('span',{class:'badge'}, `å¹´è³‡ï¼š${t.exp} å¹´`),
                el('span',{class:'badge'}, `è©•åˆ†ï¼š${t.rating.toFixed(1)}`)
              )
            ),
            el('div',{class:'spacer'}),
            el('div',{class:'row wrap'},
              el('button',{class:'btn primary small', onclick:()=>openSchedule(id)},'ä¸€éµé ç´„'),
              me?.role==='student' ? el('button',{class:'btn small', onclick:()=>toggleFav(id)}, myFav?'â˜… å·²æ”¶è—':'â˜† æ”¶è—') : null
            )
          ),
          el('div',{class:'tags', style:'margin-top:6px'}, ...t.tags.map(x=> el('span',{class:'pill'},x))),
          el('div',{class:'hr'}),
          el('div',{}, el('b',{},'è‡ªæˆ‘ä»‹ç´¹'), el('div',{class:'muted'}, t.intro)),
          el('div',{class:'hr'}),
          el('div',{}, el('b',{},'å¯ç”¨æ™‚æ®µï¼ˆæ‘˜è¦ï¼‰'), preview),
          el('div',{class:'hr'}),
          el('div',{}, el('button',{class:'btn small', onclick:()=>goto('teachers')},'è¿”å›æ¨è–¦æ•™å¸«'))
        ),
        el('div',{class:'card', style:'grid-column: span 2'},
          el('div',{class:'row wrap'},
            el('div',{class:'title'}, 'ç›¸ç°¿ / åª’é«”'),
            el('div',{class:'spacer'}), uploadRow
          ),
          galGrid
        ),
        el('div',{class:'card', style:'grid-column: span 3'},
          el('div',{class:'row wrap'},
            el('div',{class:'title'}, 'å­¸å“¡è©•åƒ¹'),
            el('span',{class:'hint'}, 'åƒ…é¡¯ç¤ºç®¡ç†å“¡å¯©æ ¸é€šéä¹‹å…§å®¹')
          ),
          el('div',{class:'list'}, ...rvList),
          myRvList ? el('div',{}, el('div',{class:'hr'}), el('b',{},'æˆ‘ç•™ä¸‹çš„è©•åƒ¹'), el('div',{class:'list'}, ...myRvList)) : null
        )
      ));
    };

    // Materials page
    let currentMaterialId=null;
    const findNode = (id, node=DB.materials)=> {
      if(node.id===id) return node;
      if(node.children) for(const c of node.children){ const r=findNode(id,c); if(r) return r; }
      return null;
    };
    const renderMaterialsTree = (node=DB.materials, activeId=currentMaterialId)=>{
      const ul = el('ul');
      const rec = (n)=>{
        const li = el('li');
        const icon = n.type==='folder'?'ğŸ“':(n.type==='pdf'?'ğŸ“„':'ğŸ“˜');
        const nodeEl = el('div',{class:'node'+(n.id===activeId?' active':''), onclick:()=>{currentMaterialId=n.id; renderMaterials();}}, el('span',{class:'icon'}, icon), el('span',{}, n.name));
        li.appendChild(nodeEl);
        if(n.children?.length){
          const sub = el('ul');
          n.children.forEach(ch=> sub.appendChild(rec(ch)));
          li.appendChild(sub);
        }
        return li;
      };
      ul.appendChild(rec(node));
      $("#materialsTree").innerHTML=''; $("#materialsTree").appendChild(ul);
    };
    const renderMaterialsContent = ()=>{
      const pane = $("#materialsContent"); pane.innerHTML='';
      const node = findNode(currentMaterialId)||DB.materials;
      pane.appendChild(el('div',{class:'title'}, node.name));
      if(node.type==='page'){
        const box = el('div',{class:'card', html: node.html||'<p>ï¼ˆæ•™æé å…§å®¹ï¼‰</p>'});
        pane.appendChild(box);
        pane.appendChild(el('div',{class:'row wrap'},
          el('button',{class:'btn primary', onclick:()=>{ DB.courseContext={id:node.id, name:node.name}; save(); goto('teachers'); render(); toast('å·²å¸¶å…¥æ•™æè‡³é ç´„æµç¨‹'); }}, 'é ç´„è€å¸«'),
          el('span',{class:'hint'}, 'å°‡å¸¶å…¥æ¨è–¦æ•™å¸«é ï¼Œä¸¦æ–¼é ç´„æ™‚è‡ªå‹•å¡«å…¥æ•™æ')
        ));
      } else if(node.type==='pdf'){
        pane.appendChild(el('div',{class:'pdf'}, el('div',{class:'title'}, 'PDF æª”æ¡ˆé è¦½'), el('div',{class:'muted'}, 'æ­¤ç‚ºç¤ºæ„ PDF å€å¡Š')));
        pane.appendChild(el('div',{class:'row wrap'}, el('button',{class:'btn primary', onclick:()=>{ DB.courseContext={id:node.id, name:node.name}; save(); goto('teachers'); render(); }}, 'é ç´„è€å¸«')));
      } else if(node.type==='folder'){
        pane.appendChild(el('div',{class:'muted'}, node.id==='free' ? 'æ­¤è³‡æ–™å¤¾æ²’æœ‰æ•™æå…§å®¹ï¼Œå¯ç›´æ¥è‡ªç”±å°è©±ç·´ç¿’ã€‚' : 'é¸æ“‡å·¦å´å­é …ç›®ç€è¦½å…§å®¹ã€‚'));
        pane.appendChild(el('div',{class:'row wrap'}, el('button',{class:'btn', onclick:()=>{ DB.courseContext={id:node.id, name: node.name.includes('è‡ªç”±å°è©±')?'è‡ªç”±å°è©±':node.name}; save(); goto('teachers'); render(); }}, 'é ç´„è€å¸«')));
      }
      if(DB.currentUser?.role==='admin' && node.id!=='root'){
        pane.appendChild(el('div',{class:'hr'}));
        pane.appendChild(el('div',{class:'row wrap'},
          el('button',{class:'btn small warn', onclick:()=>{ const newName=prompt('æ›´åç‚ºï¼š', node.name); if(!newName) return; node.name=newName; save(); renderMaterials(); }}, 'é‡æ–°å‘½å'),
          el('button',{class:'btn small danger', onclick:()=>{ if(confirm('åˆªé™¤æ­¤ç¯€é»ï¼Ÿ')){ deleteNode(node.id, DB.materials); save(); currentMaterialId='root'; renderMaterials(); }}}, 'åˆªé™¤ç¯€é»')
        ));
      }
    };
    const deleteNode = (id, node)=>{
      if(!node.children) return false;
      const idx = node.children.findIndex(c=>c.id===id);
      if(idx>=0){ node.children.splice(idx,1); return true; }
      for(const c of node.children){ if(deleteNode(id,c)) return true; }
      return false;
    };
    const renderMaterials = ()=>{
      showOnly('view-materials');
      $("#materials-actions").classList.toggle('hidden', DB.currentUser?.role!=='admin');
      renderMaterialsTree(DB.materials, currentMaterialId||'root');
      renderMaterialsContent();
    };

    // Schedule page
    const openSchedule = (teacherId)=>{ goto('schedule/'+teacherId); render(); };
    const renderSchedule = (teacherId)=>{
      showOnly('view-schedule');
      const wrap = $("#view-schedule"); wrap.innerHTML='';
      if(teacherId==='any') return renderScheduleAny();
      const t = DB.teachers.find(x=>x.id===teacherId);
      const av = DB.availability[teacherId]||{};
      const days = Object.keys(av).sort().slice(0,10);
      let activeDay = days.find(d=> (av[d]||[]).length) || days[0];

      const head = el('div',{class:'card'},
        el('div',{class:'row wrap'},
          el('div',{class:'avatar'}, t.name[0]),
          el('div',{}, el('div',{class:'title'}, `é ç´„ï¼š${t.name}`), el('div',{class:'muted'}, 'ä»¥å­¸ç”Ÿæ™‚å€é¡¯ç¤º')),
          el('div',{class:'spacer'}),
          el('button',{class:'btn', onclick:()=>openTeacherProfile(teacherId)}, 'æŸ¥çœ‹è€å¸« Profile')
        ),
        el('div',{class:'hr'}),
        el('div',{class:'date-strip', id:'dateStrip'})
      );
      wrap.appendChild(head);

      const slotsBox = el('div',{class:'card'}, el('div',{class:'title'}, 'é¸æ“‡æ™‚æ®µ'), el('div',{id:'slots', class:'slots'}));
      wrap.appendChild(slotsBox);

      const redrawDates=()=>{
        const strip = $("#dateStrip"); strip.innerHTML='';
        days.forEach(d=>{
          const has = (av[d]||[]).length;
          strip.appendChild(el('div',{class:'date-pill'+(d===activeDay?' active':''), onclick:()=>{activeDay=d; redrawDates(); redrawSlots();}}, fmtDate(d), el('div',{class:'hint'}, has?`${has} æª”ä½`:'ç„¡å¯ç´„')));
        });
      };
      const redrawSlots=()=>{
        const box = $("#slots"); box.innerHTML='';
        const daySlots = (av[activeDay]||[]);
        if(!daySlots.length){ box.appendChild(el('div',{class:'muted'},'æ­¤æ—¥ç„¡å¯é ç´„æ™‚æ®µ')); return; }
        const busyStarts = DB.bookings.filter(b=>b.teacherId===teacherId && ymd(b.start)===activeDay && b.status==='scheduled').map(b=> new Date(b.start).toTimeString().substring(0,5));
        daySlots.forEach(ti=>{
          const isBusy = busyStarts.includes(ti);
          box.appendChild(el('div',{class:'slot'+(isBusy?' busy':''), onclick:()=>{ if(isBusy) return; confirmBooking(teacherId, activeDay, ti); }}, ti));
        });
      };
      redrawDates(); redrawSlots();
    };
    const renderScheduleAny = ()=>{
      showOnly('view-schedule');
      const wrap = $("#view-schedule"); wrap.innerHTML='';
      wrap.appendChild(el('div',{class:'card'},
        el('div',{class:'title'},'è‡ªç”±å°è©±ï¼ˆç³»çµ±æŒ‡æ´¾ï¼‰'),
        el('div',{class:'muted'},'æœ€è¿‘ 3 å¤©å¯é ç´„æ™‚æ®µï¼Œé¸æ“‡å¾Œç³»çµ±è‡ªå‹•æŒ‡æ´¾è€å¸«ã€‚')
      ));
      const list = [];
      const days = rangeDays(new Date(), 3);
      days.forEach(d=>{
        DB.teachers.forEach(t=>{
          if(!t.published) return;
          const slots = (DB.availability[t.id]?.[d]||[]).slice(0,4);
          const busy = DB.bookings.filter(b=>b.teacherId===t.id && ymd(b.start)===d && b.status==='scheduled').map(b=> new Date(b.start).toTimeString().substring(0,5));
          slots.filter(s=>!busy.includes(s)).forEach(s=> list.push({teacherId:t.id, teacher:t.name, day:d, time:s}));
        });
      });
      list.sort((a,b)=> new Date(`${a.day}T${a.time}:00`) - new Date(`${b.day}T${b.time}:00`));
      const box = el('div',{class:'card'}, el('div',{class:'title'},'é¸æ“‡æ™‚æ®µ'));
      const ul = el('div',{class:'list'});
      if(list.length===0) ul.appendChild(el('div',{class:'muted'},'ç›®å‰ç„¡å¯ç´„æ™‚æ®µ'));
      list.forEach(x=>{
        ul.appendChild(el('div',{class:'item'},
          el('div',{}, `${fmtDate(x.day)} ${x.time}`, el('div',{class:'muted'}, `è€å¸«ï¼š${x.teacher}`)),
          el('button',{class:'btn small primary', onclick:()=>confirmBooking(x.teacherId, x.day, x.time)}, 'é ç´„')
        ));
      });
      box.appendChild(ul); wrap.appendChild(box);
    };
    const confirmBooking = (teacherId, day, time, editingBookingId=null)=>{
      const t = DB.teachers.find(x=>x.id===teacherId);
      const startISO = new Date(`${day}T${time}:00`).toISOString();
      const panel = el('div',{},
        el('div',{class:'row wrap'},
          el('div',{class:'title'}, editingBookingId?'ç¢ºèªæ”¹æœŸ':'ç¢ºèªé ç´„'),
          el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal},'âœ–ï¸')
        ),
        el('div',{class:'muted'},`æ™‚é–“ï¼š${fmtDateFull(startISO)}ï¼ˆä»¥å­¸ç”Ÿæ™‚å€é¡¯ç¤ºï¼‰`),
        el('div',{class:'muted'},`è€å¸«ï¼š${t?.name||'ï¼ˆç³»çµ±æŒ‡æ´¾ï¼‰'}`),
        el('div',{class:'hr'}),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'èª²ç¨‹/æ•™æ'), (()=>{
            const sel = el('select',{id:'courseSel'});
            const opt1 = el('option',{}, DB.courseContext?.name||'è‡ªç”±å°è©±'); sel.appendChild(opt1);
            if(DB.courseContext?.name!=='è‡ªç”±å°è©±') sel.appendChild(el('option',{}, 'è‡ªç”±å°è©±'));
            ['å…’ç«¥è‹±èª','æ—¥å¸¸è‹±èª','å•†å‹™è‹±èª','é›…æ€'].forEach(n=> sel.appendChild(el('option',{}, n)));
            return sel;
          })()),
          el('div',{}, el('label',{},'æ™‚é•·ï¼ˆåˆ†é˜ï¼‰'), (()=>{
            const sel = el('select',{id:'durSel'}); [30,60].forEach(n=> sel.appendChild(el('option',{value:n}, n))); return sel;
          })())
        ),
        el('div',{}, el('label',{},'ç•™è¨€çµ¦è€å¸«'), el('textarea',{id:'msgBox', placeholder:'æƒ³å…ˆè®“è€å¸«äº†è§£ä»€éº¼ï¼Ÿï¼ˆé¸å¡«ï¼‰'})),
        el('div',{class:'hr'}),
        el('div',{class:'row wrap'},
          el('button',{class:'btn success', onclick:()=>{
            if(!DB.currentUser || DB.currentUser.role!=='student'){ toast('è«‹ä»¥å­¸ç”Ÿèº«åˆ†ç™»å…¥'); closeModal(); return; }
            const studentId = DB.currentUser.id;
            const duration = Number($("#durSel").value)||30;
            const course = $("#courseSel").value || (DB.courseContext?.name||'è‡ªç”±å°è©±');
            const message = $("#msgBox").value||'';
            if(editingBookingId){
              const bk = DB.bookings.find(b=>b.id===editingBookingId);
              if(!bk) return;
              bk.start=startISO; bk.duration=duration; bk.course=course; bk.message=message; save();
              pushNotif(bk.teacherId, 'å­¸ç”Ÿæ”¹æœŸ', `å­¸ç”Ÿå·²å°‡é ç´„æ”¹åˆ° ${fmtDateFull(startISO)}`);
              pushNotif(studentId, 'æ”¹æœŸæˆåŠŸ', `å·²æ”¹åˆ° ${fmtDateFull(startISO)}`);
              toast('æ”¹æœŸæˆåŠŸ'); closeModal(); goto('bookings'); render();
              return;
            }
            const booking = { id:uid('bk'), studentId, teacherId, start:startISO, duration, course, message, status:'scheduled', meet:'https://example.local/meet/'+uid('M').slice(-5) };
            DB.bookings.push(booking); save();
            pushNotif(teacherId, 'æœ‰æ–°çš„é ç´„', `${DB.currentUser.name||'å­¸ç”Ÿ'} é ç´„äº† ${fmtDateFull(startISO)} çš„èª²ç¨‹`);
            pushNotif(studentId, 'é ç´„æˆåŠŸ', `èˆ‡ ${t.name} çš„èª²å·²ç¢ºèªï¼š${fmtDateFull(startISO)}`);
            toast('é ç´„æˆåŠŸï¼å·²åŠ å…¥ã€Œæˆ‘çš„é ç´„ã€');
            closeModal(); goto('bookings'); render();
          }}, editingBookingId?'ç¢ºèªæ”¹æœŸ':'ç¢ºèªé ç´„'),
          el('span',{class:'hint'},'èª²å‰ 2 å°æ™‚å…§ä¸å¯å–æ¶ˆï¼ˆç¤ºæ„æ”¿ç­–ï¼‰')
        )
      );
      openModal(panel);
    };

    // ------- Student Bookings (List first, then Calendar) -------
    const renderBookings = ()=>{
      showOnly('view-bookings');
      const role = DB.currentUser?.role;
      if(role==='teacher') return renderTeacherBookings();

      const wrap = $("#view-bookings"); wrap.innerHTML='';

      // Welcome banner
      wrap.appendChild(el('div',{class:'welcome'},
        el('h1',{style:'margin:0; font-size:20px; font-weight:800'}, `æ­¡è¿å›ä¾†ï¼Œ${DB.currentUser.name||'å­¸ç”Ÿ'}ï¼`),
        el('p',{style:'margin:6px 0 0; color:#e7ffe7'}, 'æº–å‚™å¥½é–‹å§‹ä»Šå¤©çš„å­¸ç¿’ä¹‹æ—…äº†å—ï¼Ÿ')
      ));

      const sid = DB.currentUser.id;
      const my = DB.bookings.filter(b=>b.studentId===sid && b.status!=='cancelled');
      const upcoming = my.filter(b=> new Date(b.start)>=new Date() && b.status==='scheduled').sort((a,b)=> new Date(a.start)-new Date(b.start));
      const completed = my.filter(b=> b.status==='completed').sort((a,b)=> new Date(b.start)-new Date(a.start));

      // 1) List view: ç•¶å‰é ç´„
      const listCard = el('div',{class:'card', style:'margin-top:16px'},
        el('div',{class:'row wrap'},
          el('h2',{class:'title', style:'margin:0'}, 'ç•¶å‰é ç´„'),
          el('div',{class:'spacer'}),
          el('button',{class:'btn small ghost', onclick:()=>goto('teachers')}, 'å»é ç´„æ›´å¤š')
        ),
        (()=>{
          if(upcoming.length===0) return el('div',{class:'muted', style:'padding:12px'}, 'ç›®å‰æ²’æœ‰å³å°‡åˆ°ä¾†çš„èª²ç¨‹');
          const table = el('table');
          const thead = el('thead',{}, el('tr',{},
            el('th',{},'èª²ç¨‹'), el('th',{},'è€å¸«'), el('th',{},'æ™‚é–“'), el('th',{},'ç‹€æ…‹'), el('th',{},'æ“ä½œ')
          ));
          const tbody = el('tbody');
          upcoming.forEach(b=>{
            const t = DB.teachers.find(x=>x.id===b.teacherId);
            const tr = el('tr',{},
              el('td',{}, el('div',{style:'font-weight:600'}, b.course||'è‡ªç”±å°è©±')),
              el('td',{}, el('div',{}, t?.name||'(æœªçŸ¥è€å¸«)')),
              el('td',{}, el('div',{}, new Date(b.start).toLocaleString('zh-TW', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) )),
              el('td',{}, el('span',{class:'status-chip status-upcoming'}, 'å³å°‡é–‹å§‹')),
              el('td',{},
                el('div',{class:'row wrap'},
                  el('a',{class:'btn small', href:makeICS(b), download:`booking-${b.id}.ics`}, 'åŠ å…¥è¡Œäº‹æ›†'),
                  el('button',{class:'btn small', onclick:()=>openSchedule(b.teacherId)}, 'æ”¹æœŸ'),
                  el('button',{class:'btn small danger', onclick:()=>cancelBooking(b.id)}, 'å–æ¶ˆ'),
                  el('a',{class:'btn small primary', href:b.meet, target:'_blank'}, 'é€²å…¥èª²ç¨‹')
                )
              )
            );
            tbody.appendChild(tr);
          });
          table.appendChild(thead); table.appendChild(tbody);
          return el('div',{}, table);
        })()
      );
      wrap.appendChild(listCard);

      // 2) Calendar view: æœ¬æœˆèª²ç¨‹
      const now = new Date(); const y = now.getFullYear(), m = now.getMonth();
      const firstDay = new Date(y,m,1), startIdx = firstDay.getDay(); // 0..6
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const eventsByDay = {};
      my.forEach(b=>{ const d= ymd(b.start); (eventsByDay[d] ||= []).push(b); });
      const calCard = el('div',{class:'grid cols-2', style:'margin-top:16px'},
        el('div',{class:'card', style:'grid-column: span 2'},
          el('div',{class:'row wrap'},
            el('h2',{class:'title', style:'margin:0'}, 'æœ¬æœˆèª²ç¨‹æ—¥æ›†'),
            el('div',{class:'spacer'}), el('span',{class:'hint'}, `${y} å¹´ ${m+1} æœˆ`)
          ),
          el('div',{class:'cal-head'}, ...['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(x=> el('div',{},x))),
          (()=>{
            const grid = el('div',{class:'calendar'});
            for(let i=0;i<startIdx;i++) grid.appendChild(el('div',{class:'cal-cell', style:'background:#f9fafb'}));
            for(let d=1; d<=daysInMonth; d++){
              const dateStr = ymd(new Date(y,m,d));
              const has = eventsByDay[dateStr]?.length;
              const comps = (eventsByDay[dateStr]||[]).filter(b=>b.status==='completed').length;
              const upcomingCnt = (eventsByDay[dateStr]||[]).filter(b=>b.status==='scheduled').length;
              grid.appendChild(el('div',{class:'cal-cell'},
                String(d),
                has? el('div',{class:'dot '+(upcomingCnt?'dot-orange': comps?'dot-gray':'dot-blue')}) : null
              ));
            }
            return grid;
          })(),
          el('div',{class:'row wrap', style:'justify-content:center; gap:16px; margin-top:8px; color:#4b5563; font-size:12px'},
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#3b82f6'}), ' ä»Šå¤©'),
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#f59e0b'}), ' å·²é ç´„'),
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#6b7280'}), ' å·²å®Œæˆ')
          )
        )
      );
      wrap.appendChild(calCard);

      // 3) Completed list with review action (ä¿ç•™)
      if(completed.length){
        const rvCard = el('div',{class:'card', style:'margin-top:16px'},
          el('div',{class:'title'}, 'å·²å®Œæˆèª²ç¨‹èˆ‡è©•åƒ¹'),
          el('div',{class:'list'}, ...completed.map(b=>{
            const t = DB.teachers.find(x=>x.id===b.teacherId);
            const existing = DB.reviews.find(r=>r.bookingId===b.id && r.studentId===sid);
            return el('div',{class:'item'},
              el('div',{}, `${fmtDateFull(b.start)} Â· ${t?.name}`, el('div',{class:'muted'}, b.course)),
              existing ? el('span',{class:'badge'}, 'å·²æäº¤è©•åƒ¹ï¼ˆ'+existing.status+'ï¼‰')
              : el('button',{class:'btn small primary', onclick:()=>leaveReview(b)}, 'ç•™ä¸‹è©•åƒ¹')
            );
          }))
        );
        wrap.appendChild(rvCard);
      }

      // Demo å¿«é€Ÿå®Œæˆä¸‹ä¸€ç­†
      const nextBk = upcoming[0];
      if(nextBk){
        wrap.appendChild(el('div',{class:'subtle', style:'margin-top:14px'},
          el('div',{class:'row wrap'},
            el('div',{}, 'Demo å¿«é€Ÿæ“ä½œï¼š'),
            el('button',{class:'btn small warn', onclick:()=>{ nextBk.status='completed'; save(); toast('å·²æ¨™è¨˜è©²èª²ç‚ºã€Œå·²å®Œæˆã€'); render(); }}, 'æ¨™è¨˜ä¸‹ä¸€å ‚èª²ç‚ºå·²å®Œæˆ')
          ),
          el('div',{class:'hint'}, 'åƒ…ç‚ºå±•ç¤ºè©•åƒ¹æµç¨‹ï¼Œå¯¦å‹™ä¸Šæ–¼èª²å¾Œè‡ªå‹•è®Šæ›´ç‹€æ…‹ã€‚')
        ));
      }
    };
    const cancelBooking = (id)=>{
      const bk = DB.bookings.find(b=>b.id===id);
      if(!bk) return;
      const diffH = (new Date(bk.start)-new Date())/3600000;
      if(diffH<2) { toast('èª²å‰ 2 å°æ™‚å…§ä¸å¯å–æ¶ˆ'); return; }
      if(confirm('ç¢ºèªå–æ¶ˆé€™ç­†é ç´„ï¼Ÿ')){
        bk.status='cancelled'; save();
        pushNotif(bk.teacherId,'å­¸ç”Ÿå–æ¶ˆé ç´„',`${DB.currentUser.name||'å­¸ç”Ÿ'} å–æ¶ˆäº† ${fmtDateFull(bk.start)} çš„èª²`);
        pushNotif(bk.studentId,'å–æ¶ˆæˆåŠŸ',`å·²å–æ¶ˆèˆ‡è€å¸«çš„èª²ï¼ˆ${fmtDateFull(bk.start)}ï¼‰`);
        render();
      }
    };
    const leaveReview = (booking)=>{
      const t = DB.teachers.find(x=>x.id===booking.teacherId);
      const box = el('div',{},
        el('div',{class:'row wrap'},
          el('div',{class:'title'}, 'ç•™ä¸‹è©•åƒ¹'),
          el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal}, 'âœ–ï¸')
        ),
        el('div',{class:'muted'}, `è€å¸«ï¼š${t.name} Â· æ™‚é–“ï¼š${fmtDateFull(booking.start)}`),
        el('div',{class:'hr'}),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'è©•åˆ†ï¼ˆ1-5ï¼‰'), (()=>{
            const s=el('select',{id:'rvScore'}); [5,4,3,2,1].forEach(n=> s.appendChild(el('option',{value:n}, n))); return s;
          })()),
          el('div',{}, el('label',{},'å¿ƒå¾—ï¼ˆå¯é¸ï¼‰'), el('input',{id:'rvText', placeholder:'é€™å ‚èª²å°æˆ‘æœ€æœ‰å¹«åŠ©çš„æ˜¯â€¦'}))
        ),
        el('div',{class:'hr'}),
        el('button',{class:'btn success', onclick:()=>{
          const rv = { id:uid('rv'), bookingId:booking.id, studentId:booking.studentId, teacherId:booking.teacherId, rating:Number($("#rvScore").value), text:$("#rvText").value||'ï¼ˆæœªå¡«ï¼‰', status:'pending', createdAt:new Date().toISOString() };
          DB.reviews.push(rv); save(); closeModal();
          pushNotif('admin','æœ‰æ–°çš„è©•åƒ¹å¾…å¯©æ ¸',`å­¸ç”Ÿå° ${t.name} æäº¤äº†è©•åƒ¹`);
          toast('å·²æäº¤ï¼Œå¾…ç®¡ç†å“¡å¯©æ ¸'); render();
        }}, 'é€å‡º')
      );
      openModal(box);
    };

    // Teacher bookings (teacher view)
    const renderTeacherBookings = ()=>{
      const wrap = $("#view-bookings"); wrap.innerHTML='';
      const tid = DB.currentUser.id;
      const my = DB.bookings.filter(b=>b.teacherId===tid && b.status!=='cancelled').sort((a,b)=> new Date(a.start)-new Date(b.start));
      wrap.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'æˆ‘çš„é ç´„ï¼ˆè€å¸«ç«¯ï¼‰'), el('div',{class:'hint'},'å¯åœ¨ã€Œå¯ç”¨æ™‚æ®µè¨­å®šã€æ›´æ–°å¯é ç´„æª”ä½')));
      const list = el('div',{class:'list'});
      if(my.length===0) list.appendChild(el('div',{class:'muted'},'ç›®å‰æ²’æœ‰é ç´„'));
      my.forEach(b=>{
        const stu = Object.values(DB.users).find(u=>u.id===b.studentId);
        list.appendChild(el('div',{class:'item'},
          el('div',{}, `${fmtDateFull(b.start)} Â· å­¸ç”Ÿï¼š${stu?.name||'ï¼ˆæœªçŸ¥ï¼‰'}`, el('div',{class:'muted'}, `${b.course} Â· å‚™è¨»ï¼š${b.message||'â€”'}`)),
          el('div',{class:'row wrap'},
            el('button',{class:'btn small', onclick:()=>{ confirmBooking(b.teacherId, ymd(b.start), new Date(b.start).toTimeString().substring(0,5), b.id); }}, 'æè­°æ”¹æœŸ'),
            el('button',{class:'btn small danger', onclick:()=>{ b.status='cancelled'; save(); pushNotif(b.studentId,'è€å¸«å–æ¶ˆé ç´„', `è€å¸«å–æ¶ˆäº† ${fmtDateFull(b.start)} çš„èª²`); toast('å·²å–æ¶ˆ'); render(); }}, 'å–æ¶ˆ')
          )
        ));
      });
      wrap.appendChild(el('div',{class:'card', style:'margin-top:12px'}, list));
    };

    // Student profile
    const renderStudent = ()=>{
      showOnly('view-student');
      const u = DB.users.student;
      const favs = DB.favorites[u.id]||[];
      const wrap = $("#view-student"); wrap.innerHTML='';
      const form = el('div',{class:'card'},
        el('div',{class:'title'}, 'æˆ‘çš„è³‡æ–™ï¼ˆå­¸ç”Ÿï¼‰'),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'å§“å'), el('input',{id:'st-name', value:u.name||''})),
          el('div',{}, el('label',{},'è‹±æ–‡æš±ç¨±'), el('input',{id:'st-nick', value:u.nick||''})),
          el('div',{}, el('label',{},'ç”Ÿæ—¥'), el('input',{id:'st-bday', type:'date', value:u.bday||''})),
          el('div',{}, el('label',{},'Email'), el('input',{id:'st-email', value:u.email||''})),
          el('div',{}, el('label',{},'ä¸Šèª²æ™‚æ®µåå¥½'), (()=>{
            const s=el('select',{id:'st-pref-time'}); ['å¹³æ—¥æ—©ä¸Š','å¹³æ—¥ä¸‹åˆ','å¹³æ—¥æ™šä¸Š','é€±æœ«'].forEach(n=> s.appendChild(el('option',{selected:u.prefTime===n}, n))); return s;
          })()),
          el('div',{}, el('label',{},'èª²ç¨‹é¡å‹åå¥½'), (()=>{
            const s=el('select',{id:'st-pref-type'}); ['è‡ªç”±å°è©±','å…’ç«¥è‹±èª','æ—¥å¸¸è‹±èª','å•†å‹™è‹±èª','é›…æ€'].forEach(n=> s.appendChild(el('option',{selected:u.prefType===n}, n))); return s;
          })())
        ),
        el('div',{class:'row wrap', style:'margin-top:10px'},
          el('button',{class:'btn success', onclick:()=>{
            Object.assign(u,{ name:$("#st-name").value, nick:$("#st-nick").value, bday:$("#st-bday").value, email:$("#st-email").value, prefTime:$("#st-pref-time").value, prefType:$("#st-pref-type").value });
            save(); toast('å·²å„²å­˜');
          }}, 'å„²å­˜')
        )
      );
      const favGrid = el('div',{class:'card', style:'margin-top:12px'},
        el('div',{class:'title'}, 'æ”¶è—è€å¸«'),
        el('div',{class:'grid cols-3'},
          ...(favs.length? favs.map(id=>{
            const t=DB.teachers.find(x=>x.id===id);
            return el('div',{class:'card'},
              el('div',{class:'row wrap'}, el('div',{class:'avatar'}, t.name[0]), el('div',{class:'title'}, t.name), el('div',{class:'spacer'})),
              el('div',{class:'muted'}, t.tags.join('ã€')),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, 'æŸ¥çœ‹'),
                el('button',{class:'btn small primary', onclick:()=>openSchedule(t.id)}, 'é ç´„'),
                el('button',{class:'btn small', onclick:()=>toggleFav(t.id)}, 'ç§»é™¤')
              )
            );
          }) : [el('div',{class:'muted'}, 'å°šæœªæ”¶è—è€å¸«ï¼Œå»æ¨è–¦é çœ‹çœ‹å§ï¼')])
        )
      );
      wrap.appendChild(form); wrap.appendChild(favGrid);
    };

    // Teacher dashboard (unchanged logic, light style)
    const renderTeacherDashboard = ()=>{
      showOnly('view-teacher-dashboard');
      const tid = DB.currentUser.id;
      const t = DB.teachers.find(x=>x.id===tid)||DB.teachers[1];
      const wrap = $("#view-teacher-dashboard"); wrap.innerHTML='';
      const av = DB.availability[tid]; const days = Object.keys(av).sort().slice(0,14);
      const editor = el('div',{class:'card'},
        el('div',{class:'row wrap'}, el('div',{class:'title'},'å¯ç”¨æ™‚æ®µè¨­å®šï¼ˆæœªä¾† 14 å¤©ï¼‰'), el('div',{class:'spacer'}),
          el('button',{class:'btn small', onclick:()=>{ days.forEach(d=> av[d]=[]); save(); renderTeacherDashboard(); }}, 'æ¸…ç©ºå…¨éƒ¨')
        ),
        ...days.map(d=>{
          const row = el('div',{class:'item'},
            el('div',{}, fmtDate(d)),
            el('div',{class:'chips'},
              ...['09:00','09:30','10:00','10:30','11:00','11:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30']
                .map(tm=>{
                  const on = av[d].includes(tm);
                  return el('button',{class:'btn small'+(on?' primary':''), onclick:()=>{ const i=av[d].indexOf(tm); if(i>=0) av[d].splice(i,1); else av[d].push(tm); av[d].sort(); save(); renderTeacherDashboard(); }}, tm);
                })
            )
          );
          return row;
        })
      );
      const gal = DB.gallery[tid]||[];
      const profileCard = el('div',{class:'card'},
        el('div',{class:'title'},'è€å¸« Profile'),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'å§“å'), el('input',{id:'t-name', value:t.name})),
          el('div',{}, el('label',{},'åœ°å€'), el('input',{id:'t-region', value:t.region})),
          el('div',{}, el('label',{},'å¹´è³‡'), el('input',{id:'t-exp', type:'number', value:t.exp})),
          el('div',{}, el('label',{},'æ“…é•·æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰'), el('input',{id:'t-tags', value:t.tags.join(',')})),
          el('div',{}, el('label',{},'è‡ªæˆ‘ä»‹ç´¹'), el('input',{id:'t-intro', value:t.intro}))
        ),
        el('div',{class:'row wrap', style:'margin-top:8px'},
          el('button',{class:'btn success', onclick:()=>{
            Object.assign(t,{
              name:$("#t-name").value, region:$("#t-region").value, exp:Number($("#t-exp").value)||t.exp,
              tags: $("#t-tags").value.split(',').map(s=>s.trim()).filter(Boolean),
              intro: $("#t-intro").value
            }); save(); toast('å·²å„²å­˜');
          }}, 'å„²å­˜')
        ),
        el('div',{class:'hr'}),
        el('div',{class:'row wrap'}, el('b',{},'ç›¸ç°¿'), el('div',{class:'spacer'}),
          el('input',{type:'file', multiple:true, accept:'image/*,video/*,audio/*', onchange:(e)=>{
            const files = Array.from(e.target.files||[]);
            files.forEach(f=> DB.gallery[tid].push({url:URL.createObjectURL(f), name:f.name, type:f.type}));
            save(); renderTeacherDashboard(); toast('å·²æ–°å¢åª’é«”');
          }})
        ),
        el('div',{class:'grid cols-3', style:'margin-top:8px'},
          ...(gal.length? gal.map(g=>{
            if(g.type.startsWith('image')) return el('img',{src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'});
            if(g.type.startsWith('video')) return el('video',{controls:true, src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'});
            if(g.type.startsWith('audio')) return el('audio',{controls:true, src:g.url, style:'width:100%'}); 
            return el('div',{class:'subtle'}, g.name);
          }) : [el('div',{class:'muted'},'å°šç„¡åª’é«”')])
        )
      );
      wrap.appendChild(el('div',{class:'grid cols-2'}, editor, profileCard));
    };

    // Admin
    const renderAdmin = ()=>{
      showOnly('view-admin');
      const wrap = $("#view-admin"); wrap.innerHTML='';
      const tabs = el('div',{class:'row wrap'},
        el('button',{class:'tab active', 'data-admin-tab':'materials'},'æ•™æç®¡ç†'),
        el('button',{class:'tab', 'data-admin-tab':'reviews'},'è©•åƒ¹å¯©æ ¸'),
        el('button',{class:'tab', 'data-admin-tab':'teachers'},'æ•™å¸«ç®¡ç†')
      );
      const body = el('div',{id:'admin-body', style:'margin-top:10px'});
      wrap.appendChild(tabs); wrap.appendChild(body);
      const switchTab = (key)=>{
        [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active', b.getAttribute('data-admin-tab')===key));
        body.innerHTML='';
        if(key==='materials'){
          $("#materials-actions").classList.remove('hidden');
          renderMaterials(); goto('materials'); return;
        }
        if(key==='reviews'){
          const pending = DB.reviews.filter(r=>r.status==='pending').sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt));
          const list = el('div',{class:'list'});
          if(!pending.length) list.appendChild(el('div',{class:'muted'},'ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è©•åƒ¹'));
          pending.forEach(r=>{
            const stu = Object.values(DB.users).find(u=>u.id===r.studentId);
            const tea = DB.teachers.find(t=>t.id===r.teacherId);
            list.appendChild(el('div',{class:'item'},
              el('div',{}, `â­ ${r.rating}ï¼5 Â· ${tea?.name}`, el('div',{class:'muted'}, r.text)),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small success', onclick:()=>{ r.status='approved'; save(); pushNotif(r.studentId,'è©•åƒ¹é€šé',`ä½ å° ${tea?.name} çš„è©•åƒ¹å·²å…¬é–‹`); renderAdmin(); }},'é€šé'),
                el('button',{class:'btn small danger', onclick:()=>{ r.status='rejected'; save(); pushNotif(r.studentId,'è©•åƒ¹æœªé€šé',`ä½ å° ${tea?.name} çš„è©•åƒ¹æœªé€šéå¯©æ ¸`); renderAdmin(); }},'é§å›')
              )
            ));
          });
          body.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'å¾…å¯©æ ¸è©•åƒ¹'), list));
        }
        if(key==='teachers'){
          const list = el('div',{class:'list'});
          DB.teachers.forEach(t=>{
            list.appendChild(el('div',{class:'item'},
              el('div',{}, t.name, el('div',{class:'muted'}, `ä¸Šæ¶ç‹€æ…‹ï¼š${t.published?'å·²ä¸Šæ¶':'ä¸‹æ¶'} Â· åœ°å€ï¼š${t.region} Â· å¹´è³‡ï¼š${t.exp}`)),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, 'æŸ¥çœ‹ Profile'),
                el('button',{class:'btn small '+(t.published?'warn':'success'), onclick:()=>{ t.published=!t.published; save(); toast((t.published?'å·²ä¸Šæ¶':'å·²ä¸‹æ¶')+' '+t.name); renderAdmin(); }}, t.published?'ä¸‹æ¶':'ä¸Šæ¶')
              )
            ));
          });
          body.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'æ•™å¸«æ¸…å–®'), list));
        }
      };
      tabs.addEventListener('click', e=>{
        const key = e.target.getAttribute('data-admin-tab');
        if(key) switchTab(key);
      });
      switchTab('materials');
    };

    // Admin: materials quick-add
    const bindMaterialsActions = ()=>{
      $("#materials-actions").addEventListener('click', e=>{
        const act = e.target.getAttribute('data-mt-action'); if(!act) return;
        const targetNode = findNode(currentMaterialId)||DB.materials;
        if(act==='add-folder'){
          const name = prompt('è³‡æ–™å¤¾åç¨±'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('fld'), name, type:'folder', children:[]});
        }
        if(act==='add-page'){
          const name = prompt('æ•™æé æ¨™é¡Œ'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('pg'), name, type:'page', html:`<h2>${name}</h2><p>è«‹åœ¨æ­¤æ’°å¯«æ•™æå…§å®¹ï¼ˆç¤ºæ„ï¼‰ã€‚</p>`});
        }
        if(act==='add-pdf'){
          const name = prompt('PDF åç¨±'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('pdf'), name, type:'pdf'});
        }
        save(); renderMaterials();
      });
    };

    // ------- Global render -------
    const render = ()=>{
      headerUI(); refreshNotifUI(); navTabs();
      const route = current();
      if(!DB.currentUser){ showOnly('view-login'); return; }
      if(route.startsWith('teachers')) renderTeachers();
      else if(route.startsWith('teacher-profile/')) renderTeacherProfile(route.split('/')[1]);
      else if(route.startsWith('materials')) renderMaterials();
      else if(route.startsWith('schedule/')) renderSchedule(route.split('/')[1]);
      else if(route.startsWith('bookings')) renderBookings();
      else if(route.startsWith('student')) renderStudent();
      else if(route.startsWith('teacher-dashboard')) renderTeacherDashboard();
      else if(route.startsWith('admin')) renderAdmin();
      else goto('bookings');
    };

    // ------- Events -------
    window.addEventListener('hashchange', render);
    $("#tabbar").addEventListener('click', e=>{
      const key = e.target.getAttribute('data-go'); if(!key) return;
      goto(key); render();
    });
    $("#login-submit").addEventListener('click', ()=> doLogin($("#login-username").value.trim(), $("#login-password").value.trim()));
    $("#loginBtn").addEventListener('click', ()=> goto('login'));
    $("#resetBtn").addEventListener('click', ()=>{
      if(confirm('é‡ç½® Demo æœƒæ¸…é™¤ç›®å‰ç€è¦½å™¨ä¸­çš„ç¤ºç¯„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')){
        localStorage.removeItem('TG_DEMO_L'); DB = seed(); save(); toast('å·²é‡ç½®'); goto('login'); render();
      }
    });
    document.body.addEventListener('click', e=>{
      const fill = e.target.getAttribute('data-demo-fill'); if(!fill) return;
      $("#login-username").value = fill; $("#login-password").value = fill;
    });
    $("#notifBtn").addEventListener('click', ()=>{
      const role = DB.currentUser?.role, uidC = DB.currentUser?.id;
      const list = DB.notifications.filter(n=> n.to===role || n.to===uidC || n.to==='all')
        .sort((a,b)=> new Date(b.ts)-new Date(a.ts));
      const box = el('div',{},
        el('div',{class:'row wrap'}, el('div',{class:'title'},'é€šçŸ¥ä¸­å¿ƒ'), el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal},'âœ–ï¸')),
        el('div',{class:'list'},
          ...(list.length? list.map(n=> el('div',{class:'item'},
            el('div',{}, n.title, el('div',{class:'muted'}, n.body)),
            el('div',{class:'row wrap'}, el('span',{class:'hint'}, new Date(n.ts).toLocaleString()))
          )) : [el('div',{class:'muted'},'ç›®å‰æ²’æœ‰é€šçŸ¥')])
        )
      );
      openModal(box);
      list.forEach(n=> n.read=true); save(); refreshNotifUI();
    });
    document.body.addEventListener('click', e=>{
      if(e.target && e.target.id==='logoutBtn') doLogout();
    });
    ["#filter-tag","#filter-region","#filter-sort","#globalSearch"].forEach(sel=>{
      const target = $(sel);
      if(!target) return;
      target.addEventListener('input', ()=> renderTeachers());
    });
    document.body.addEventListener('click', e=>{
      if(e.target && e.target.id==='anyScheduleBtn'){ goto('schedule/any'); render(); }
    });
    bindMaterialsActions();

    // Init
    if(!location.hash) goto('login');
    headerUI(); render();
  })();
  </script>
</body>
</html>