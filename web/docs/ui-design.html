<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>家教系統 Demo</title>
  <style>
    /* Light theme */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --muted:#6b7280; --text:#111827;
      --brand:#2563eb; --brand-2:#16a34a; --danger:#ef4444; --warn:#f59e0b;
      --ok:#10b981; --border:#e5e7eb; --chip:#f3f4f6; --chip-2:#eef2ff;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji",
      "Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:16px}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9);
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border); z-index:10;
    }
    .nav{display:flex; align-items:center; gap:12px; padding:10px 16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; color:#0b1420}
    .logo-badge{
      width:34px; height:34px; border-radius:8px; display:grid; place-items:center;
      color:#fff; background:linear-gradient(135deg,#22c55e,#16a34a); font-size:18px; font-weight:900;
      box-shadow:0 6px 16px rgba(34,197,94,.35), inset 0 0 10px rgba(255,255,255,.3);
    }
    .spacer{flex:1}
    .tabbar{display:flex; gap:6px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px; background:transparent; border:1px solid var(--border);
      color:#374151; cursor:pointer; transition:.2s; font-size:14px;
    }
    .tab.active{background:#e8f5ff; border-color:#cde6ff; color:#0b4ea2}
    .search{display:flex; align-items:center; gap:8px; background:#f9fafb; border:1px solid var(--border);
      padding:6px 10px; border-radius:12px; min-width:220px}
    .search input{flex:1; background:transparent; border:0; outline:none; color:#111827}
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#ffffff; color:#111827; cursor:pointer; transition:.15s;
      box-shadow:0 2px 0 rgba(0,0,0,0.02);
    }
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; border-color:transparent; font-weight:700}
    .btn.success{background:linear-gradient(135deg,#34d399,#10b981); color:#fff; border:0; font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#fde68a,#f59e0b); color:#3b2700; border:0; font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#fda4a4,#ef4444); color:#fff; border:0; font-weight:700}
    .btn.ghost{background:#f3f4f6}
    .btn.small{padding:6px 10px; border-radius:10px; font-size:13px}
    .btn.icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1e40af; border:1px solid #e0e7ff}
    .pill{padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--border); font-size:12px}
    .row{display:flex; gap:12px; align-items:center}
    .wrap{flex-wrap:wrap}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow);
    }
    .subtle{
      background:#f9fafb; border:1px dashed var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .title{font-size:18px; font-weight:800; margin:8px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:linear-gradient(90deg,transparent,#e5e7eb,transparent); margin:12px 0}
    /* Avatars */
    .avatar{
      width:54px; height:54px; border-radius:14px; background:linear-gradient(135deg,#e5f9f0,#d1fae5); border:1px solid var(--border);
      display:grid; place-items:center; font-weight:900; color:#065f46
    }
    .avatar.sm{width:36px; height:36px; border-radius:10px; font-size:14px}
    /* Layout */
    main{padding:10px}
    section[hidden]{display:none !important}
    /* Teacher cards */
    .teacher-card{display:flex; gap:12px}
    .teacher-card .actions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    /* Materials */
    .materials{display:grid; grid-template-columns:280px 1fr; gap:14px}
    .tree{background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:10px; max-height:60vh; overflow:auto}
    .tree ul{list-style:none; padding-left:12px; margin:0}
    .tree li{margin:6px 0}
    .tree .node{display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:8px; cursor:pointer}
    .tree .node.active{background:#eef2ff; border:1px solid #e0e7ff}
    .node .icon{width:22px; text-align:center}
    .content-pane{min-height:320px}
    .pdf{background:#f9fafb; border-radius:10px; padding:20px; border:1px solid var(--border)}
    /* Schedule */
    .date-strip{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .date-pill{min-width:110px; text-align:center; padding:8px; border-radius:12px; background:#f3f4f6; border:1px solid var(--border); cursor:pointer}
    .date-pill.active{background:#e0f2fe; border-color:#bae6fd}
    .slots{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
    .slot{padding:10px; border-radius:10px; border:1px solid var(--border); background:#ffffff; text-align:center; cursor:pointer}
    .slot.busy{opacity:.45; text-decoration:line-through; cursor:not-allowed}
    .slot.selected{outline:2px solid var(--brand)}
    /* Calendar */
    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{border:1px solid var(--border); background:#ffffff; min-height:80px; border-radius:10px; padding:6px; position:relative}
    .cal-cell .dot{position:absolute; right:8px; bottom:6px; width:8px; height:8px; border-radius:50%}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#6b7280; text-align:center}
    .dot-blue{background:#3b82f6} .dot-orange{background:#f59e0b} .dot-gray{background:#6b7280}
    /* Modal & Toast */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:grid; place-items:center; z-index:20}
    .modal{background:var(--surface); border:1px solid var(--border); border-radius:16px; width:min(560px,92vw); padding:18px; box-shadow:var(--shadow)}
    .toast{position:fixed; right:14px; bottom:14px; background:var(--surface); border:1px solid var(--border); padding:12px 14px; border-radius:12px; z-index:30; box-shadow:var(--shadow)}
    /* Forms */
    label{font-size:13px; color:#6b7280}
    input,select,textarea{
      width:100%; background:#ffffff; color:#111827;
      border:1px solid var(--border); border-radius:10px; padding:10px; outline:none
    }
    textarea{min-height:80px; resize:vertical}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid > div{display:flex; flex-direction:column; gap:6px}
    /* Lists & tables */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:10px; background:#ffffff}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th{font-size:12px; text-transform:uppercase; color:#6b7280; background:#f9fafb; border-bottom:1px solid var(--border)}
    th, td{padding:12px; text-align:left}
    tr{border-bottom:1px solid var(--border)}
    tr:hover td{background:#fafafa}
    .hidden{display:none !important}
    /* Responsive */
    @media (max-width: 900px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .materials{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .slots{grid-template-columns:1fr}
      .search{min-width:unset; width:100%}
      .tabbar{width:100%; overflow:auto}
      th:nth-child(3), td:nth-child(3){white-space:nowrap}
    }
    .hint{font-size:12px; color:#6b7280}
    .welcome{
      background:linear-gradient(90deg,#16a34a,#15803d); color:#fff; border-radius:16px; padding:18px; box-shadow:var(--shadow)
    }
    .status-chip{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-upcoming{background:#dbeafe; color:#1d4ed8}
    .status-completed{background:#e5e7eb; color:#374151}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">TG</div>家教系統 Demo</div>
      <div class="spacer"></div>
      <div id="searchBar" class="search hidden">
        <span>🔎</span>
        <input id="globalSearch" placeholder="搜尋老師、擅長領域、地區…" />
      </div>
      <div id="tabbar" class="tabbar"></div>
      <div class="spacer"></div>
      <button id="notifBtn" class="btn icon hidden" title="通知">🔔<span id="notifDot" class="badge hidden">0</span></button>
      <div id="userMenu" class="row">
        <button id="resetBtn" class="btn small ghost hidden">重置 Demo</button>
        <button id="loginBtn" class="btn primary">登入</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="view-login">
      <div class="grid cols-2">
        <div class="card">
          <div class="title">登入</div>
          <div class="muted">使用下方帳密體驗不同角色（admin / student / teacher）。</div>
          <div class="hr"></div>
          <div class="form-grid">
            <div><label>帳號</label><input id="login-username" placeholder="admin / student / teacher" /></div>
            <div><label>密碼</label><input id="login-password" type="password" placeholder="同帳號名稱" /></div>
          </div>
          <div class="row wrap" style="margin-top:10px">
            <button id="login-submit" class="btn success">登入</button>
            <span class="hint">初次開啟會自動建立示範資料。</span>
          </div>
          <div class="hr"></div>
          <div class="chips">
            <button class="btn small" data-demo-fill="admin">填入 admin/admin</button>
            <button class="btn small" data-demo-fill="student">填入 student/student</button>
            <button class="btn small" data-demo-fill="teacher">填入 teacher/teacher</button>
          </div>
        </div>
        <div class="card">
          <div class="title">本 Demo 特色</div>
          <ul>
            <li>推薦教師：卡片清單、收藏、查看 Profile、預約。</li>
            <li>教材：資料夾樹、教材頁/模擬 PDF、從教材帶入預約。</li>
            <li>預約課表：半小時切片、留言、行事曆 .ics。</li>
            <li>我的預約：先列表、後日曆；取消/改期、評價。</li>
            <li>老師端：可用時段設定、預約列表、相簿上傳。</li>
            <li>管理端：教材管理、教師上架、評價審核。</li>
            <li>通知中心：預約/審核等事件推播。</li>
          </ul>
          <div class="subtle">
            <b>提示：</b>所有資料僅存於瀏覽器 localStorage，點「重置 Demo」可回到出廠狀態。
          </div>
        </div>
      </div>
    </section>

    <!-- Teachers -->
    <section id="view-teachers" hidden>
      <div class="row wrap">
        <div class="title">推薦教師</div>
        <span class="pill" id="courseContext">預約課程：自由對話</span>
        <div class="spacer"></div>
        <div class="row wrap">
          <select id="filter-tag" class="pill">
            <option value="">全部領域</option>
            <option>兒童英語</option>
            <option>日常英語</option>
            <option>商務英語</option>
            <option>雅思</option>
          </select>
          <select id="filter-region" class="pill">
            <option value="">全部地區</option>
            <option>台北</option><option>台中</option><option>高雄</option>
          </select>
          <select id="filter-sort" class="pill">
            <option value="rating">排序：評分</option>
            <option value="exp">排序：年資</option>
            <option value="soonest">排序：最近可約</option>
          </select>
        </div>
      </div>
      <div class="grid cols-3" id="teachersGrid"></div>
      <div class="hr"></div>
      <div class="card">
        <div class="row wrap">
          <div class="title">自由對話（系統指派）</div>
          <span class="muted">不指定老師，由系統指派合適老師。</span>
          <div class="spacer"></div>
          <button id="anyScheduleBtn" class="btn">選擇時段</button>
        </div>
      </div>
    </section>

    <!-- Teacher Profile -->
    <section id="view-teacher-profile" hidden></section>

    <!-- Materials -->
    <section id="view-materials" hidden>
      <div class="row wrap">
        <div class="title">教材</div>
        <div class="spacer"></div>
        <div id="materials-actions" class="row wrap hidden">
          <button class="btn small" data-mt-action="add-folder">＋ 新增資料夾</button>
          <button class="btn small" data-mt-action="add-page">＋ 新增教材頁</button>
          <button class="btn small" data-mt-action="add-pdf">＋ 新增 PDF</button>
        </div>
      </div>
      <div class="materials">
        <div class="tree" id="materialsTree"></div>
        <div class="card content-pane" id="materialsContent"></div>
      </div>
    </section>

    <!-- Schedule -->
    <section id="view-schedule" hidden></section>

    <!-- Bookings -->
    <section id="view-bookings" hidden></section>

    <!-- Student Profile -->
    <section id="view-student" hidden></section>

    <!-- Teacher Dashboard -->
    <section id="view-teacher-dashboard" hidden></section>

    <!-- Admin -->
    <section id="view-admin" hidden></section>
  </main>

  <!-- Modal + Toast -->
  <div id="modalHost" class="modal-backdrop hidden"><div class="modal" id="modalBox"></div></div>
  <div id="toastHost" class="toast hidden"></div>

  <script>
  ;(() => {
    // ------- Utilities -------
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}, ...children) => {
      const node = document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{
        if(k==='class') node.className=v;
        else if(k==='html') node.innerHTML=v;
        else if(k.startsWith('on') && typeof v==='function') node.addEventListener(k.substring(2), v);
        else if(v!==undefined) node.setAttribute(k,v);
      });
      children.forEach(c=>{
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    };
    const fmtDate = d => new Date(d).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit', weekday:'short'});
    const fmtDateFull = d => new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const ymd = d => new Date(d).toISOString().substring(0,10);
    const addMin = (d, m)=> new Date(new Date(d).getTime()+m*60000);
    const rangeDays = (start, days)=> Array.from({length:days},(_,i)=> ymd(new Date(new Date(start).getTime()+i*86400000)));
    const uid = (p='id') => p + Math.random().toString(36).slice(2,9);
    const save = ()=> localStorage.setItem('TG_DEMO_L', JSON.stringify(DB));
    const load = ()=> JSON.parse(localStorage.getItem('TG_DEMO_L')||'null');
    const toast = (msg)=>{ const t=$("#toastHost"); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
    const openModal = (node)=>{ $("#modalBox").innerHTML=''; $("#modalBox").appendChild(node); $("#modalHost").classList.remove('hidden'); };
    const closeModal = ()=> $("#modalHost").classList.add('hidden');
    $("#modalHost").addEventListener('click', e=>{ if(e.target.id==='modalHost') closeModal(); });

    // ------- Seed demo data -------
    const seed = () => {
      const teachers = [
        {id:'t1', name:'Alice Wang', region:'台北', exp:5, tags:['兒童英語','日常英語'], langs:['中','英'], rating:4.8, price:800, intro:'親切活潑、善用遊戲化引導，專注兒童口說與自然發音。', published:true},
        {id:'t2', name:'Ben Chen', region:'高雄', exp:8, tags:['商務英語','雅思'], langs:['中','英'], rating:4.9, price:1200, intro:'十年企業內訓經驗，擅長簡報與會議英語；雅思口說指導。', published:true},
        {id:'t3', name:'Chloe Lin', region:'台中', exp:3, tags:['日常英語'], langs:['中','英','日'], rating:4.6, price:700, intro:'留學日本，善於會話情境練習與跨文化溝通。', published:true},
      ];
      const users = {
        admin:{username:'admin', password:'admin', role:'admin', id:'u-admin', name:'系統管理員'},
        student:{username:'student', password:'student', role:'student', id:'s1', name:'Student One', email:'student@example.com'},
        teacher:{username:'teacher', password:'teacher', role:'teacher', id:'t2', name:'Ben Chen'} // 綁定 t2
      };
      const materials = {
        id:'root', name:'全部教材', type:'folder', children:[
          {id:'free', name:'自由對話（無教材）', type:'folder', children:[]},
          {id:'kids', name:'兒童英語', type:'folder', children:[
            {id:'kids-p1', name:'動物與顏色（教材頁）', type:'page', html:'<h2>動物與顏色</h2><p>學習常見動物與顏色形容。</p>'},
            {id:'kids-pdf1', name:'字母練習（PDF）', type:'pdf'}
          ]},
          {id:'ielts', name:'雅思', type:'folder', children:[
            {id:'ielts-p1', name:'口說高分策略（教材頁）', type:'page', html:'<h2>口說策略</h2><p>答案結構、延伸技巧。</p>'}
          ]},
          {id:'daily', name:'日常英語', type:'folder', children:[
            {id:'daily-p1', name:'旅遊情境（教材頁）', type:'page', html:'<h2>旅遊情境</h2><p>機場、飯店、餐廳常用句。</p>'}
          ]},
          {id:'biz', name:'商務英語', type:'folder', children:[
            {id:'biz-p1', name:'Email 寫作（教材頁）', type:'page', html:'<h2>Email 寫作</h2><p>清楚主題、禮貌結語與行動呼籲。</p>'}
          ]}
        ]
      };
      // Availability: next 14 days half-hour slots
      const days = rangeDays(new Date(), 14);
      const genSlots = (morning=true, afternoon=true) => {
        const out=[]; const add=(hStart,hEnd)=>{ for(let h=hStart; h<hEnd; h++){ out.push(`${String(h).padStart(2,'0')}:00`); out.push(`${String(h).padStart(2,'0')}:30`);} };
        if(morning) add(9,12); if(afternoon) add(14,18); return out;
      };
      const availability = { t1:{}, t2:{}, t3:{} };
      days.forEach((d,i)=>{
        availability.t1[d]= genSlots(i%2===0, true);
        availability.t2[d]= genSlots(true, i%3!==0);
        availability.t3[d]= genSlots(i%2!==0, true);
      });
      // sample booking tomorrow
      const future1 = new Date(); future1.setDate(future1.getDate()+1); future1.setHours(17,0,0,0);
      const bk1 = {id:uid('bk'), studentId:'s1', teacherId:'t2', start:future1.toISOString(), duration:30, course:'自由對話', message:'想練習會議英文開場', status:'scheduled', meet:'https://example.local/meet/ABCDE'};
      const reviews = [];
      const favorites = { s1: ['t2'] };
      const gallery = { t1:[], t2:[], t3:[] };
      return { users, teachers, materials, availability, bookings:[bk1], reviews, favorites, gallery, notifications:[], courseContext:null, currentUser:null };
    };
    let DB = load() || seed(); save();

    // ------- Router/UI -------
    const ROUTES = ['login','teachers','teacher-profile','materials','schedule','bookings','student','teacher-dashboard','admin'];
    const goto = (hash)=>{ location.hash = '#/'+hash; };
    const current = ()=> (location.hash.replace('#/','')||'login');
    const navTabs = () => {
      const role = DB.currentUser?.role;
      const bar = $("#tabbar"); bar.innerHTML='';
      const addTab = (key, label, opts={})=>{
        const b = el('button',{class:'tab','data-go':key}, label);
        if(current().startsWith(key)) b.classList.add('active');
        if(opts.hide) b.classList.add('hidden');
        bar.appendChild(b);
      };
      addTab('teachers','推薦教師', {hide:!role});
      addTab('materials','教材', {hide:!role});
      addTab('bookings','我的預約', {hide:!role});
      if(role==='student') addTab('student','我的資料');
      if(role==='teacher') addTab('teacher-dashboard','老師後台');
      if(role==='admin') addTab('admin','管理後台');
    };
    const headerUI = ()=>{
      const logged = !!DB.currentUser;
      $("#loginBtn").classList.toggle('hidden', logged);
      $("#searchBar").classList.toggle('hidden', !logged);
      $("#notifBtn").classList.toggle('hidden', !logged);
      $("#resetBtn").classList.toggle('hidden', !logged);
      if(logged){
        $("#userMenu").querySelector('#loginBtn')?.classList.add('hidden');
        const menu = $("#userMenu");
        menu.querySelector('#logoutBtn')?.remove();
        menu.appendChild(el('button',{id:'logoutBtn',class:'btn'}, `登出（${DB.currentUser.name||DB.currentUser.username}）`));
      }
      navTabs();
    };
    const pushNotif = (toRoleOrUserId, title, body) => {
      DB.notifications.push({id:uid('nt'), to:toRoleOrUserId, title, body, read:false, ts:new Date().toISOString()});
      save(); refreshNotifUI();
    };
    const refreshNotifUI = () => {
      const role = DB.currentUser?.role, uidC = DB.currentUser?.id;
      const list = DB.notifications.filter(n => n.to===role || n.to===uidC || n.to==='all');
      const unread = list.filter(n=>!n.read).length;
      const dot = $("#notifDot");
      if(unread>0){ dot.textContent=unread; dot.classList.remove('hidden'); } else { dot.classList.add('hidden'); }
    };

    // ------- Auth -------
    const doLogin = (u,p)=>{
      const user = Object.values(DB.users).find(x=>x.username===u && x.password===p);
      if(!user) return toast('帳號或密碼錯誤');
      DB.currentUser = { ...user };
      save();
      headerUI();
      goto('bookings'); // 登入學生情境，直接導到我的預約
      render();
      toast(`歡迎，${DB.currentUser.name||DB.currentUser.username}`);
    };
    const doLogout = ()=>{
      DB.currentUser=null; save(); headerUI(); goto('login'); render();
    };

    // ------- Helpers -------
    const makeICS = (b)=>{
      const dt = new Date(b.start);
      const dtEnd = new Date(dt.getTime()+b.duration*60000);
      const toICS = (d)=> d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      const t = DB.teachers.find(x=>x.id===b.teacherId);
      const uidStr = `${b.id}@tg-demo.local`;
      const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//TG Demo//EN','CALSCALE:GREGORIAN',
        'BEGIN:VEVENT',
        'UID:'+uidStr,
        'DTSTAMP:'+toICS(new Date()),
        'DTSTART:'+toICS(dt),
        'DTEND:'+toICS(dtEnd),
        'SUMMARY:'+`與 ${t?.name||'老師'} 的英語課`,
        'DESCRIPTION:'+ (b.course||'自由對話') + '；加入連結：' + b.meet,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      return 'data:text/calendar;charset=utf-8,'+encodeURIComponent(ics);
    };

    // ------- Pages -------
    function showOnly(id){
      ['view-login','view-teachers','view-teacher-profile','view-materials','view-schedule','view-bookings','view-student','view-teacher-dashboard','view-admin']
      .forEach(v => $( '#'+v ).hidden = (v!==id));
    }

    // Teachers page
    const renderTeachers = ()=>{
      showOnly('view-teachers');
      $("#courseContext").textContent = '預約課程：' + (DB.courseContext?.name || '自由對話');
      const grid = $("#teachersGrid");
      const q = ($("#globalSearch").value||'').toLowerCase();
      const tag = $("#filter-tag").value||'';
      const region = $("#filter-region").value||'';
      const sort = $("#filter-sort").value||'rating';
      let items = DB.teachers.filter(t=>t.published);
      if(q) items = items.filter(t=> (t.name+t.region+t.tags.join('')).toLowerCase().includes(q));
      if(tag) items = items.filter(t=> t.tags.includes(tag));
      if(region) items = items.filter(t=> t.region===region);
      if(sort==='rating') items.sort((a,b)=> b.rating-a.rating);
      if(sort==='exp') items.sort((a,b)=> b.exp-a.exp);
      if(sort==='soonest'){
        const soon = id=>{
          const av = DB.availability[id]; const days = Object.keys(av).sort(); 
          for(const d of days){ const slots = av[d]; if(slots?.length) return new Date(`${d}T${slots[0]}:00`)-Date.now(); }
          return 1e15;
        };
        items.sort((a,b)=> soon(a.id)-soon(b.id));
      }
      grid.innerHTML='';
      items.forEach(t=>{
        const card = el('div',{class:'card teacher-card'},
          el('div',{class:'avatar',title:t.name}, t.name.split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase()),
          el('div',{}, 
            el('div',{class:'row wrap'},
              el('div',{class:'title'}, t.name),
              el('span',{class:'badge'}, `地區：${t.region}`),
              el('span',{class:'badge'}, `經驗：${t.exp} 年`),
              el('span',{class:'badge'}, `評分：${t.rating.toFixed(1)}`)
            ),
            el('div',{class:'tags'}, ...t.tags.map(tag=> el('span',{class:'pill'}, tag))),
            el('div',{class:'muted'}, t.intro),
            el('div',{class:'actions'},
              el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, '查看 Profile'),
              el('button',{class:'btn small primary', onclick:()=>openSchedule(t.id)}, '預約'),
              DB.currentUser?.role==='student'
                ? el('button',{class:'btn small', onclick:()=>toggleFav(t.id)}, isFav(t.id)?'★ 已收藏':'☆ 收藏')
                : null
            )
          )
        );
        grid.appendChild(card);
      });
    };
    const isFav = (tid)=> (DB.favorites[DB.currentUser?.id||'']||[]).includes(tid);
    const toggleFav = (tid)=>{
      if(!DB.currentUser || DB.currentUser.role!=='student') return toast('請以學生身分登入');
      const sid = DB.currentUser.id;
      DB.favorites[sid] ||= [];
      const i = DB.favorites[sid].indexOf(tid);
      if(i>=0) DB.favorites[sid].splice(i,1); else DB.favorites[sid].push(tid);
      save(); renderTeacherProfile(currentTeacherId||tid); renderTeachers();
      toast(i>=0?'已取消收藏':'已收藏');
    };

    // Teacher Profile
    let currentTeacherId=null;
    const openTeacherProfile = (id)=>{ currentTeacherId=id; goto('teacher-profile/'+id); render(); };
    const renderTeacherProfile = (id)=>{
      showOnly('view-teacher-profile');
      const t = DB.teachers.find(x=>x.id===id);
      const wrap = $("#view-teacher-profile"); wrap.innerHTML='';
      if(!t) return wrap.appendChild(el('div',{class:'card'},'找不到老師'));
      const me = DB.currentUser;
      const myFav = me?.role==='student' ? isFav(id) : null;

      // Availability preview
      const av = DB.availability[id]||{};
      const days = Object.keys(av).sort().slice(0,7);
      const preview = el('div',{class:'row wrap'},
        ...days.map(d => el('div',{class:'pill'}, fmtDate(d)+'：'+ (av[d].slice(0,3).join('、') || '—')))
      );

      // Gallery
      const gal = DB.gallery[id]||[];
      const galGrid = el('div',{class:'grid cols-3'}, ...(gal.length? gal.map(g=>{
        if(g.type.startsWith('image')) return el('img',{src:g.url, alt:g.name, style:'width:100%; border-radius:10px; border:1px solid var(--border)'}); 
        if(g.type.startsWith('video')) return el('video',{controls:true, src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'}); 
        if(g.type.startsWith('audio')) return el('audio',{controls:true, src:g.url, style:'width:100%'}); 
        return el('div',{class:'subtle'}, g.name);
      }) : [el('div',{class:'muted'},'尚無媒體')]));

      const uploadRow = (me?.role==='teacher' && me.id===id)
        ? el('div',{class:'row wrap'}, 
            el('input',{type:'file', multiple:true, accept:'image/*,video/*,audio/*', onchange:(e)=>{
              const files = Array.from(e.target.files||[]);
              files.forEach(f=>{
                const url = URL.createObjectURL(f);
                DB.gallery[id].push({url, name:f.name, type:f.type});
              });
              save(); renderTeacherProfile(id); toast('已新增到相簿（示意）');
            }}),
            el('span',{class:'hint'},'支援圖片/音訊/影片，僅示意用途。')
          )
        : null;

      // Reviews
      const allRv = DB.reviews.filter(r=>r.teacherId===id);
      const approved = allRv.filter(r=>r.status==='approved');
      const myRvs = allRv.filter(r=>r.studentId===me?.id);

      const rvList = approved.length ? approved.map(r=> el('div',{class:'item'},
        el('div',{}, `⭐ ${r.rating}／5`, el('div',{class:'muted'}, r.text)),
        el('div',{class:'muted'}, new Date(r.createdAt).toLocaleDateString())
      )) : [ el('div',{class:'muted'}, '尚無公開評價') ];

      const myRvList = myRvs.length ? myRvs.map(r=> el('div',{class:'item'},
        el('div',{}, `我給的評分：${r.rating}，${r.text}`),
        el('span',{class:'badge'}, r.status==='pending'?'審核中': r.status==='rejected'? '未通過' : '已公開')
      )) : null;

      wrap.appendChild(el('div',{class:'grid cols-3'},
        el('div',{class:'card'},
          el('div',{class:'row wrap'},
            el('div',{class:'avatar'}, t.name[0]),
            el('div',{},
              el('div',{class:'title'}, t.name),
              el('div',{class:'chips'},
                el('span',{class:'badge'}, `地區：${t.region}`),
                el('span',{class:'badge'}, `年資：${t.exp} 年`),
                el('span',{class:'badge'}, `評分：${t.rating.toFixed(1)}`)
              )
            ),
            el('div',{class:'spacer'}),
            el('div',{class:'row wrap'},
              el('button',{class:'btn primary small', onclick:()=>openSchedule(id)},'一鍵預約'),
              me?.role==='student' ? el('button',{class:'btn small', onclick:()=>toggleFav(id)}, myFav?'★ 已收藏':'☆ 收藏') : null
            )
          ),
          el('div',{class:'tags', style:'margin-top:6px'}, ...t.tags.map(x=> el('span',{class:'pill'},x))),
          el('div',{class:'hr'}),
          el('div',{}, el('b',{},'自我介紹'), el('div',{class:'muted'}, t.intro)),
          el('div',{class:'hr'}),
          el('div',{}, el('b',{},'可用時段（摘要）'), preview),
          el('div',{class:'hr'}),
          el('div',{}, el('button',{class:'btn small', onclick:()=>goto('teachers')},'返回推薦教師'))
        ),
        el('div',{class:'card', style:'grid-column: span 2'},
          el('div',{class:'row wrap'},
            el('div',{class:'title'}, '相簿 / 媒體'),
            el('div',{class:'spacer'}), uploadRow
          ),
          galGrid
        ),
        el('div',{class:'card', style:'grid-column: span 3'},
          el('div',{class:'row wrap'},
            el('div',{class:'title'}, '學員評價'),
            el('span',{class:'hint'}, '僅顯示管理員審核通過之內容')
          ),
          el('div',{class:'list'}, ...rvList),
          myRvList ? el('div',{}, el('div',{class:'hr'}), el('b',{},'我留下的評價'), el('div',{class:'list'}, ...myRvList)) : null
        )
      ));
    };

    // Materials page
    let currentMaterialId=null;
    const findNode = (id, node=DB.materials)=> {
      if(node.id===id) return node;
      if(node.children) for(const c of node.children){ const r=findNode(id,c); if(r) return r; }
      return null;
    };
    const renderMaterialsTree = (node=DB.materials, activeId=currentMaterialId)=>{
      const ul = el('ul');
      const rec = (n)=>{
        const li = el('li');
        const icon = n.type==='folder'?'📁':(n.type==='pdf'?'📄':'📘');
        const nodeEl = el('div',{class:'node'+(n.id===activeId?' active':''), onclick:()=>{currentMaterialId=n.id; renderMaterials();}}, el('span',{class:'icon'}, icon), el('span',{}, n.name));
        li.appendChild(nodeEl);
        if(n.children?.length){
          const sub = el('ul');
          n.children.forEach(ch=> sub.appendChild(rec(ch)));
          li.appendChild(sub);
        }
        return li;
      };
      ul.appendChild(rec(node));
      $("#materialsTree").innerHTML=''; $("#materialsTree").appendChild(ul);
    };
    const renderMaterialsContent = ()=>{
      const pane = $("#materialsContent"); pane.innerHTML='';
      const node = findNode(currentMaterialId)||DB.materials;
      pane.appendChild(el('div',{class:'title'}, node.name));
      if(node.type==='page'){
        const box = el('div',{class:'card', html: node.html||'<p>（教材頁內容）</p>'});
        pane.appendChild(box);
        pane.appendChild(el('div',{class:'row wrap'},
          el('button',{class:'btn primary', onclick:()=>{ DB.courseContext={id:node.id, name:node.name}; save(); goto('teachers'); render(); toast('已帶入教材至預約流程'); }}, '預約老師'),
          el('span',{class:'hint'}, '將帶入推薦教師頁，並於預約時自動填入教材')
        ));
      } else if(node.type==='pdf'){
        pane.appendChild(el('div',{class:'pdf'}, el('div',{class:'title'}, 'PDF 檔案預覽'), el('div',{class:'muted'}, '此為示意 PDF 區塊')));
        pane.appendChild(el('div',{class:'row wrap'}, el('button',{class:'btn primary', onclick:()=>{ DB.courseContext={id:node.id, name:node.name}; save(); goto('teachers'); render(); }}, '預約老師')));
      } else if(node.type==='folder'){
        pane.appendChild(el('div',{class:'muted'}, node.id==='free' ? '此資料夾沒有教材內容，可直接自由對話練習。' : '選擇左側子項目瀏覽內容。'));
        pane.appendChild(el('div',{class:'row wrap'}, el('button',{class:'btn', onclick:()=>{ DB.courseContext={id:node.id, name: node.name.includes('自由對話')?'自由對話':node.name}; save(); goto('teachers'); render(); }}, '預約老師')));
      }
      if(DB.currentUser?.role==='admin' && node.id!=='root'){
        pane.appendChild(el('div',{class:'hr'}));
        pane.appendChild(el('div',{class:'row wrap'},
          el('button',{class:'btn small warn', onclick:()=>{ const newName=prompt('更名為：', node.name); if(!newName) return; node.name=newName; save(); renderMaterials(); }}, '重新命名'),
          el('button',{class:'btn small danger', onclick:()=>{ if(confirm('刪除此節點？')){ deleteNode(node.id, DB.materials); save(); currentMaterialId='root'; renderMaterials(); }}}, '刪除節點')
        ));
      }
    };
    const deleteNode = (id, node)=>{
      if(!node.children) return false;
      const idx = node.children.findIndex(c=>c.id===id);
      if(idx>=0){ node.children.splice(idx,1); return true; }
      for(const c of node.children){ if(deleteNode(id,c)) return true; }
      return false;
    };
    const renderMaterials = ()=>{
      showOnly('view-materials');
      $("#materials-actions").classList.toggle('hidden', DB.currentUser?.role!=='admin');
      renderMaterialsTree(DB.materials, currentMaterialId||'root');
      renderMaterialsContent();
    };

    // Schedule page
    const openSchedule = (teacherId)=>{ goto('schedule/'+teacherId); render(); };
    const renderSchedule = (teacherId)=>{
      showOnly('view-schedule');
      const wrap = $("#view-schedule"); wrap.innerHTML='';
      if(teacherId==='any') return renderScheduleAny();
      const t = DB.teachers.find(x=>x.id===teacherId);
      const av = DB.availability[teacherId]||{};
      const days = Object.keys(av).sort().slice(0,10);
      let activeDay = days.find(d=> (av[d]||[]).length) || days[0];

      const head = el('div',{class:'card'},
        el('div',{class:'row wrap'},
          el('div',{class:'avatar'}, t.name[0]),
          el('div',{}, el('div',{class:'title'}, `預約：${t.name}`), el('div',{class:'muted'}, '以學生時區顯示')),
          el('div',{class:'spacer'}),
          el('button',{class:'btn', onclick:()=>openTeacherProfile(teacherId)}, '查看老師 Profile')
        ),
        el('div',{class:'hr'}),
        el('div',{class:'date-strip', id:'dateStrip'})
      );
      wrap.appendChild(head);

      const slotsBox = el('div',{class:'card'}, el('div',{class:'title'}, '選擇時段'), el('div',{id:'slots', class:'slots'}));
      wrap.appendChild(slotsBox);

      const redrawDates=()=>{
        const strip = $("#dateStrip"); strip.innerHTML='';
        days.forEach(d=>{
          const has = (av[d]||[]).length;
          strip.appendChild(el('div',{class:'date-pill'+(d===activeDay?' active':''), onclick:()=>{activeDay=d; redrawDates(); redrawSlots();}}, fmtDate(d), el('div',{class:'hint'}, has?`${has} 檔位`:'無可約')));
        });
      };
      const redrawSlots=()=>{
        const box = $("#slots"); box.innerHTML='';
        const daySlots = (av[activeDay]||[]);
        if(!daySlots.length){ box.appendChild(el('div',{class:'muted'},'此日無可預約時段')); return; }
        const busyStarts = DB.bookings.filter(b=>b.teacherId===teacherId && ymd(b.start)===activeDay && b.status==='scheduled').map(b=> new Date(b.start).toTimeString().substring(0,5));
        daySlots.forEach(ti=>{
          const isBusy = busyStarts.includes(ti);
          box.appendChild(el('div',{class:'slot'+(isBusy?' busy':''), onclick:()=>{ if(isBusy) return; confirmBooking(teacherId, activeDay, ti); }}, ti));
        });
      };
      redrawDates(); redrawSlots();
    };
    const renderScheduleAny = ()=>{
      showOnly('view-schedule');
      const wrap = $("#view-schedule"); wrap.innerHTML='';
      wrap.appendChild(el('div',{class:'card'},
        el('div',{class:'title'},'自由對話（系統指派）'),
        el('div',{class:'muted'},'最近 3 天可預約時段，選擇後系統自動指派老師。')
      ));
      const list = [];
      const days = rangeDays(new Date(), 3);
      days.forEach(d=>{
        DB.teachers.forEach(t=>{
          if(!t.published) return;
          const slots = (DB.availability[t.id]?.[d]||[]).slice(0,4);
          const busy = DB.bookings.filter(b=>b.teacherId===t.id && ymd(b.start)===d && b.status==='scheduled').map(b=> new Date(b.start).toTimeString().substring(0,5));
          slots.filter(s=>!busy.includes(s)).forEach(s=> list.push({teacherId:t.id, teacher:t.name, day:d, time:s}));
        });
      });
      list.sort((a,b)=> new Date(`${a.day}T${a.time}:00`) - new Date(`${b.day}T${b.time}:00`));
      const box = el('div',{class:'card'}, el('div',{class:'title'},'選擇時段'));
      const ul = el('div',{class:'list'});
      if(list.length===0) ul.appendChild(el('div',{class:'muted'},'目前無可約時段'));
      list.forEach(x=>{
        ul.appendChild(el('div',{class:'item'},
          el('div',{}, `${fmtDate(x.day)} ${x.time}`, el('div',{class:'muted'}, `老師：${x.teacher}`)),
          el('button',{class:'btn small primary', onclick:()=>confirmBooking(x.teacherId, x.day, x.time)}, '預約')
        ));
      });
      box.appendChild(ul); wrap.appendChild(box);
    };
    const confirmBooking = (teacherId, day, time, editingBookingId=null)=>{
      const t = DB.teachers.find(x=>x.id===teacherId);
      const startISO = new Date(`${day}T${time}:00`).toISOString();
      const panel = el('div',{},
        el('div',{class:'row wrap'},
          el('div',{class:'title'}, editingBookingId?'確認改期':'確認預約'),
          el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal},'✖️')
        ),
        el('div',{class:'muted'},`時間：${fmtDateFull(startISO)}（以學生時區顯示）`),
        el('div',{class:'muted'},`老師：${t?.name||'（系統指派）'}`),
        el('div',{class:'hr'}),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'課程/教材'), (()=>{
            const sel = el('select',{id:'courseSel'});
            const opt1 = el('option',{}, DB.courseContext?.name||'自由對話'); sel.appendChild(opt1);
            if(DB.courseContext?.name!=='自由對話') sel.appendChild(el('option',{}, '自由對話'));
            ['兒童英語','日常英語','商務英語','雅思'].forEach(n=> sel.appendChild(el('option',{}, n)));
            return sel;
          })()),
          el('div',{}, el('label',{},'時長（分鐘）'), (()=>{
            const sel = el('select',{id:'durSel'}); [30,60].forEach(n=> sel.appendChild(el('option',{value:n}, n))); return sel;
          })())
        ),
        el('div',{}, el('label',{},'留言給老師'), el('textarea',{id:'msgBox', placeholder:'想先讓老師了解什麼？（選填）'})),
        el('div',{class:'hr'}),
        el('div',{class:'row wrap'},
          el('button',{class:'btn success', onclick:()=>{
            if(!DB.currentUser || DB.currentUser.role!=='student'){ toast('請以學生身分登入'); closeModal(); return; }
            const studentId = DB.currentUser.id;
            const duration = Number($("#durSel").value)||30;
            const course = $("#courseSel").value || (DB.courseContext?.name||'自由對話');
            const message = $("#msgBox").value||'';
            if(editingBookingId){
              const bk = DB.bookings.find(b=>b.id===editingBookingId);
              if(!bk) return;
              bk.start=startISO; bk.duration=duration; bk.course=course; bk.message=message; save();
              pushNotif(bk.teacherId, '學生改期', `學生已將預約改到 ${fmtDateFull(startISO)}`);
              pushNotif(studentId, '改期成功', `已改到 ${fmtDateFull(startISO)}`);
              toast('改期成功'); closeModal(); goto('bookings'); render();
              return;
            }
            const booking = { id:uid('bk'), studentId, teacherId, start:startISO, duration, course, message, status:'scheduled', meet:'https://example.local/meet/'+uid('M').slice(-5) };
            DB.bookings.push(booking); save();
            pushNotif(teacherId, '有新的預約', `${DB.currentUser.name||'學生'} 預約了 ${fmtDateFull(startISO)} 的課程`);
            pushNotif(studentId, '預約成功', `與 ${t.name} 的課已確認：${fmtDateFull(startISO)}`);
            toast('預約成功！已加入「我的預約」');
            closeModal(); goto('bookings'); render();
          }}, editingBookingId?'確認改期':'確認預約'),
          el('span',{class:'hint'},'課前 2 小時內不可取消（示意政策）')
        )
      );
      openModal(panel);
    };

    // ------- Student Bookings (List first, then Calendar) -------
    const renderBookings = ()=>{
      showOnly('view-bookings');
      const role = DB.currentUser?.role;
      if(role==='teacher') return renderTeacherBookings();

      const wrap = $("#view-bookings"); wrap.innerHTML='';

      // Welcome banner
      wrap.appendChild(el('div',{class:'welcome'},
        el('h1',{style:'margin:0; font-size:20px; font-weight:800'}, `歡迎回來，${DB.currentUser.name||'學生'}！`),
        el('p',{style:'margin:6px 0 0; color:#e7ffe7'}, '準備好開始今天的學習之旅了嗎？')
      ));

      const sid = DB.currentUser.id;
      const my = DB.bookings.filter(b=>b.studentId===sid && b.status!=='cancelled');
      const upcoming = my.filter(b=> new Date(b.start)>=new Date() && b.status==='scheduled').sort((a,b)=> new Date(a.start)-new Date(b.start));
      const completed = my.filter(b=> b.status==='completed').sort((a,b)=> new Date(b.start)-new Date(a.start));

      // 1) List view: 當前預約
      const listCard = el('div',{class:'card', style:'margin-top:16px'},
        el('div',{class:'row wrap'},
          el('h2',{class:'title', style:'margin:0'}, '當前預約'),
          el('div',{class:'spacer'}),
          el('button',{class:'btn small ghost', onclick:()=>goto('teachers')}, '去預約更多')
        ),
        (()=>{
          if(upcoming.length===0) return el('div',{class:'muted', style:'padding:12px'}, '目前沒有即將到來的課程');
          const table = el('table');
          const thead = el('thead',{}, el('tr',{},
            el('th',{},'課程'), el('th',{},'老師'), el('th',{},'時間'), el('th',{},'狀態'), el('th',{},'操作')
          ));
          const tbody = el('tbody');
          upcoming.forEach(b=>{
            const t = DB.teachers.find(x=>x.id===b.teacherId);
            const tr = el('tr',{},
              el('td',{}, el('div',{style:'font-weight:600'}, b.course||'自由對話')),
              el('td',{}, el('div',{}, t?.name||'(未知老師)')),
              el('td',{}, el('div',{}, new Date(b.start).toLocaleString('zh-TW', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) )),
              el('td',{}, el('span',{class:'status-chip status-upcoming'}, '即將開始')),
              el('td',{},
                el('div',{class:'row wrap'},
                  el('a',{class:'btn small', href:makeICS(b), download:`booking-${b.id}.ics`}, '加入行事曆'),
                  el('button',{class:'btn small', onclick:()=>openSchedule(b.teacherId)}, '改期'),
                  el('button',{class:'btn small danger', onclick:()=>cancelBooking(b.id)}, '取消'),
                  el('a',{class:'btn small primary', href:b.meet, target:'_blank'}, '進入課程')
                )
              )
            );
            tbody.appendChild(tr);
          });
          table.appendChild(thead); table.appendChild(tbody);
          return el('div',{}, table);
        })()
      );
      wrap.appendChild(listCard);

      // 2) Calendar view: 本月課程
      const now = new Date(); const y = now.getFullYear(), m = now.getMonth();
      const firstDay = new Date(y,m,1), startIdx = firstDay.getDay(); // 0..6
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const eventsByDay = {};
      my.forEach(b=>{ const d= ymd(b.start); (eventsByDay[d] ||= []).push(b); });
      const calCard = el('div',{class:'grid cols-2', style:'margin-top:16px'},
        el('div',{class:'card', style:'grid-column: span 2'},
          el('div',{class:'row wrap'},
            el('h2',{class:'title', style:'margin:0'}, '本月課程日曆'),
            el('div',{class:'spacer'}), el('span',{class:'hint'}, `${y} 年 ${m+1} 月`)
          ),
          el('div',{class:'cal-head'}, ...['日','一','二','三','四','五','六'].map(x=> el('div',{},x))),
          (()=>{
            const grid = el('div',{class:'calendar'});
            for(let i=0;i<startIdx;i++) grid.appendChild(el('div',{class:'cal-cell', style:'background:#f9fafb'}));
            for(let d=1; d<=daysInMonth; d++){
              const dateStr = ymd(new Date(y,m,d));
              const has = eventsByDay[dateStr]?.length;
              const comps = (eventsByDay[dateStr]||[]).filter(b=>b.status==='completed').length;
              const upcomingCnt = (eventsByDay[dateStr]||[]).filter(b=>b.status==='scheduled').length;
              grid.appendChild(el('div',{class:'cal-cell'},
                String(d),
                has? el('div',{class:'dot '+(upcomingCnt?'dot-orange': comps?'dot-gray':'dot-blue')}) : null
              ));
            }
            return grid;
          })(),
          el('div',{class:'row wrap', style:'justify-content:center; gap:16px; margin-top:8px; color:#4b5563; font-size:12px'},
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#3b82f6'}), ' 今天'),
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#f59e0b'}), ' 已預約'),
            el('div',{class:'row wrap'}, el('div',{style:'width:12px; height:12px; border-radius:50%; background:#6b7280'}), ' 已完成')
          )
        )
      );
      wrap.appendChild(calCard);

      // 3) Completed list with review action (保留)
      if(completed.length){
        const rvCard = el('div',{class:'card', style:'margin-top:16px'},
          el('div',{class:'title'}, '已完成課程與評價'),
          el('div',{class:'list'}, ...completed.map(b=>{
            const t = DB.teachers.find(x=>x.id===b.teacherId);
            const existing = DB.reviews.find(r=>r.bookingId===b.id && r.studentId===sid);
            return el('div',{class:'item'},
              el('div',{}, `${fmtDateFull(b.start)} · ${t?.name}`, el('div',{class:'muted'}, b.course)),
              existing ? el('span',{class:'badge'}, '已提交評價（'+existing.status+'）')
              : el('button',{class:'btn small primary', onclick:()=>leaveReview(b)}, '留下評價')
            );
          }))
        );
        wrap.appendChild(rvCard);
      }

      // Demo 快速完成下一筆
      const nextBk = upcoming[0];
      if(nextBk){
        wrap.appendChild(el('div',{class:'subtle', style:'margin-top:14px'},
          el('div',{class:'row wrap'},
            el('div',{}, 'Demo 快速操作：'),
            el('button',{class:'btn small warn', onclick:()=>{ nextBk.status='completed'; save(); toast('已標記該課為「已完成」'); render(); }}, '標記下一堂課為已完成')
          ),
          el('div',{class:'hint'}, '僅為展示評價流程，實務上於課後自動變更狀態。')
        ));
      }
    };
    const cancelBooking = (id)=>{
      const bk = DB.bookings.find(b=>b.id===id);
      if(!bk) return;
      const diffH = (new Date(bk.start)-new Date())/3600000;
      if(diffH<2) { toast('課前 2 小時內不可取消'); return; }
      if(confirm('確認取消這筆預約？')){
        bk.status='cancelled'; save();
        pushNotif(bk.teacherId,'學生取消預約',`${DB.currentUser.name||'學生'} 取消了 ${fmtDateFull(bk.start)} 的課`);
        pushNotif(bk.studentId,'取消成功',`已取消與老師的課（${fmtDateFull(bk.start)}）`);
        render();
      }
    };
    const leaveReview = (booking)=>{
      const t = DB.teachers.find(x=>x.id===booking.teacherId);
      const box = el('div',{},
        el('div',{class:'row wrap'},
          el('div',{class:'title'}, '留下評價'),
          el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal}, '✖️')
        ),
        el('div',{class:'muted'}, `老師：${t.name} · 時間：${fmtDateFull(booking.start)}`),
        el('div',{class:'hr'}),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'評分（1-5）'), (()=>{
            const s=el('select',{id:'rvScore'}); [5,4,3,2,1].forEach(n=> s.appendChild(el('option',{value:n}, n))); return s;
          })()),
          el('div',{}, el('label',{},'心得（可選）'), el('input',{id:'rvText', placeholder:'這堂課對我最有幫助的是…'}))
        ),
        el('div',{class:'hr'}),
        el('button',{class:'btn success', onclick:()=>{
          const rv = { id:uid('rv'), bookingId:booking.id, studentId:booking.studentId, teacherId:booking.teacherId, rating:Number($("#rvScore").value), text:$("#rvText").value||'（未填）', status:'pending', createdAt:new Date().toISOString() };
          DB.reviews.push(rv); save(); closeModal();
          pushNotif('admin','有新的評價待審核',`學生對 ${t.name} 提交了評價`);
          toast('已提交，待管理員審核'); render();
        }}, '送出')
      );
      openModal(box);
    };

    // Teacher bookings (teacher view)
    const renderTeacherBookings = ()=>{
      const wrap = $("#view-bookings"); wrap.innerHTML='';
      const tid = DB.currentUser.id;
      const my = DB.bookings.filter(b=>b.teacherId===tid && b.status!=='cancelled').sort((a,b)=> new Date(a.start)-new Date(b.start));
      wrap.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'我的預約（老師端）'), el('div',{class:'hint'},'可在「可用時段設定」更新可預約檔位')));
      const list = el('div',{class:'list'});
      if(my.length===0) list.appendChild(el('div',{class:'muted'},'目前沒有預約'));
      my.forEach(b=>{
        const stu = Object.values(DB.users).find(u=>u.id===b.studentId);
        list.appendChild(el('div',{class:'item'},
          el('div',{}, `${fmtDateFull(b.start)} · 學生：${stu?.name||'（未知）'}`, el('div',{class:'muted'}, `${b.course} · 備註：${b.message||'—'}`)),
          el('div',{class:'row wrap'},
            el('button',{class:'btn small', onclick:()=>{ confirmBooking(b.teacherId, ymd(b.start), new Date(b.start).toTimeString().substring(0,5), b.id); }}, '提議改期'),
            el('button',{class:'btn small danger', onclick:()=>{ b.status='cancelled'; save(); pushNotif(b.studentId,'老師取消預約', `老師取消了 ${fmtDateFull(b.start)} 的課`); toast('已取消'); render(); }}, '取消')
          )
        ));
      });
      wrap.appendChild(el('div',{class:'card', style:'margin-top:12px'}, list));
    };

    // Student profile
    const renderStudent = ()=>{
      showOnly('view-student');
      const u = DB.users.student;
      const favs = DB.favorites[u.id]||[];
      const wrap = $("#view-student"); wrap.innerHTML='';
      const form = el('div',{class:'card'},
        el('div',{class:'title'}, '我的資料（學生）'),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'姓名'), el('input',{id:'st-name', value:u.name||''})),
          el('div',{}, el('label',{},'英文暱稱'), el('input',{id:'st-nick', value:u.nick||''})),
          el('div',{}, el('label',{},'生日'), el('input',{id:'st-bday', type:'date', value:u.bday||''})),
          el('div',{}, el('label',{},'Email'), el('input',{id:'st-email', value:u.email||''})),
          el('div',{}, el('label',{},'上課時段偏好'), (()=>{
            const s=el('select',{id:'st-pref-time'}); ['平日早上','平日下午','平日晚上','週末'].forEach(n=> s.appendChild(el('option',{selected:u.prefTime===n}, n))); return s;
          })()),
          el('div',{}, el('label',{},'課程類型偏好'), (()=>{
            const s=el('select',{id:'st-pref-type'}); ['自由對話','兒童英語','日常英語','商務英語','雅思'].forEach(n=> s.appendChild(el('option',{selected:u.prefType===n}, n))); return s;
          })())
        ),
        el('div',{class:'row wrap', style:'margin-top:10px'},
          el('button',{class:'btn success', onclick:()=>{
            Object.assign(u,{ name:$("#st-name").value, nick:$("#st-nick").value, bday:$("#st-bday").value, email:$("#st-email").value, prefTime:$("#st-pref-time").value, prefType:$("#st-pref-type").value });
            save(); toast('已儲存');
          }}, '儲存')
        )
      );
      const favGrid = el('div',{class:'card', style:'margin-top:12px'},
        el('div',{class:'title'}, '收藏老師'),
        el('div',{class:'grid cols-3'},
          ...(favs.length? favs.map(id=>{
            const t=DB.teachers.find(x=>x.id===id);
            return el('div',{class:'card'},
              el('div',{class:'row wrap'}, el('div',{class:'avatar'}, t.name[0]), el('div',{class:'title'}, t.name), el('div',{class:'spacer'})),
              el('div',{class:'muted'}, t.tags.join('、')),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, '查看'),
                el('button',{class:'btn small primary', onclick:()=>openSchedule(t.id)}, '預約'),
                el('button',{class:'btn small', onclick:()=>toggleFav(t.id)}, '移除')
              )
            );
          }) : [el('div',{class:'muted'}, '尚未收藏老師，去推薦頁看看吧！')])
        )
      );
      wrap.appendChild(form); wrap.appendChild(favGrid);
    };

    // Teacher dashboard (unchanged logic, light style)
    const renderTeacherDashboard = ()=>{
      showOnly('view-teacher-dashboard');
      const tid = DB.currentUser.id;
      const t = DB.teachers.find(x=>x.id===tid)||DB.teachers[1];
      const wrap = $("#view-teacher-dashboard"); wrap.innerHTML='';
      const av = DB.availability[tid]; const days = Object.keys(av).sort().slice(0,14);
      const editor = el('div',{class:'card'},
        el('div',{class:'row wrap'}, el('div',{class:'title'},'可用時段設定（未來 14 天）'), el('div',{class:'spacer'}),
          el('button',{class:'btn small', onclick:()=>{ days.forEach(d=> av[d]=[]); save(); renderTeacherDashboard(); }}, '清空全部')
        ),
        ...days.map(d=>{
          const row = el('div',{class:'item'},
            el('div',{}, fmtDate(d)),
            el('div',{class:'chips'},
              ...['09:00','09:30','10:00','10:30','11:00','11:30','14:00','14:30','15:00','15:30','16:00','16:30','17:00','17:30']
                .map(tm=>{
                  const on = av[d].includes(tm);
                  return el('button',{class:'btn small'+(on?' primary':''), onclick:()=>{ const i=av[d].indexOf(tm); if(i>=0) av[d].splice(i,1); else av[d].push(tm); av[d].sort(); save(); renderTeacherDashboard(); }}, tm);
                })
            )
          );
          return row;
        })
      );
      const gal = DB.gallery[tid]||[];
      const profileCard = el('div',{class:'card'},
        el('div',{class:'title'},'老師 Profile'),
        el('div',{class:'form-grid'},
          el('div',{}, el('label',{},'姓名'), el('input',{id:'t-name', value:t.name})),
          el('div',{}, el('label',{},'地區'), el('input',{id:'t-region', value:t.region})),
          el('div',{}, el('label',{},'年資'), el('input',{id:'t-exp', type:'number', value:t.exp})),
          el('div',{}, el('label',{},'擅長標籤（以逗號分隔）'), el('input',{id:'t-tags', value:t.tags.join(',')})),
          el('div',{}, el('label',{},'自我介紹'), el('input',{id:'t-intro', value:t.intro}))
        ),
        el('div',{class:'row wrap', style:'margin-top:8px'},
          el('button',{class:'btn success', onclick:()=>{
            Object.assign(t,{
              name:$("#t-name").value, region:$("#t-region").value, exp:Number($("#t-exp").value)||t.exp,
              tags: $("#t-tags").value.split(',').map(s=>s.trim()).filter(Boolean),
              intro: $("#t-intro").value
            }); save(); toast('已儲存');
          }}, '儲存')
        ),
        el('div',{class:'hr'}),
        el('div',{class:'row wrap'}, el('b',{},'相簿'), el('div',{class:'spacer'}),
          el('input',{type:'file', multiple:true, accept:'image/*,video/*,audio/*', onchange:(e)=>{
            const files = Array.from(e.target.files||[]);
            files.forEach(f=> DB.gallery[tid].push({url:URL.createObjectURL(f), name:f.name, type:f.type}));
            save(); renderTeacherDashboard(); toast('已新增媒體');
          }})
        ),
        el('div',{class:'grid cols-3', style:'margin-top:8px'},
          ...(gal.length? gal.map(g=>{
            if(g.type.startsWith('image')) return el('img',{src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'});
            if(g.type.startsWith('video')) return el('video',{controls:true, src:g.url, style:'width:100%; border-radius:10px; border:1px solid var(--border)'});
            if(g.type.startsWith('audio')) return el('audio',{controls:true, src:g.url, style:'width:100%'}); 
            return el('div',{class:'subtle'}, g.name);
          }) : [el('div',{class:'muted'},'尚無媒體')])
        )
      );
      wrap.appendChild(el('div',{class:'grid cols-2'}, editor, profileCard));
    };

    // Admin
    const renderAdmin = ()=>{
      showOnly('view-admin');
      const wrap = $("#view-admin"); wrap.innerHTML='';
      const tabs = el('div',{class:'row wrap'},
        el('button',{class:'tab active', 'data-admin-tab':'materials'},'教材管理'),
        el('button',{class:'tab', 'data-admin-tab':'reviews'},'評價審核'),
        el('button',{class:'tab', 'data-admin-tab':'teachers'},'教師管理')
      );
      const body = el('div',{id:'admin-body', style:'margin-top:10px'});
      wrap.appendChild(tabs); wrap.appendChild(body);
      const switchTab = (key)=>{
        [...tabs.querySelectorAll('.tab')].forEach(b=>b.classList.toggle('active', b.getAttribute('data-admin-tab')===key));
        body.innerHTML='';
        if(key==='materials'){
          $("#materials-actions").classList.remove('hidden');
          renderMaterials(); goto('materials'); return;
        }
        if(key==='reviews'){
          const pending = DB.reviews.filter(r=>r.status==='pending').sort((a,b)=> new Date(a.createdAt)-new Date(b.createdAt));
          const list = el('div',{class:'list'});
          if(!pending.length) list.appendChild(el('div',{class:'muted'},'目前沒有待審核的評價'));
          pending.forEach(r=>{
            const stu = Object.values(DB.users).find(u=>u.id===r.studentId);
            const tea = DB.teachers.find(t=>t.id===r.teacherId);
            list.appendChild(el('div',{class:'item'},
              el('div',{}, `⭐ ${r.rating}／5 · ${tea?.name}`, el('div',{class:'muted'}, r.text)),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small success', onclick:()=>{ r.status='approved'; save(); pushNotif(r.studentId,'評價通過',`你對 ${tea?.name} 的評價已公開`); renderAdmin(); }},'通過'),
                el('button',{class:'btn small danger', onclick:()=>{ r.status='rejected'; save(); pushNotif(r.studentId,'評價未通過',`你對 ${tea?.name} 的評價未通過審核`); renderAdmin(); }},'駁回')
              )
            ));
          });
          body.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'待審核評價'), list));
        }
        if(key==='teachers'){
          const list = el('div',{class:'list'});
          DB.teachers.forEach(t=>{
            list.appendChild(el('div',{class:'item'},
              el('div',{}, t.name, el('div',{class:'muted'}, `上架狀態：${t.published?'已上架':'下架'} · 地區：${t.region} · 年資：${t.exp}`)),
              el('div',{class:'row wrap'},
                el('button',{class:'btn small', onclick:()=>openTeacherProfile(t.id)}, '查看 Profile'),
                el('button',{class:'btn small '+(t.published?'warn':'success'), onclick:()=>{ t.published=!t.published; save(); toast((t.published?'已上架':'已下架')+' '+t.name); renderAdmin(); }}, t.published?'下架':'上架')
              )
            ));
          });
          body.appendChild(el('div',{class:'card'}, el('div',{class:'title'},'教師清單'), list));
        }
      };
      tabs.addEventListener('click', e=>{
        const key = e.target.getAttribute('data-admin-tab');
        if(key) switchTab(key);
      });
      switchTab('materials');
    };

    // Admin: materials quick-add
    const bindMaterialsActions = ()=>{
      $("#materials-actions").addEventListener('click', e=>{
        const act = e.target.getAttribute('data-mt-action'); if(!act) return;
        const targetNode = findNode(currentMaterialId)||DB.materials;
        if(act==='add-folder'){
          const name = prompt('資料夾名稱'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('fld'), name, type:'folder', children:[]});
        }
        if(act==='add-page'){
          const name = prompt('教材頁標題'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('pg'), name, type:'page', html:`<h2>${name}</h2><p>請在此撰寫教材內容（示意）。</p>`});
        }
        if(act==='add-pdf'){
          const name = prompt('PDF 名稱'); if(!name) return;
          targetNode.children ||= []; targetNode.children.push({id:uid('pdf'), name, type:'pdf'});
        }
        save(); renderMaterials();
      });
    };

    // ------- Global render -------
    const render = ()=>{
      headerUI(); refreshNotifUI(); navTabs();
      const route = current();
      if(!DB.currentUser){ showOnly('view-login'); return; }
      if(route.startsWith('teachers')) renderTeachers();
      else if(route.startsWith('teacher-profile/')) renderTeacherProfile(route.split('/')[1]);
      else if(route.startsWith('materials')) renderMaterials();
      else if(route.startsWith('schedule/')) renderSchedule(route.split('/')[1]);
      else if(route.startsWith('bookings')) renderBookings();
      else if(route.startsWith('student')) renderStudent();
      else if(route.startsWith('teacher-dashboard')) renderTeacherDashboard();
      else if(route.startsWith('admin')) renderAdmin();
      else goto('bookings');
    };

    // ------- Events -------
    window.addEventListener('hashchange', render);
    $("#tabbar").addEventListener('click', e=>{
      const key = e.target.getAttribute('data-go'); if(!key) return;
      goto(key); render();
    });
    $("#login-submit").addEventListener('click', ()=> doLogin($("#login-username").value.trim(), $("#login-password").value.trim()));
    $("#loginBtn").addEventListener('click', ()=> goto('login'));
    $("#resetBtn").addEventListener('click', ()=>{
      if(confirm('重置 Demo 會清除目前瀏覽器中的示範資料，確定嗎？')){
        localStorage.removeItem('TG_DEMO_L'); DB = seed(); save(); toast('已重置'); goto('login'); render();
      }
    });
    document.body.addEventListener('click', e=>{
      const fill = e.target.getAttribute('data-demo-fill'); if(!fill) return;
      $("#login-username").value = fill; $("#login-password").value = fill;
    });
    $("#notifBtn").addEventListener('click', ()=>{
      const role = DB.currentUser?.role, uidC = DB.currentUser?.id;
      const list = DB.notifications.filter(n=> n.to===role || n.to===uidC || n.to==='all')
        .sort((a,b)=> new Date(b.ts)-new Date(a.ts));
      const box = el('div',{},
        el('div',{class:'row wrap'}, el('div',{class:'title'},'通知中心'), el('div',{class:'spacer'}), el('button',{class:'btn icon', onclick:closeModal},'✖️')),
        el('div',{class:'list'},
          ...(list.length? list.map(n=> el('div',{class:'item'},
            el('div',{}, n.title, el('div',{class:'muted'}, n.body)),
            el('div',{class:'row wrap'}, el('span',{class:'hint'}, new Date(n.ts).toLocaleString()))
          )) : [el('div',{class:'muted'},'目前沒有通知')])
        )
      );
      openModal(box);
      list.forEach(n=> n.read=true); save(); refreshNotifUI();
    });
    document.body.addEventListener('click', e=>{
      if(e.target && e.target.id==='logoutBtn') doLogout();
    });
    ["#filter-tag","#filter-region","#filter-sort","#globalSearch"].forEach(sel=>{
      const target = $(sel);
      if(!target) return;
      target.addEventListener('input', ()=> renderTeachers());
    });
    document.body.addEventListener('click', e=>{
      if(e.target && e.target.id==='anyScheduleBtn'){ goto('schedule/any'); render(); }
    });
    bindMaterialsActions();

    // Init
    if(!location.hash) goto('login');
    headerUI(); render();
  })();
  </script>
</body>
</html>