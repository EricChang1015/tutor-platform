<!DOCTYPE html>
<html>
<head>
    <title>測試瀏覽器上傳</title>
</head>
<body>
    <h1>測試瀏覽器上傳功能</h1>
    <button onclick="testLogin()">1. 測試登入</button>
    <button onclick="testUpload()">2. 測試上傳</button>
    <div id="result"></div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let accessToken = null;
        let currentUser = null;

        function log(message) {
            const result = document.getElementById('result');
            result.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        // API 請求函數 (與demo.html相同的邏輯)
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const headers = {
                ...options.headers
            };

            // 只有在body不是FormData時才設置Content-Type
            if (!(options.body instanceof FormData) && !headers['Content-Type']) {
                headers['Content-Type'] = 'application/json';
            }

            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }

            log(`請求: ${options.method || 'GET'} ${url}`);
            log(`Headers: ${JSON.stringify(headers)}`);
            log(`Body類型: ${options.body ? options.body.constructor.name : 'undefined'}`);

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                log(`響應狀態: ${response.status}`);

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const result = await response.json();
                log(`響應成功: ${JSON.stringify(result, null, 2)}`);
                return result;
            } catch (error) {
                log(`請求失敗: ${error.message}`);
                throw error;
            }
        }

        async function testLogin() {
            log('=== 開始測試登入 ===');
            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: 'teacher1@example.com',
                        password: 'password'
                    })
                });

                accessToken = response.accessToken;
                currentUser = response.user;
                log('✅ 登入成功!');
            } catch (error) {
                log('❌ 登入失敗: ' + error.message);
            }
        }

        async function testUpload() {
            if (!accessToken) {
                log('❌ 請先登入!');
                return;
            }

            log('=== 開始測試上傳 ===');
            try {
                // 創建一個小的測試圖片 (1x1 PNG)
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 1, 1);

                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('file', blob, `avatar-${currentUser.id}.jpg`);

                    log(`FormData檢測: ${formData instanceof FormData}`);

                    const response = await apiRequest(`/users/${currentUser.id}/avatar`, {
                        method: 'POST',
                        body: formData,
                        headers: {} // 讓瀏覽器自動設定 Content-Type
                    });

                    log('✅ 上傳成功!');
                }, 'image/jpeg', 0.9);

            } catch (error) {
                log('❌ 上傳失敗: ' + error.message);
            }
        }
    </script>
</body>
</html>
